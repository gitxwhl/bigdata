define(["entityContainer","JSONUtil","PrintUtil","Validator","CheckUtil","ExcelUtil","PinyinUtil"],function(C,u,D,E,F,n,v){function p(p){function w(a,b){if(cube.isArray(a)&&!cube.isEmpty(b))if(b.columns!=void 0&&cube.isArray(b.columns))for(var d=0;d<b.columns.length;d++)w(a,b.columns[d]);else a.push(b.name)}function G(c){if(cube.notEmpty(a.url())&&cube.notEmpty(a._columns)&&a._columns.length==0)a.isAllowAppend()&&x(c.columns),a.columns(c.columns),a._columns=a.columns(),q(a._columns,null,0,0);r(c);
if(a.searchBoxId()){var b=cube.getPageViewModelByNode($("#"+a.searchBoxId()));b&&c.dicts&&c.dicts.length>0&&b.setDicts(c.dicts)}a.dicts(c.dicts);a._dictsKeyValue(c.dictsKeyValue);cube.notEmpty(c.items)&&!(c.items.length==1&&c.items[0]==null)?a.items(c.items):a.items([]);a.itemCount(c.itemCount);a._pageCount(parseInt((c.itemCount+parseInt(a.pageSize())-1)/parseInt(a.pageSize())));c=a.selectedIds();c.length>0&&a._selectedIds(c);a.isShowLoading(!1);c=(new Date).getTime()-_startLoadTime;a.loadTime(c>
1E3?c/1E3+"s":c+"ms");if(a.onLoaded!=null&&!cube.isObservable(a.onLoaded))a.onLoaded(a.items())}function H(c){a.isShowLoading(!1);if(a.onLoadError!=null&&!cube.isObservable(a.onLoadError))a.onLoadError(c)}function r(c){var b=a._showItemColumns();b&&b.length>0&&$.each(b,function(a,b){if(cube.isEmpty(b))return!0;if(typeof b.validStatus=="undefined")b.validStatus=cube.obj("");else if(!cube.isObservable(b.validStatus))b.validStatus=cube.obj(b.validStatus);if(typeof b.validHint=="undefined")b.validHint=
cube.obj("");else if(!cube.isObservable(b.validHint))b.validHint=cube.obj(b.validHint);if(typeof b.align=="undefined")b.align="";if(!b.editorType)b.editorType="TextEditor";if(b.editorType=="DropDownEditor"||b.editorType=="CheckListEditor"||b.editorType=="ListEditor")c.dicts&&c.dicts[b.name]&&b.list(c.dicts[b.name]);else if(b.editorType=="FileEditor")if(b.pkVal){if(!cube.isObservable(p_field.pkVal))b.pkVal=cube.obj(p_field.pkVal)}else b.pkVal=cube.obj(null)})}function x(c){a.appendColumns=cube.clone(c);
var b={},d={};$.each(a.appendColumns,function(){typeof this.value!="undefined"?cube.isObservable(this.value)?(b[this.name]=this.value,d[this.name]=this.value()):(b[this.name]=cube.obj(this.value),d[this.name]=this.value):(b[this.name]=cube.obj(null),d[this.name]=null);if(!this.editorType)this.editorType="TextEditor";this.validStatus=cube.obj("");this.validHint=cube.obj("")});a._appendedItem=b;a._appendedItemObj=d}function q(c,b,d,f){d++;for(var e=f=0;e<c.length;e++){c[e].validStatus=cube.obj("");
c[e].validHint=cube.obj("");if(c[e].editorType=="DropDownEditor"||c[e].editorType=="CheckListEditor"||c[e].editorType=="ListEditor"||c[e].editorType=="LabelEditor")if(typeof c[e].list=="undefined")c[e].list=cube.array([]);else if(!cube.isObservable(c[e].list))c[e].list=cube.array(c[e].list);if(c[e].columns&&c[e].columns.length>0){var h=$.extend({},c[e]);y(h,d,0);f=q(c[e].columns,h,d,f);b!=null&&(b.colspan+=f)}else h=$.extend({},c[e]),y(h,d,1),a._showItemColumns.push(h),h=c[e].visible,cube.isObservable(h)&&
(h=h()),b!=null&&(c[e].name==a.primaryKey()&&a.isShowPrimaryKey()||c[e].name!=a.primaryKey()&&h!==!1)&&b.colspan++,c[e]!=null&&(c[e].name==a.primaryKey()&&a.isShowPrimaryKey()||c[e].name!=a.primaryKey()&&h!==!1)&&f++}return b?b.colspan:f}function y(c,b,d){delete c.columns;c.colspan=d;a._levelColumns().length>=b?(l=a._levelColumns()[b-1],typeof l=="undefined"&&(l=[],a._levelColumns()[b-1]=l)):(l=[],a._levelColumns()[b-1]=l);l.push(c)}function m(c){var b=null,d=null;c==1?(b=a._editedItem,d=a._showItemColumns()):
c==0?(b=a._appendedItem,d=a.appendColumns):d=a._showItemColumns();for(c=0;c<d.length;c++)if(d[c].validStatus&&typeof d[c].validStatus=="function"&&d[c].validStatus()!="")return!1;else if(b!=null)for(var f in b)if(d[c].name==f&&d[c].nullable==!1){var e=E.validate(b[f](),"NOTNULL",{});if(e.successful)d[c].validStatus(""),d[c].validHint("");else return d[c].validStatus("error"),d[c].validHint(e.hint),!1;break}return!0}function o(a,b){if(a==null)return"";if(typeof b=="undefined")return a+"";if(typeof b==
"number")return a+"";var d=a+"";if(b!=null&&b!=""){var d=d.split("."),f=b.split(".");d[0].length<f[0].length&&(d[0]=f[0].substring(0,f[0].length-d[0].length)+d[0]);if(f.length==1)return d[0];else{if(d.length>1)for(;d[1].length<f[1].length;)d[1]+="0";else d[1]=f[1];return(new Number(d[0]+"."+d[1])).toFixed(f[1].length)}}else return d}var a=this,i=new C;a.style="";a.height="auto";a.operationsColumnWidth="40px";a.operationsColumnAlign="left";a.items=[];a.columns=[];a.customOperations=[];a.columnDefaultWidth=
"auto";a.tableLayout="auto";a.trBackground=null;a.checkboxHideCondition=null;a._columns=[];a._levelColumns=[];a._showItemColumns=[];a.appendColumns=null;a.url="";a.actions={};a.customHeaders=null;a.loadByPost=!1;a.timeout=null;a.pageSize=20;a.pageIndex=1;a.itemCount=0;a.isShowBtnText=!1;a.firstIcon="";a.previousIcon="";a.nextIcon="";a.endIcon="";a.isShowLoadTime=!1;a.loadTimeFadeout=0;a.pageInfoToLeft=!1;a.pageVisibleCount=5;a.blurGoto=!1;a._pageCount=0;a.primaryKey="id";a.loadMeta=!0;a.selectedIds=
[];a._selectedIds=[];a._selectedItems=[];a._selectedAll=!1;a._selectedItem=null;a._editedItem=null;a._editedItemObj=null;a._editedItemIndex=null;a._appendedItem={};a._appendedItemObj={};a._isEdited=!1;a.isShowPrimaryKey=!1;a.isShowRowNumber=!0;a.rowNumberColumnName=null;a.isRowNumberSerial=!1;a.isShowCheckBox=!1;a.isRadio=!1;a.isShowBorder=!0;a.isShowStripe=!1;a.isShowHover=!1;a.isShowCondense=!1;a.isAllowOperations=!1;a.isShowSave=!0;a.isShowAdd=!0;a.isAllowEdit=!1;a.isAllowDelete=!1;a.isAllowShift=
!1;a.isAllowAppend=!1;a.isAllowSort=!0;a.isAllowPaging=!0;a.isAllowAutowrap=!1;a.args=null;a.searchBoxId=null;a.autoLoad=!0;a.autoSave=!0;a.autoDelete=!0;a.refreshDeleted=!0;a.dicts=null;a.watermarkOptions=null;a._watermarkOptionsDefaultValue={text:"",x:40,y:40,xSpace:150,ySpace:60,color:"#278874",alpha:0.2,fontSize:"16px",width:100,height:20,rotate:25};a.watermarkRows=[];a.watermarkCols=[];a.scriptProcessing="escape";a.isShowLoading=!1;a._indexNotLoad=!1;a._dictsKeyValue=null;a.showCellPopDialog=
cube.obj(!1);a.loadTime=0;a.onSelectedItem=null;a.onSelectedIds=null;a.onSelectedItems=null;a.loadCompleted=!1;a.onDblClick=null;a.onItemSaving=null;a.onItemSaved=null;a.onItemEditing=null;a.onItemDeleting=null;a.onItemDeleted=null;a.onLoaded=null;a.onLoadError=null;a.onRendered=null;a._init=function(){a._columns=a.columns();q(a._columns,null,0,0);a.pageSizeSub=cube.subscribe(a.pageSize,a.load);a.argsSub=cube.subscribe(a.args,function(){a.load()});a._selectedIdsSub=cube.subscribe(a._selectedIds,a.chkboxClick);
a._selectedAllSub=cube.subscribe(a._selectedAll,a.chkboxAllClick);a.selectedIdsSub=cube.subscribe(a.selectedIds,function(b){a._selectedIds(b)});a.actionsSub=cube.subscribe(a.actions,function(a){i.actions=a});a.dictsSub=cube.subscribe(a.dicts,function(c){if(cube.isArray(c)&&c.length>0&&(a._dictsKeyValue()!=null||a.autoLoad()==!1))i._parseDicts({dicts:c}),a._dictsKeyValue(i.dictsKeyValue),r({dicts:c})});i.primaryKey=a.primaryKey();i.baseUrl=a.url();i.actions=a.actions();i.type="grid";i.timeout=a.timeout();
i.loadMeta=a.loadMeta();i.data=a.items();i.onload=G;i.onerror=H;i.customHeaders=a.customHeaders();i.loadByPost=a.loadByPost();i.init();if(a.autoLoad()){var c=cube.getPageViewModelByNode($("#"+a.searchBoxId()));c&&!c._isload()&&(cube.notEmpty(c.url())||c._lazyload())?cube.subscribe(c._isload,function(){a.load()}):a.load()}else r();a.isAllowAppend()&&x(a._showItemColumns())};a.setActions=function(c){a.actions=c};a.chkboxClick=function(c){for(var b=a.items(),d=a.primaryKey(),f=0,e=b.length;f<e;f++){if(typeof b[f][d]==
"undefined"){cube.indicate("warning",cube.msg("SET_PRIMARYKEY"));break}a.isRadio()&&cube.notEmpty(c)&&c==String(b[f][d])?a._selectedItems.indexOf(b[f])==-1&&a._selectedItems.push(b[f]):cube.notEmpty(c)&&cube.isArray(c)&&c.indexOf(String(b[f][d]))!=-1?a._selectedItems.indexOf(b[f])==-1&&a._selectedItems.push(b[f]):a._selectedItems.remove(b[f])}if(b.length>0){a._selectedAllSub.dispose();a._selectedItems().length==b.length?a._selectedAll(!0):a._selectedAll(!1);a._selectedAllSub=cube.subscribe(a._selectedAll,
a.chkboxAllClick);if(a.onSelectedItems!=null&&!cube.isObservable(a.onSelectedItems))a.onSelectedItems(a._selectedItems());if(a.onSelectedIds!=null&&!cube.isObservable(a.onSelectedIds))a.onSelectedIds(a._selectedIds())}};a.chkboxAllClick=function(){a._selectedIdsSub.dispose();for(var c=a._selectedIds(),b=a.items(),d=a.primaryKey(),f=0,e=b.length;f<e;f++){if(typeof b[f][d]=="undefined"){cube.indicate("warning",cube.msg("SET_PRIMARYKEY"));break}a._selectedAll()?c.indexOf(String(b[f][d]))==-1&&a.checkboxVisible(b[f])&&
(a._selectedIds.push(String(b[f][d])),a._selectedItems.push(b[f])):(a._selectedIds.shift(),a._selectedItems.shift())}if(a.onSelectedItems!=null&&!cube.isObservable(a.onSelectedItems))a.onSelectedItems(a._selectedItems());if(a.onSelectedIds!=null&&!cube.isObservable(a.onSelectedIds))a.onSelectedIds(a._selectedIds());a._selectedIdsSub=cube.subscribe(a._selectedIds,a.chkboxClick)};a.setSelectedItem=function(c,b){if(a._isEdited()&&a._selectedItem()!=c){if(!m(1))return;if(a.onItemEditing!=null&&!cube.isObservable(a.onItemEditing))a.onItemEditing(c,
b);for(var d in a._editedItem)d!="mxVirtualId"&&i.setValue(a._editedItemObj,d,a._editedItem[d]());a.items.replace(a.items()[a._editedItemIndex],a._editedItemObj);var f={},e={};for(d in c)f[d]=cube.obj(c[d]),e[d]=c[d];a._editedItem=f;a._editedItemObj=e;a._editedItemIndex=b}a._selectedItem(c);if(a.onSelectedItem!=null&&!cube.isObservable(a.onSelectedItem))a.onSelectedItem(c)};a.cancelSelectedItem=function(){a._selectedItem(null)};a.dblclick=function(c){if(a.onDblClick!=null&&!cube.isObservable(a.onDblClick))a.onDblClick(c)};
a.delItem=function(c){cube.indicate("confirm",cube.msg("CONFIRM_DELETE"),function(){if(a.onItemDeleting!=null&&!cube.isObservable(a.onItemDeleting)){var b={cancel:!1,data:c};a.onItemDeleting(b);if(b.cancel)return}var d=c[a.primaryKey()];if(d&&a.autoDelete())i.ondeleted=function(b,e){a.items.remove(c);a._selectedIds.remove(d);if(a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c,e);a.refreshDeleted()&&a.load()},i.remove(d,c);else if(a.items.remove(c),a.onItemDeleted!=null&&
!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c)})};a.delSelectedItem=function(){cube.indicate("confirm",cube.msg("CONFIRM_DELETE"),function(){var c=a._selectedItem();if(a.onItemDeleting!=null&&!cube.isObservable(a.onItemDeleting)){var b={cancel:!1,data:c};a.onItemDeleting(b);if(b.cancel)return}var d=c[a.primaryKey()];if(d&&a.autoDelete())i.ondeleted=function(b,e){a.items.remove(c);a._selectedIds.remove(d);if(a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c,e);a.refreshDeleted()&&
a.load()},i.remove(d);else if(a.items.remove(c),a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c)})};a.delCheckedItem=function(){cube.indicate("confirm",cube.msg("CONFIRM_DELETE"),function(){var c=a._selectedIds();if(a.onItemDeleting!=null&&!cube.isObservable(a.onItemDeleting)){var b={cancel:!1,data:c};a.onItemDeleting(b);if(b.cancel)return}if(a.autoDelete())i.ondeleted=function(b,f){for(var e=0;e<c.length;e++)a.items.remove(u.getItem(a.items(),a.primaryKey(),c[e]));if(a.onItemDeleted!=
null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c,f);a.refreshDeleted()&&a.load()},i.remove(c);else{for(b=0;b<c.length;b++)a.items.remove(u.getItem(a.items(),a.primaryKey(),c[b]));if(a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c)}a._selectedIds([])})};a.editItem=function(c,b){if(a._isEdited()&&a._selectedItem()!=c){if(!m(1))return;for(var d in a._editedItem)d!="mxVirtualId"&&i.setValue(a._editedItemObj,d,a._editedItem[d]());a.items.replace(a.items()[a._editedItemIndex],
a._editedItemObj)}if(a.onItemEditing!=null&&!cube.isObservable(a.onItemEditing))a.onItemEditing(c,b);var f={},e={};for(d in c)d==a.primaryKey()&&c[d]==null||(f[d]=cube.obj(c[d]),e[d]=c[d]);(d=a._showItemColumns())&&d.length>0&&$.each(d,function(b,d){if(d.editorType=="FileEditor")d.pkVal&&cube.isObservable(d.pkVal)?d.pkVal(c[a.primaryKey()]):d.pkVal=cube.obj(c[a.primaryKey()])});a._editedItemIndex=b;a._editedItem=f;a._editedItemObj=e;a._isEdited(!0);a._selectedItem(c)};a.shiftupItem=function(){var c=
a.items.indexOf(this);c>0&&(a.items.splice(c,1),a.items.splice(c-1,0,this))};a.shiftdownItem=function(){var c=a.items.indexOf(this);c<a.items().length-1&&(a.items.splice(c,1),a.items.splice(c+1,0,this))};a.saveItem=function(){if(m(1)){if(a.autoSave()){for(var c in a._editedItem)c!="mxVirtualId"&&i.setValue(a._editedItemObj,c,a._editedItem[c]());if(a.onItemSaving!=null&&!cube.isObservable(a.onItemSaving)&&(c={cancel:!1,data:a._editedItemObj},a.onItemSaving(c),c.cancel))return;i.onsaved=function(c){if(typeof a._editedItemObj[a.primaryKey()]==
"undefined"&&c.result.newData.length>0){if(a.items.replace(a.items()[a._editedItemIndex],c.result.newData[0]),a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(c.result.newData[0])}else if(a.items.replace(a.items()[a._editedItemIndex],a._editedItemObj),a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(a._editedItemObj)};i.save()}else{var b={};for(c in a._editedItem)c!="mxVirtualId"&&(b[c]=a._editedItem[c]());if(a.onItemSaving!=null&&!cube.isObservable(a.onItemSaving)&&
(c={cancel:!1,data:b},a.onItemSaving(c),c.cancel))return;a.items.replace(a.items()[a._editedItemIndex],b);if(a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(b)}a._isEdited(!1);a._editedItem=null;a._selectedItem(null)}};var k=null;a.saveAppend=function(c,b){if(m(0)){k==null&&(k=i.create());for(var d in a._appendedItem)d=="mxVirtualId"||d==a.primaryKey()||(k[d]=a._appendedItem[d]());if(c&&cube.isArray(c))for(var f=0;f<c.length;f++)for(d in c[f])d=="mxVirtualId"||d==a.primaryKey()||
(k[d]=c[f][d]);if(a.autoSave()||b===!0){if(a.onItemSaving!=null&&!cube.isObservable(a.onItemSaving)&&(f={cancel:!1,data:k},a.onItemSaving(f),f.cancel))return;for(d in k)d!=a.primaryKey()&&i.setValue(k,d,k[d]);i.onsaved=function(c){for(var b=0;b<c.result.newData.length;b++)a.items.push(c.result.newData[b]);var c=!1,b=a._showItemColumns(),d;for(d in a._appendedItem){for(var e=0;e<b.length;e++)if(d==b[e].name&&typeof b[e].value!="undefined"){cube.isObservable(b[e].value)?(a._appendedItem[d]=b[e].value,
a._appendedItemObj[d]=b[e].value()):(a._appendedItem[d](b[e].value),a._appendedItemObj[d]=b[e].value);c=!0;break}c||(a._appendedItem[d](null),a._appendedItemObj[d]=null,c=!1);delete a._appendedItem.mxVirtualId;delete a._appendedItem[a.primaryKey()]}if(a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(k);k=null};i.save()}else{if(a.onItemSaving!=null&&!cube.isObservable(a.onItemSaving)&&(f={cancel:!1,data:k},a.onItemSaving(f),f.cancel))return;a.items.push(k);var f=!1,e=a._showItemColumns();
for(d in a._appendedItem){for(var h=0;h<e.length;h++)if(d==e[h].name&&typeof e[h].value!="undefined"){cube.isObservable(e[h].value)?(a._appendedItem[d]=e[h].value,a._appendedItemObj[d]=e[h].value()):(a._appendedItem[d](e[h].value),a._appendedItemObj[d]=e[h].value);f=!0;break}f||(a._appendedItem[d](null),a._appendedItemObj[d]=null,f=!1);delete a._appendedItem.mxVirtualId;delete a._appendedItem[a.primaryKey()]}if(a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(k);k=null}a._isEdited(!1);
a._editedItem=null;a._selectedItem(null)}};a.cancelSaveItem=function(){a._isEdited(!1);a._editedItem=null;a._selectedItem(null);for(var c=a._showItemColumns(),b=0;b<c.length;b++)c[b].validStatus("")};a.appendItem=function(){if(m(0)){var c={},b=!1,d=a._showItemColumns(),f;for(f in a._appendedItem){c[f]=a._appendedItem[f]();for(var e=0;e<d.length;e++)if(f==d[e].name&&typeof d[e].value!="undefined"){cube.isObservable(d[e].value)?(a._appendedItem[f]=d[e].value,a._appendedItemObj[f]=d[e].value()):(a._appendedItem[f](d[e].value),
a._appendedItemObj[f]=d[e].value);b=!0;break}b||(a._appendedItem[f](null),a._appendedItemObj[f]=null,b=!1)}a.items.push(c)}};a.sortType=cube.obj(-1);a.sortName=cube.obj("");a.sortGrid=function(){var c=this.name;a.sortName(c);a.items.sort(function(b,d){var f=b[c],e=d[c];if(f==null&&e==null)return 0;else if(f==null&&e!=null)return a.sortType()==1?-1:1;else if(f!=null&&e==null)return a.sortType()==1?1:-1;!isNaN(f)&&!isNaN(e)?(f=Number(f),e=Number(e)):(f=v.convertPinyin(f),e=v.convertPinyin(e));return f==
e?0:f<e?a.sortType():a.sortType()*-1});a.sortType(a.sortType()*-1)};var s=!1,t=!1,z=0,A=0,B;a.mousedown=function(a,b,d){if(s)t=!0,z=d.clientX,A=$(a).width(),B=$(a)};a.mouseup=function(){t=!1};a.mousemove=function(a,b){if(a.colSpan==1)b.offsetX>$(a).width()-10?(a.style.cursor="e-resize",s=!0):(a.style.cursor="default",s=!1),t&&B.width(A+(b.clientX-z)+"px")};a.onCurrentPageIndexChanged=function(){a._selectedAll(!1);a._indexNotLoad()||a.load()};a.load=function(c){a.isShowLoading(!0);_startLoadTime=(new Date).getTime();
a._selectedItem(null);a._selectedIds([]);a._selectedItems.removeAll();var b=null;cube.notEmpty(c)&&$.isPlainObject(c)&&(b=c);var d={metaParams:null,dataParams:null};if(cube.notEmpty(b))cube.isEmpty(b.metaParams)&&cube.isEmpty(b.dataParams)?d.dataParams=b:d=$.extend(d,b);var f=!1;if(cube.notEmpty(c)&&cube.notEmpty(c.isSearchLoad))f=c.isSearchLoad,delete c.isSearchLoad;b="";if(cube.notEmpty(c)&&cube.notEmpty(c.filter))b=c.filter;else if(b=cube.clone(c))delete b.pageIndex,delete b.pageSize;var c=null,
c=cube.isObservable(a.args)?a.args():a.args,e=null,h=null;if(a.searchBoxId()&&(h=cube.getPageViewModelByNode($("#"+a.searchBoxId()))))if(e=cube.isObservable(h._params)?h._params():h._params,!f||!e)e=h.searchParamType()=="json"?h.getJsonSearchParam():h.getSearchParam();if(h&&h.searchParamType()=="json"){if(e.length>0){if(cube.isArray(c))for(var g=0;g<c.length;g++)e.push(c[g]);else e.push(c);if(cube.isArray(b))for(g=0;g<b.length;g++)e.push(b[g]);else e.push(b)}else e=c;b=e}else{h=f="";if($.isPlainObject(b)){for(g in b)var j=
b[g],h=h+"&"+g+"="+(cube.isObservable(j)?j():j);b=h}if($.isPlainObject(c)){for(g in c)j=c[g],f=f+"&"+g+"="+(cube.isObservable(j)?j():j);cube.notEmpty(b)?b+=f:b=f.substring(1,f.length)}else cube.isString(c)&&(b=cube.notEmpty(b)?b+"&"+c:c);if($.isPlainObject(e)){for(g in e)j=e[g],f=f+"&"+g+"="+(cube.isObservable(j)?j():j);cube.notEmpty(b)?b+=f:b=f.substring(1,f.length)}else cube.isString(e)&&(b=cube.notEmpty(b)?b+"&"+e:e)}if(cube.notEmpty(b))d.dataParams=$.extend({filter:b},d.dataParams);if(a.loadMeta()&&
cube.notEmpty(a._columns))b="",b=a._getColunmsNames().join(","),g={columns:b},d.metaParams=$.extend({columns:b},d.metaParams),d.dataParams=$.extend(g,d.dataParams);d.dataParams&&cube.notEmpty(d.dataParams.pageIndex)&&d.dataParams.pageIndex!=a.pageIndex()&&(a._indexNotLoad(!0),a.pageIndex(d.dataParams.pageIndex),a._indexNotLoad(!1));b={pageIndex:parseInt(a.pageIndex()),pageSize:parseInt(a.pageSize())};d.dataParams=$.extend(b,d.dataParams);i.load(d)};a._getColunmsNames=function(){for(var c=[],b=0;b<
a._columns.length;b++)w(c,a._columns[b]);return c};a.print=function(){D.print(a.items,a.columns,a.dicts,"groupheadergrid")};a.save=function(c){var b=null,d=a.items(),f=a.primaryKey();if(d.length>0){for(var e=0;e<d.length;e++){var h=d[e];if(h!=null){if(d[e][f]){if(b={},b[f]=d[e][f],a._editedItem&&a._editedItem[f]&&h[f]==a._editedItem[f]())h=a._editedItem}else b=i.create();for(var g in a._appendedItemObj)g=="mxVirtualId"||g==f||(b[g]=a._appendedItemObj[g]());if(c&&cube.isArray(c))for(var j=0;j<c.length;j++)for(g in c[j])g==
"mxVirtualId"||g==f||(b[g]=c[j][g]);if(m())for(g in b)g=="mxVirtualId"||g==f||(cube.isFunction(h[g])?i.setValue(b,g,b[g]!=null?b[g]:h[g]()):i.setValue(b,g,b[g]!=null?b[g]:h[g]))}}i.onsaved=function(b){if(b.p_result.resultValue.items)for(var c=0;c<d.length;c++)a.items.replace(d[c],b.p_result.resultValue.items[c])};i.save()}else a.saveAppend(c,!0);a._isEdited(!1);a._editedItem=null;a._selectedItem(null)};a.exportExcel=function(c,b,d,f){n.setBaseUrl(c);n.setParams(b);d===!0&&n.setIds(a._selectedIds());
f==!0&&n.setType("post");n.exportExcel()};var l;a._editor_upload=function(c,b){a._editedItem[c](b)};a.checkboxVisible=function(c){var b=a.checkboxHideCondition(),d=!0;if(cube.isEmpty(b))return!0;else if(typeof b=="boolean")return b;else if(cube.isArray(b))for(var f=0;f<b.length;f++){if(d=a._checkCondition(c,b[f]),!d)break}else d=a._checkCondition(c,b);return!d};a.customOperationsVisible=function(c,b){var d=!0;if(cube.isEmpty(b))d=!0;else if(typeof b=="boolean")return b;else if(cube.isArray(b))for(var f=
0;f<b.length;f++){if(d=a._checkCondition(c,b[f]),!d)break}else d=a._checkCondition(c,b);return d};a._checkCondition=function(a,b){var d=!1;switch(b.operation){case "==":d=a[b.column]==b.value;break;case "!=":d=a[b.column]!=b.value;break;case ">":d=a[b.column]>b.value;break;case "<":d=a[b.column]<b.value;break;case ">=":d=a[b.column]>=b.value;break;case "<=":d=a[b.column]<=b.value;break;case "in":cube.isArray(b.value)&&b.value.indexOf(a[b.column])!=-1&&(d=!0)}return d};a.renderCell=function(c,b,d,
f){cube.isObservable(c)&&(c=c());var e=null,h=!1,g="",e=a._dictsKeyValue();if(d.renderCell)cube.notEmpty(e)&&cube.notEmpty(e[d.name])&&(g=e[d.name][c],typeof g=="undefined"&&(g="")),e=d.renderCell(c,b,g,f,d),e==null?e=cube.notEmpty(g)?g:c:h=!0;else if(cube.notEmpty(e)&&cube.notEmpty(e[d.name]))e=e[d.name][c],typeof e=="undefined"&&(e=c);else if(typeof d.editorType!="undefined"&&d.editorType=="DateTimeEditor")e=a._parseDate(c,d.format);else{e=c;f=$(b);if(typeof d.displayLength!="undefined"&&cube.notEmpty(e))e=
String(e),e.length>d.displayLength&&(e=e.substring(0,d.displayLength)+"...");else if(typeof d.displayRow!="undefined"&&cube.notEmpty(e)){var e=String(e),g=f.width(),i=parseInt(f.css("fontSize")),g=parseInt(g/i*d.displayRow)-3;e.length>g&&(e=e.substring(0,g)+"...")}if(typeof d.displayRow!="undefined"||typeof d.displayLength!="undefined")f.css("white-space","normal"),f.css("word-break","break-all")}f=a.trBackground();if(f!=null&&d.name==f.column){g=!1;switch(f.operation){case "==":g=c==f.value;break;
case "!=":g=c!=f.value;break;case ">":g=c>f.value;break;case "<":g=c<f.value;break;case ">=":g=c>=f.value;break;case "<=":g=c<=f.value;break;case "in":cube.isArray(f.value)&&f.value.indexOf(c)!=-1&&(g=!0)}g&&$(b).parent().css("background",f.background)}e&&(e=String(e),e=a.scriptProcessing()=="clean"||h?cube.cleanScript(e):cube.escapeString(e,typeof d.isAllowAutowrap!="undefined"?d.isAllowAutowrap:a.isAllowAutowrap()));return e};a.mouseenter=function(c,b,d,f){if(typeof d.onMouseenter=="function")d.onMouseenter(c,
b);var b=String(b),c="",e=a._dictsKeyValue();cube.notEmpty(e)&&cube.notEmpty(e[d.name])&&(c=e[d.name][b],typeof c=="undefined"&&(c=""));b=cube.notEmpty(c)?c:b;typeof d.editorType!="undefined"&&d.editorType=="DateTimeEditor"&&(b=a._parseDate(b,d.format));if(e=b)b=String(b),a.scriptProcessing()=="clean"?e=b=cube.cleanScript(b):b=cube.escapeString(b,typeof d.isAllowAutowrap!="undefined"?d.isAllowAutowrap:a.isAllowAutowrap());c=(a.isAllowAutowrap()==!1||d.isAllowAutowrap==!1)&&f.scrollWidth>f.clientWidth;
if((typeof d.displayLength!="undefined"||typeof d.displayRow!="undefined"||c)&&cube.notEmpty(b))if(a.isShowTips()){e=d.displayLength;if(typeof d.displayRow!="undefined")var e=$(f).width(),h=parseInt($(f).css("fontSize")),e=parseInt(e/h*d.displayRow)-3;if(b.length>e||c)a.showCellPopDialog(!0),cube.showPopDialog(f,{popoverDirection:"top",content:b.replace(/\n/g,"<br/>"),isShowDialog:a.showCellPopDialog})}else $(f).attr("title",e)};a.mouseleave=function(c,b,d){if(typeof d.onMouseleave=="function")d.onMouseleave(c,
b);a.showCellPopDialog(!1)};a._parseDate=function(a,b){if(cube.notEmpty(a)){cube.isString(a)||(a=String(a));var d=new Date(a.replace(/-/g,"/"));F.isDigit(a)&&(cube.isEmpty(b)&&(b="yyyy-MM-dd HH:mm:ss"),a.length==10&&(a+="000"),a.length==13&&(d=new Date(parseInt(a))));cube.isEmpty(b)?b=a:(b=b.replace(/yyyy/g,d.getFullYear()),b=b.replace(/MM/g,o(d.getMonth()+1,"00")),b=b.replace(/dd/g,o(d.getDate(),"00")),b=b.replace(/HH/g,o(d.getHours(),"00")),b=b.replace(/mm/g,o(d.getMinutes(),"00")),b=b.replace(/ss/g,
o(d.getSeconds(),"00")))}else b=a;return b};a.appendCustomClick=function(c){if(cube.isFunction(c.click)){var b={},d;for(d in a._appendedItem)d=="mxVirtualId"||d==a.primaryKey()||(b[d]=a._appendedItem[d]());c.click(b)}};a.onload=function(c){var b=$(c).find(".tableBody"),d=a.watermarkOptions();if(cube.notEmpty(d)&&cube.notEmpty(d.text)){d=$.extend(a._watermarkOptionsDefaultValue(),d);d.indent=(parseInt(d.width)+parseInt(d.xSpace))/2;a.watermarkOptions(d);for(var f=parseInt((b.height()-d.y)/(parseInt(d.height)+
parseInt(d.ySpace)))+1,e=0;e<f;e++)a.watermarkRows.push({y:d.y+(parseInt(d.height)+parseInt(d.ySpace))*e});b=parseInt((b.width()-d.x)/(parseInt(d.width)+parseInt(d.xSpace)))+1;for(e=0;e<b;e++)a.watermarkCols.push({x:d.x+(parseInt(d.width)+parseInt(d.xSpace))*e})}if(a.onRendered!=null&&!cube.isObservable(a.onRendered))a.onRendered(c)};cube.endViewModel(a,p)}cube.importComponent("editor.commoneditor");cube.importComponent("editor.datetimeeditor");cube.importComponent("editor.dropdowneditor");cube.importComponent("datacontainer.pagenavibar");
cube.importComponent("controls.loading");p.prototype.dispose=function(){this.pageSizeSub.dispose();this.argsSub.dispose();this._selectedIdsSub.dispose();this._selectedAllSub.dispose();this.actionsSub.dispose();this.dictsSub.dispose();this.selectedIdsSub.dispose()};return p});