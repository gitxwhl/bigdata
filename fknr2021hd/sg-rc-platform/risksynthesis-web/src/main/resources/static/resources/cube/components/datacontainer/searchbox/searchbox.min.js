define(["entityContainer","JSONUtil","CheckUtil","Validator"],function(t,x,n,o){function k(k){function u(b){var c={},c=cube.isEmpty(b.items)?{}:cube.isArray(b.items)?b.items[0]:b.items;cube.notEmpty(b.dicts)&&cube.isArray(b.dicts)&&b.dicts.length>0&&a._dicts(b.dicts);if(cube.notEmpty(c))for(var b=a.fields(),e=0;e<b.length;e++){var d=c[b[e].name];if(cube.notEmpty(d))b[e].value(d),h[e].value=d}a._isload(!0);if(a.isCustomTemplate()==!0&&p==!0&&q==!1)a.onload(l);if(a.onLoaded!=null&&!cube.isObservable(a.onLoaded))a.onLoaded(c)}
function v(){a._isload(!0)}function w(b,c,e){b.editorType=="DateTimeEditor"&&cube.notEmpty(b.value)&&a._lazyload(!0);if(cube.notEmpty(c.value))b.value=cube.obj(c.value);else if(b.value){if(!cube.isObservable(b.value))b.value=cube.obj(b.value)}else b.value=cube.obj("");if(b.editorType=="DropDownEditor"||b.editorType=="CheckListEditor"||b.editorType=="ListEditor")if(e&&e[b.name]&&(cube.isEmpty(b.autoDict)||b.autoDict==!0))cube.isObservable(b.list)?b.list(e[b.name]):b.list=e[b.name];else if(c.list)b.list=
cube.array(c.list);else if(b.list){if(!cube.isObservable(b.list))b.list=cube.array(b.list)}else b.list=cube.array([]);if(cube.isEmpty(b.nullable))b.nullable=cube.obj(!0);else if(!cube.isObservable(b.nullable))b.nullable=cube.obj(b.nullable);if(typeof b.validStatus=="undefined")b.validStatus=cube.obj("");else if(!cube.isObservable(b.validStatus))b.validStatus=cube.obj(b.validStatus);if(typeof b.validHint=="undefined")b.validHint=cube.obj("");else if(!cube.isObservable(b.validHint))b.validHint=cube.obj(b.validHint);
a.isCustomTemplate()==!0&&(a.editors[b.name]=b);return b}var a=this,f=new t;a.url="";a.id=null;a.timeout=null;a.loadByPost=!1;a.displaySearchButton=!0;a.displayResetBtns=!0;a.buttonAlign=null;a.separator="";a.param=null;a.style="";a.fields=[];a.data=null;a.editors=null;a.sqlCheck=!0;a.editorWidth=cube.theme=="small"?"98px":cube.theme=="middle"?"116px":"136px";a.captionSpanNum=5;a.editorSpanNum=7;a.isLineFeed=!0;a.isDefaultLayout=!0;a.colNum=3;a.emptyDefaultValue=!1;a.allowSqlKeyQuery=!0;a.searchParamType=
"string";a.encodeValue=!1;a.gridId=null;a.customBtns=[];a.validHintType="pop";a.isValid=!0;a.isCustomTemplate=!0;a._params=null;a._dicts=null;a._editorWidth1="";a._editorWidth2="";a._colnum="three";a.isShowPopDialog=!1;a.onSearch=null;a.onReset=null;a.onRendered=null;a.onLoaded=null;a._isload=!1;a._lazyload=!1;var h=null,l=null,r=0,q=!1,p=!1;a._init=function(){a.editors={};a._editorWidth1(parseInt(a.editorWidth().replace("px",""),10)+38+"px");a._editorWidth2(parseInt(a.editorWidth().replace("px",
""),10)+52+"px");a.dictsSub=cube.subscribe(a._dicts,a.setFiledDicts);h=a.fields();a._mergeFields();if(cube.notEmpty(a.url())||a.data()!=null)f.baseUrl=a.url(),f.meta=h,f.type="form",f.timeout=a.timeout(),f.loadMeta=!1,f.onload=u,f.onerror=v,f.data=a.data(),f.dicts=a._dicts(),f.loadByPost=a.loadByPost(),f.init(),a.load()};a.load=function(){f.load(a.id(),a.param())};a.search=function(){if(!a.isValid()||a.validate())if(l_params=a.searchParamType()=="json"?a.getJsonSearchParam():a.getSearchParam(),!(a.allowSqlKeyQuery()==
!1&&a._isSqlInject)){a._params=l_params;if(a.onSearch!=null&&!cube.isObservable(a.onSearch)){var b=1,c=null;a.gridId()!=null&&(c=cube.getPageViewModelByNode($("#"+a.gridId())));c&&(b=c.pageIndex(),c._indexNotLoad(!0),c.pageIndex(1),c._indexNotLoad(!1));var e={cancel:!1},d=a.onSearch(l_params,e);if(e.cancel||d===!1){c&&(c._indexNotLoad(!0),c.pageIndex(b),c._indexNotLoad(!1));return}}a.loadGrid(!0)}};a.reset=function(){a.isShowPopDialog(!1);for(var b=a.fields(),c=0;c<b.length;c++){var e=null;if(!a.emptyDefaultValue())for(var d=
0;d<h.length;d++)if(h[d].name==b[c].name){e=h[d].editorType=="DropDownEditor"&&h[d].isSelectedFirst&&cube.notEmpty(h[d].list[0].value)?cube.isObservable(h[d].list[0].value)?h[d].list[0].value():h[d].list[0].value:h[d].editorType=="DateTimeEditor"&&h[d].isShowValue?(new Date).getTime():cube.isObservable(h[d].value)?h[d].value():h[d].value;break}b[c].value.silentUpdate(typeof e=="undefined"?"":e)}if(a.onReset!=null&&!cube.isObservable(a.onReset))a.onReset()};a.getJsonSearchParam=function(){a._isSqlInject=
!1;for(var b=[],c=a.fields(),e=[],d=0;d<c.length;d++){var m=c[d].name,g=c[d].value();if(cube.notEmpty(g)){var j={},h=[];if((c[d].editorType=="TextEditor"||c[d].editorType=="NumberEditor")&&a.sqlCheck()){var f=n.isSqlInjection(g);if(!f.successful&&e.indexOf(f.hint)==-1){e.push(f.hint);continue}}f={};f.fieldName=m;f.operator="=";f.value=g;h.push(f);j.criterions=h;j.junction="and";j.columnJunction="and";b.push(j)}}if(!a.allowSqlKeyQuery()&&e.length>0)a._isSqlInject=!0,c=e.join(","),cube.indicate("error",
cube.msg("SQL_INJECTION",{sql:c}));return b};a.getSearchParam=function(){a._isSqlInject=!1;for(var b="",c=a.fields(),e=[],d=0;d<c.length;d++){var m=c[d].name,g=c[d].value();if(cube.notEmpty(g))if(c[d].editorType=="TextEditor"||c[d].editorType=="NumberEditor")if(a.sqlCheck()){var j=n.isSqlInjection(g);j.successful?b=b+m+"="+(a.encodeValue()==!0?encodeURIComponent(g):g)+"&":e.indexOf(j.hint)==-1&&e.push(j.hint)}else b=b+m+"="+(a.encodeValue()==!0?encodeURIComponent(g):g)+"&";else b=b+m+"="+(a.encodeValue()==
!0?encodeURIComponent(g):g)+"&"}if(!a.allowSqlKeyQuery()&&e.length>0)a._isSqlInject=!0,c=e.join(","),cube.indicate("error",cube.msg("SQL_INJECTION",{sql:c}));b.length>0&&(b=b.substring(0,b.length-1));return b};var s=!1;a.setDicts=function(b){s||(a._dicts(b),s=!0)};a.setFiledDicts=function(b){var c=a.fields();$.each(c,function(a,c){if(cube.notEmpty(c)&&(c.editorType=="DropDownEditor"||c.editorType=="CheckListEditor"||c.editorType=="ListEditor"))if(b&&b[c.name]&&(cube.isEmpty(c.autoDict)||c.autoDict==
!0))cube.isObservable(c.list)?c.list(b[c.name]):c.list=b[c.name];else if(c.list)c.list=cube.array(c.list);else if(c.list){if(!cube.isObservable(c.list))c.list=cube.array(c.list)}else c.list=cube.array([])})};a.loadGrid=function(b){if(a.gridId()!=null){var c=cube.getPageViewModelByNode($("#"+a.gridId()));c&&c.load({pageIndex:1,isSearchLoad:b})}};a._mergeFields=function(){var b=cube.clone(h),c=a.fields(),e=a._dicts();$.each(b,function(a,b){if(cube.notEmpty(b)){for(i in b)i=="length"&&delete p_field[i];
$.each(b,function(a,c){if(cube.isEmpty(b[a])||cube.isEqual(a,"readOnly")||cube.isEqual(a,"maxLength")||cube.isEqual(a,"nullable"))b[a]=c});var g=null;c&&(g=c[a]);w(b,g,e)}});a.fields(b)};a.validate=function(){for(var b=a.fields(),c=0;c<b.length;c++)if(!a.valid(b[c])||cube.isObservable(b[c].validStatus)&&b[c].validStatus()!="")return!1;return!0};a.valid=function(b){var c=!0;if((cube.isObservable(b.visible)?b.visible():b.visible)===!1)return b.validStatus(""),b.validHint(""),a.isShowPopDialog(!1),c;
var e=b.value();if(b.editorType=="NumberEditor"){var d=o.validate(e,"DIGIT",null);d.successful||(e="")}var f;b.customValidate!=null&&cube.isFunction(b.customValidate)&&!cube.isObservable(b.customValidate)&&(f=b.customValidate(e));if(f===!1||$.isPlainObject(f)&&f.successful===!1)return $.isPlainObject(f)&&f.hint&&(c=!1,b.validStatus("error"),a.validHintType()=="pop"?(a.isShowPopDialog(!1),a.isShowPopDialog(!0),cube.showPopDialog($(l).find("#"+b.name),{content:f.hint,popoverDirection:"bottom",msgType:"error",
isShowDialog:a.isShowPopDialog})):b.validHint(f.hint)),c;d=b.validType;f=cube.isObservable(b.nullable)?b.nullable():b.nullable;typeof f!="undefined"&&f===!1&&(d==null?d="NOTNULL":d.indexOf("NOTNULL")==-1&&(d+=", NOTNULL"));if(d&&d.indexOf("NOTNULL")==-1&&cube.isEmpty(e))return c;d!=null?(d=o.validate(e,d,b.validOptions),d.successful?(b.validStatus(""),b.validHint(""),a.isShowPopDialog(!1)):(b.validStatus("error"),c=!1,a.validHintType()=="pop"?(a.isShowPopDialog(!1),a.isShowPopDialog(!0),cube.showPopDialog($(l).find("#"+
b.name),{content:d.hint,popoverDirection:"bottom",msgType:"error",isShowDialog:a.isShowPopDialog})):b.validHint(d.hint))):(b.validStatus(""),b.validHint(""),a.isShowPopDialog(!1));return c};a.customBtnClick=function(b,c){var e=!0;a.isValid()&&cube.notEmpty(c)&&c==!0&&(e=a.validate());cube.isFunction(b)&&e&&b()};a._getSpanNum=function(b,c){if(c==0)return b&&typeof b.spanNum!="undefined"?"span"+b.spanNum:a.isDefaultLayout()?b&&typeof b.colspan!="undefined"?a.colNum()==5?"span50":"span"+b.colspan*Math.floor(12/
a.colNum()):a.colNum()==5?"span50":"span"+Math.floor(12/a.colNum()):"fluid";else if(c==1){if(a.isDefaultLayout())return b&&typeof b.captionSpanNum!="undefined"?a.colNum()==5?"span51":"span"+b.captionSpanNum:a.colNum()==5?"span51":"span"+a.captionSpanNum()}else if(c==2)return a.isDefaultLayout()?b&&typeof b.editorSpanNum!="undefined"?a.colNum()==5?"span52":"span"+b.editorSpanNum:a.colNum()==5?"span52":"span"+a.editorSpanNum():"fluid";else if(c==3)if(a.isDefaultLayout()){var e=a.buttonAlign(),d=a.fields();
if(e==null||e=="left")return a.colNum()==5?"span50":"span"+Math.floor(12/a.colNum());else if(a.isLineFeed()==!1&&cube.isArray(d))return a.colNum()==5?"span50":"span"+(a.colNum()-d.length%a.colNum())*Math.floor(12/a.colNum())}else return"";else if(c==4){if(e=a.buttonAlign(),e==null||e=="left")return a.colNum()==5?"span51":"span"+a.captionSpanNum()}else if(c==5&&(e=a.buttonAlign(),e==null||e=="left"))return a.colNum()==5?"span52":"span"+a.editorSpanNum()};a.getEditorParam=function(b){var c=cube.clone(b);
c.validHintType=a.validHintType;c.isValid=a.isValid;c.isShowPopDialog=a.isShowPopDialog;c.onRendered=a.editorRendered;if(b.editorType=="DateTimeEditor")c.width=typeof b.width!="undefined"?b.width:a.editorWidth;else if(b.editorType=="DropDownTreeEditor")c.width=typeof b.width!="undefined"?b.width:a.editorWidth,c.isExtDisplay=typeof b.isExtDisplay!="undefined"?b.isExtDisplay:!0;else if(b.editorType!="DateTimeEditor"&&b.editorType!="FileEditor"&&b.editorType!="RichEditor")c.width=typeof b.width!="undefined"?
b.width:typeof b.editorType!="undefined"&&(b.editorType!="DropDownEditor"||b.editorType=="DropDownEditor"&&typeof b.isAllowEdit!="undefined"&&b.isAllowEdit==!0)&&b.editorType!="TextEditor"?a.editorWidth:typeof b.editorType!="undefined"&&b.editorType=="DropDownEditor"?a._editorWidth2():a._editorWidth1();return c};a.editorRendered=function(b,c){if(cube.notEmpty(c)&&cube.isFunction(c.onRendered))c.onRendered(b,c);r++;if(r==a.fields().length){if(a.onRendered!=null&&!cube.isObservable(a.onRendered))a.onRendered(l,
this);a._lazyload()&&cube.isEmpty(a.url())&&a._isload(!0)}};a.onload=function(b,c){l=b;p=!0;if(a.isCustomTemplate()==!0&&(cube.isEmpty(a.url())||a._isload()==!0)){q=!0;for(var e=$(b).find("*[option]"),d={},f=0;f<e.length;f++){var g=$(e[f]);cube.cleanNode(g);var d=g.attr("option").split("."),j=a.editors[d[0]],c={editors:a.editors},h="visible: typeof(editors['"+j.name+"'].visible) != 'undefined' ? editors['"+j.name+"'].visible : true";if(d[1]=="editor"){var d=a.getEditorParam(j),k="commoneditor";if(j.editorType==
"DateTimeEditor"||j.editorType=="FileEditor"||j.editorType=="RichEditor")k=j.editorType.toLowerCase();d={component:{name:k,params:d}};g.attr("data-bind",h+", attr: {id:'"+j.name+"', 'class' : 'form-inline ' + editors['"+j.name+"'].validStatus()+' "+j.name+"',title:editors['"+j.name+"'].validHint()}");cube.bindComponentByNode(g,d)}else d[1]=="validHint"?g.attr("data-bind","text: editors['"+j.name+"'].validHint()"):d[1]=="visible"?g.attr("data-bind",h):g.attr("data-bind","text: '"+j[d[1]]+"', "+h);
cube.bindTemlate(g,c);g.is("span")&&g.addClass("editor-option")}}};cube.endViewModel(a,k)}cube.importComponent("editor.commoneditor");cube.importComponent("editor.datetimeeditor");cube.importComponent("editor.dropdowneditor");cube.importComponent("editor.dropdowntreeeditor");cube.importComponent("controls.loading");k.prototype.dispose=function(){this.isShowPopDialog(!1);this.dictsSub.dispose()};return k});