define(["entityContainer","JSONUtil","PrintUtil","Validator","CheckUtil","ExcelUtil","PinyinUtil"],function(C,s,D,E,F,l,t){function o(o){function u(a,b){if(cube.isArray(a)&&!cube.isEmpty(b))if(b.columns!=void 0&&cube.isArray(b.columns))for(var d=0;d<b.columns.length;d++)u(a,b.columns[d]);else a.push(b.name)}function G(c){cube.notEmpty(a.url())&&cube.notEmpty(a._columns)&&a._columns.length==0&&a.columns(c.columns);a.initColumn(c);if(a.searchBoxId()){var b=cube.getPageViewModelByNode($("#"+a.searchBoxId()));
b&&(_params=cube.isObservable(b._params)?b._params():b._params,!_params&&c.dicts&&c.dicts.length>0&&b.setDicts(c.dicts))}a.dicts(c.dicts);a._dictsKeyValue(c.dictsKeyValue);cube.notEmpty(c.items)&&!(c.items.length==1&&c.items[0]==null)?a.items(c.items):a.items([]);a.itemCount(c.itemCount);a._pageCount(parseInt((c.itemCount+parseInt(a.pageSize())-1)/parseInt(a.pageSize())));a.itemsChange();a.isAllowAppend()&&v();a.itemsSub=cube.subscribe(a.items,function(){a.itemsChange()});c=a.selectedIds();c.length>
0&&a._selectedIds(c);a.isShowLoading(!1);c=(new Date).getTime()-w;a.loadTime(c>1E3?c/1E3+"s":c+"ms");if(a.onLoaded!=null&&!cube.isObservable(a.onLoaded))a.onLoaded(a.items())}function H(c){a.isShowLoading(!1);if(a.onLoadError!=null&&!cube.isObservable(a.onLoadError))a.onLoadError(c)}function v(){var c=cube.clone(a._columns),b=a.dicts(),d={},e={};c&&c.length>0&&$.each(c,function(){typeof this.value!="undefined"?cube.isObservable(this.value)?(d[this.name]=this.value,e[this.name]=this.value()):(d[this.name]=
cube.obj(this.value),e[this.name]=this.value):(d[this.name]=cube.obj(null),e[this.name]=null);if(!this.editorType)this.editorType="TextEditor";if(this.editorType=="DropDownEditor"||this.editorType=="CheckListEditor"||this.editorType=="ListEditor"||this.editorType=="LabelEditor")if(typeof this.list=="undefined")this.list=b&&b[this.name]?b[this.name]:cube.array();else if(!cube.isObservable(this.list))this.list=cube.isArray(this.list)?cube.array(this.list):cube.obj(this.list);this.validStatus=cube.obj("");
this.validHint=cube.obj("")});a._appendedItem=d;a._appendedItemObj=e;a.appendColumns(c)}function m(a,b){if(a==null)return"";if(typeof b=="undefined")return a+"";if(typeof b=="number")return a+"";var d=a+"";if(b!=null&&b!=""){var d=d.split("."),e=b.split(".");d[0].length<e[0].length&&(d[0]=e[0].substring(0,e[0].length-d[0].length)+d[0]);if(e.length==1)return d[0];else{if(d.length>1)for(;d[1].length<e[1].length;)d[1]+="0";else d[1]=e[1];return(new Number(d[0]+"."+d[1])).toFixed(e[1].length)}}else return d}
var a=this,j=new C;a.url="";a.style="";a.height="auto";a.maxHeight="auto";a.rowNumberWidth="40px";a.operationsColumnWidth="40px";a.operationsColumnAlign="left";a.items=[];a.columns=[];a.subUrl="";a.subColumns=null;a.customOperations=[];a.columnDefaultWidth="auto";a.markColumn=null;a.trBackground=null;a.checkboxHideCondition=null;a._columns=[];a.appendColumns=null;a.actions={};a.customHeaders=null;a.loadByPost=!1;a.timeout=null;a.pageSize=20;a.pageIndex=1;a.itemCount=0;a.pageInfoToLeft=!1;a.isShowBtnText=
!1;a.firstIcon="";a.previousIcon="";a.nextIcon="";a.endIcon="";a.isShowLoadTime=!1;a.loadTimeFadeout=0;a.blurGoto=!1;a.isShowEditBtnText=!1;a.pageVisibleCount=5;a._pageCount=0;a.primaryKey="id";a.loadMeta=!0;a.selectedIds=[];a._selectedIds=[];a._selectedItems=[];a._selectedAll=!1;a._selectedItem=null;a._editedItem=null;a._editedItemObj=null;a._editedItemIndex=null;a._appendedItem={};a._appendedItemObj={};a._isEdited=!1;a.isAllEdited=!1;a.isShowPrimaryKey=!1;a.isShowRowNumber=!0;a.rowNumberColumnName=
null;a.isRowNumberSerial=!1;a.isShowCheckBox=!1;a.isRadio=!1;a.isShowBorder=!0;a.isShowStripe=!1;a.isShowHover=!1;a.isShowCondense=!1;a.isAllowOperations=!1;a.isAllowAdjustColumn=!0;a.isShowSave=!0;a.isShowAdd=!0;a.isAllowEdit=!1;a.isAllowDelete=!1;a.isAllowShift=!1;a.isAllowAppend=!1;a.isAllowSort=!0;a.isAllowPaging=!0;a.isAllowAutowrap=!1;a.isShowTips=!0;a.args=null;a.searchBoxId=null;a.autoLoad=!0;a.autoSave=!0;a.autoDelete=!0;a.refreshDeleted=!0;a.dicts=null;a.watermarkOptions=null;a._watermarkOptionsDefaultValue=
{text:"",x:40,y:40,xSpace:150,ySpace:60,color:"#278874",alpha:0.2,fontSize:"16px",width:100,height:20,rotate:25};a.watermarkRows=[];a.watermarkCols=[];a.scriptProcessing="escape";a._dictsKeyValue=null;a._bodyHeight="auto";a._bodyMaxHeight="auto";a._headerOperationsColumnWidth=null;a._hasVScroll=!1;a.isShowTempColumn=!1;a.isShowLoading=!1;a._indexNotLoad=!1;a.$tableBody=null;a.$node=null;a.$tableHeader=null;a.showCellPopDialog=cube.obj(!1);a._editorValid=[];a.subGridId=null;a.loadTime=0;a.onSelectedItem=
null;a.onSelectedIds=null;a.onSelectedItems=null;a.onDblClick=null;a.onSaving=null;a.onSaved=null;a.onItemSaving=null;a.onItemSaved=null;a.onItemEditing=null;a.onItemDeleting=null;a.onItemDeleted=null;a.onLoaded=null;a.onLoadError=null;var x=a.onRendered=null,w=0;a._init=function(){a._appendedItem={};var c=a.height(),b=a.maxHeight();c!="auto"&&c!=null&&c.indexOf("%")==-1&&a._bodyHeight(parseInt(c)-41+"px");c=="auto"&&b!="auto"&&a._bodyMaxHeight(parseInt(b)-41+"px");a._headerOperationsColumnWidth(a.operationsColumnWidth());
x=a.isAllowOperations()?a.operationsColumnWidth():0;a._columns=a.columns();a.pageSizeSub=cube.subscribe(a.pageSize,function(){a.load()});a.argsSub=cube.subscribe(a.args,function(){a.pageIndex.silentUpdate(1);a.load()});a._selectedIdsSub=cube.subscribe(a._selectedIds,a.chkboxClick);a._selectedAllSub=cube.subscribe(a._selectedAll,a.chkboxAllClick);a.selectedIdsSub=cube.subscribe(a.selectedIds,function(b){a._selectedIds(b)});a.actionsSub=cube.subscribe(a.actions,function(a){j.actions=a});a.dictsSub=
cube.subscribe(a.dicts,function(b){if(cube.isArray(b)&&b.length>0&&(a._dictsKeyValue()!=null||a.autoLoad()==!1))j._parseDicts({dicts:b}),a._dictsKeyValue(j.dictsKeyValue),a.initColumn({dicts:b})});a.itemsChange();j.primaryKey=a.primaryKey();j.baseUrl=a.url();j.actions=a.actions();j.type="grid";j.timeout=a.timeout();j.loadMeta=a.loadMeta();j.data=a.items();j.dicts=a.dicts();j.onload=G;j.onerror=H;j.customHeaders=a.customHeaders();j.loadByPost=a.loadByPost();j.init();a.autoLoad()?(c=cube.getPageViewModelByNode($("#"+
a.searchBoxId())))&&!c._isload()&&(cube.notEmpty(c.url())||c._lazyload())?cube.subscribe(c._isload,function(){a.load()}):a.load():a.initColumn();a.isAllowAppend()&&v();if(a.isAllEdited())a._initItems(a.items()),a.itemsSub=cube.subscribe(a.items,function(b){a._initItems(b);a.itemsChange()});else if(cube.isEmpty(a.url())||!a.autoLoad())a.itemsSub=cube.subscribe(a.items,function(b){a.itemCount(b.length);a._pageCount(parseInt((b.length+parseInt(a.pageSize())-1)/parseInt(a.pageSize())));setTimeout(function(){a.itemsChange()},
500)})};a._initItems=function(c){if(cube.notEmpty(c)&&c.length>0){var b=a.columns(),d=a._editorValid();if(b&&b.length>0)for(var e=0;e<c.length;e++)d[e]={},$.each(b,function(a,b){var h=c[e][b.name];typeof h=="undefined"?c[e][b.name]=cube.obj():cube.isObservable(h)||(c[e][b.name]=cube.obj(h));h={validStatus:cube.obj(""),validHint:cube.obj("")};d[e][b.name]=h});a._editorValid(d)}else a._editorValid([])};a.setActions=function(c){a.actions(cube.isObservable(c)?c():c);j.actions=c};a.chkboxClick=function(c){for(var b=
a.items(),d=a.primaryKey(),e=0,f=b.length;e<f;e++){if(typeof b[e][d]=="undefined"){cube.indicate("warning",cube.msg("SET_PRIMARYKEY"));break}a.isRadio()&&cube.notEmpty(c)&&c==String(b[e][d])?a._selectedItems.indexOf(b[e])==-1&&a._selectedItems.push(b[e]):cube.notEmpty(c)&&cube.isArray(c)&&c.indexOf(String(b[e][d]))!=-1?a._selectedItems.indexOf(b[e])==-1&&a._selectedItems.push(b[e]):a._selectedItems.remove(b[e])}if(b.length>0){a._selectedAllSub.dispose();a._selectedItems().length==b.length?a._selectedAll(!0):
a._selectedAll(!1);a._selectedAllSub=cube.subscribe(a._selectedAll,a.chkboxAllClick);if(a.onSelectedItems!=null&&!cube.isObservable(a.onSelectedItems))a.onSelectedItems(a._selectedItems());if(a.onSelectedIds!=null&&!cube.isObservable(a.onSelectedIds))a.onSelectedIds(a._selectedIds())}};a.chkboxAllClick=function(){a._selectedIdsSub.dispose();for(var c=a._selectedIds(),b=a.items(),d=a.primaryKey(),e=0,f=b.length;e<f;e++){if(typeof b[e][d]=="undefined"){cube.indicate("warning",cube.msg("SET_PRIMARYKEY"));
break}a._selectedAll()?c.indexOf(String(b[e][d]))==-1&&a.checkboxVisible(b[e])&&(a._selectedIds.push(String(b[e][d])),a._selectedItems.push(b[e])):(a._selectedIds.shift(),a._selectedItems.shift())}if(a.onSelectedItems!=null&&!cube.isObservable(a.onSelectedItems))a.onSelectedItems(a._selectedItems());if(a.onSelectedIds!=null&&!cube.isObservable(a.onSelectedIds))a.onSelectedIds(a._selectedIds());a._selectedIdsSub=cube.subscribe(a._selectedIds,a.chkboxClick)};a.setSelectedItem=function(c,b){if(a._isEdited()&&
a._selectedItem()!=c){if(!a.validate(1))return;if(a.onItemEditing!=null&&!cube.isObservable(a.onItemEditing))a.onItemEditing(c,b);for(var d in a._editedItem)d!="mxVirtualId"&&j.setValue(a._editedItemObj,d,a._editedItem[d]());a.replaceItem(a._editedItemIndex,a._editedItemObj);var e={},f={};for(d in c)e[d]=cube.obj(c[d]),f[d]=c[d];a._editedItem=e;a._editedItemObj=f;a._editedItemIndex=b}a._selectedItem(c);if(a.onSelectedItem!=null&&!cube.isObservable(a.onSelectedItem))a.onSelectedItem(c)};a.replaceItem=
function(c,b){cube.isNumber(c)?a.items.replace(a.items()[a._editedItemIndex],b):a.items.replace(c,b)};a.cancelSelectedItem=function(){a._selectedItem(null)};a.dblclick=function(c){if(a.onDblClick!=null&&!cube.isObservable(a.onDblClick))a.onDblClick(c)};a.delItem=function(c){cube.indicate("confirm",cube.msg("CONFIRM_DELETE"),function(){if(a.onItemDeleting!=null&&!cube.isObservable(a.onItemDeleting)){var b={cancel:!1,data:c};a.onItemDeleting(b);if(b.cancel)return}var d=c[a.primaryKey()];cube.isObservable(d)&&
(d=d());if(d&&a.autoDelete())j.ondeleted=function(b,f){a.items.remove(c);a._selectedIds.remove(d);if(a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c,f);a.refreshDeleted()&&a.load()},j.remove(d,c);else if(a.items.remove(c),a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c);a.itemsChange()})};a.delSelectedItem=function(){cube.indicate("confirm",cube.msg("CONFIRM_DELETE"),function(){var c=a._selectedItem();if(c!=null){if(a.onItemDeleting!=null&&
!cube.isObservable(a.onItemDeleting)){var b={cancel:!1,data:c};a.onItemDeleting(b);if(b.cancel)return}var d=c[a.primaryKey()];if(d&&a.autoDelete())j.ondeleted=function(b,f){a.items.remove(c);a._selectedIds.remove(d);if(a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c,f);a.refreshDeleted()&&a.load()},j.remove(d);else if(a.items.remove(c),a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c);a.itemsChange()}})};a.delCheckedItem=function(){cube.indicate("confirm",
cube.msg("CONFIRM_DELETE"),function(){var c=a._selectedIds();if(a.onItemDeleting!=null&&!cube.isObservable(a.onItemDeleting)){var b={cancel:!1,data:c};a.onItemDeleting(b);if(b.cancel)return}if(a.autoDelete())j.ondeleted=function(b,e){for(var f=0;f<c.length;f++)a.items.remove(s.getItem(a.items(),a.primaryKey(),c[f]));if(a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c,e);a.refreshDeleted()&&a.load()},j.remove(c);else{for(b=0;b<c.length;b++)a.items.remove(s.getItem(a.items(),
a.primaryKey(),c[b]));if(a.onItemDeleted!=null&&!cube.isObservable(a.onItemDeleted))a.onItemDeleted(c)}a._selectedIds([]);a.itemsChange()})};a.editItem=function(c,b){if(a._isEdited()&&a._selectedItem()!=c){if(!a.validate(1))return;for(var d in a._editedItem)d!="mxVirtualId"&&j.setValue(a._editedItemObj,d,a._editedItem[d]());a.replaceItem(a._editedItemIndex,a._editedItemObj)}if(a.onItemEditing!=null&&!cube.isObservable(a.onItemEditing))a.onItemEditing(c,b);var e={},f={};for(d in c)d==a.primaryKey()&&
c[d]==null||(e[d]=cube.obj(c[d]),f[d]=c[d]);(d=a.columns())&&d.length>0&&$.each(d,function(b,d){if(d.editorType=="FileEditor")d.pkVal&&cube.isObservable(d.pkVal)?d.pkVal(c[a.primaryKey()]):d.pkVal=cube.obj(c[a.primaryKey()])});a._editedItemIndex=b;a._editedItem=e;a._editedItemObj=f;a._isEdited(!0);a._selectedItem(c)};a.shiftupItem=function(){var c=a.items.indexOf(this);c>0&&(a.items.splice(c,1),a.items.splice(c-1,0,this))};a.shiftdownItem=function(){var c=a.items.indexOf(this);c<a.items().length-
1&&(a.items.splice(c,1),a.items.splice(c+1,0,this))};a.saveItem=function(c){if(a.validate(1)){if(a.autoSave()){if(a.isAllEdited())for(var b in c)b!="mxVirtualId"&&j.setValue(c,b,cube.isObservable(c[b])?c[b]():c[b]);else for(b in a._editedItem)b!="mxVirtualId"&&j.setValue(a._editedItemObj,b,a._editedItem[b]());if(a.onItemSaving!=null&&!cube.isObservable(a.onItemSaving)&&(c={cancel:!1,data:a._editedItemObj},a.onItemSaving(c),c.cancel))return;j.onsaved=function(b){if(typeof a._editedItemObj[a.primaryKey()]==
"undefined"&&b.result.newData.length>0){if(a.isAllEdited()||a.replaceItem(a._editedItemIndex,b.result.newData[0]),a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(b.result.newData[0])}else if(a.isAllEdited()||a.replaceItem(a._editedItemIndex,a._editedItemObj),a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(a._editedItemObj)};j.save()}else{var d={};if(a.isAllEdited())for(b in c)b!="mxVirtualId"&&(d[b]=cube.isObservable(c[b])?c[b]():c[b]);else for(b in a._editedItem)b!=
"mxVirtualId"&&(d[b]=a._editedItem[b]());if(a.onItemSaving!=null&&!cube.isObservable(a.onItemSaving)&&(c={cancel:!1,data:d},a.onItemSaving(c),c.cancel))return;a.isAllEdited()||a.replaceItem(a._editedItemIndex,d);if(a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(d)}a._isEdited(!1);a._editedItem=null;a._selectedItem(null)}};var k=null;a.saveAppend=function(c,b){if(a.validate(0)){k==null&&(k=j.create());if(a.isAllEdited()){var d=a._editorValid(),e=d.length;d[e]={}}for(var f in a._appendedItem)if(!(f==
"mxVirtualId"||f==a.primaryKey()))if(k[f]=a._appendedItem[f](),a.isAllEdited()){var i={validStatus:cube.obj(""),validHint:cube.obj("")};d[e][f]=i}if(c&&cube.isArray(c))for(d=0;d<c.length;d++)for(f in c[d])f=="mxVirtualId"||f==a.primaryKey()||(k[f]=c[d][f]);if(a.autoSave()||b===!0){if(a.onItemSaving!=null&&!cube.isObservable(a.onItemSaving)&&(d={cancel:!1,data:k},a.onItemSaving(d),d.cancel))return;for(f in k)f!=a.primaryKey()&&j.setValue(k,f,k[f]);j.onsaved=function(b){for(var c=0;c<b.result.newData.length;c++)a.items.push(b.result.newData[c]);
var b=!1,c=a.columns(),d;for(d in a._appendedItem){for(var e=0;e<c.length;e++)if(d==c[e].name&&typeof c[e].value!="undefined"){cube.isObservable(c[e].value)?(a._appendedItem[d]=c[e].value,a._appendedItemObj[d]=c[e].value()):(a._appendedItem[d](c[e].value),a._appendedItemObj[d]=c[e].value);b=!0;break}b||(a._appendedItem[d](null),a._appendedItemObj[d]=null,b=!1);delete a._appendedItem.mxVirtualId;delete a._appendedItem[a.primaryKey()]}if(a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(k);
k=null};j.save()}else{if(a.onItemSaving!=null&&!cube.isObservable(a.onItemSaving)&&(d={cancel:!1,data:k},a.onItemSaving(d),d.cancel))return;a.items.push(k);d=!1;e=a.columns();for(f in a._appendedItem){for(i=0;i<e.length;i++)if(f==e[i].name&&typeof e[i].value!="undefined"){cube.isObservable(e[i].value)?(a._appendedItem[f]=e[i].value,a._appendedItemObj[f]=e[i].value()):(a._appendedItem[f](e[i].value),a._appendedItemObj[f]=e[i].value);d=!0;break}d||(a._appendedItem[f](null),a._appendedItemObj[f]=null,
d=!1);delete a._appendedItem.mxVirtualId;delete a._appendedItem[a.primaryKey()]}if(a.onItemSaved!=null&&!cube.isObservable(a.onItemSaved))a.onItemSaved(k);k=null}a._isEdited(!1);a._editedItem=null;a._selectedItem(null)}};a.cancelSaveItem=function(){a._isEdited(!1);a._editedItem=null;a._selectedItem(null);for(var c=a.columns(),b=0;b<c.length;b++)c[b].validStatus("")};a.appendItem=function(c){if(a.isAllEdited()||a.validate(0)){var b={},d=!1,e=a.columns();if(a.isAllEdited()){var f=a._editorValid(),i=
f.length;f[i]={}}var h=a._appendedItem;cube.notEmpty(c)&&(h=c);var c=0,g;for(g in h){c++;b[g]=a.isAllEdited()?cube.obj(cube.isObservable(h[g])?h[g]():h[g]):cube.isObservable(h[g])?h[g]():h[g];if(a.isAllEdited()){var j={validStatus:cube.obj(""),validHint:cube.obj("")};f[i][g]=j}for(j=0;j<e.length;j++)if(g==e[j].name&&typeof e[j].value!="undefined"){cube.isObservable(e[j].value)?(a._appendedItem[g]=e[j].value,a._appendedItemObj[g]=e[j].value()):(a._appendedItem[g](e[j].value),a._appendedItemObj[g]=
e[j].value);d=!0;break}if(!d){if(cube.notEmpty(a._appendedItem[g])&&cube.isObservable(a._appendedItem[g]))a._appendedItem[g](null);cube.notEmpty(a._appendedItemObj[g])&&(a._appendedItemObj[g]=null);d=!1}}if(c==0)(d=a._columns)&&d.length>0&&$.each(d,function(){b[this.name]=typeof this.value!="undefined"?cube.isObservable(this.value)?this.value:cube.obj(this.value):cube.obj(null);if(a.isAllEdited()){var c={validStatus:cube.obj(""),validHint:cube.obj("")};f[i][this.name]=c}});a.items.push(b);a.itemsChange()}};
a.sortType=cube.obj(-1);a.sortName=cube.obj("");a.sortGrid=function(c,b){var d=null,d=cube.notEmpty(c)?c.name!=void 0?c.name:c:a.sortName();a.sortName(d);a.items.sort(function(c,f){var i=cube.isObservable(c[d])?c[d]():c[d],h=cube.isObservable(f[d])?f[d]():f[d];if(i==null&&h==null)return 0;else if(i==null&&h!=null)return b==!0?1:b==!1?-1:a.sortType()==1?-1:1;else if(i!=null&&h==null)return b==!0?-1:b==!1?1:a.sortType()==1?1:-1;!isNaN(i)&&!isNaN(h)?(i=Number(i),h=Number(h)):(i=t.convertPinyin(i),h=
t.convertPinyin(h));var g=null;return g=b==!0?i==h?0:i<h?-1:1:b==!1?i==h?0:i<h?1:-1:i==h?0:i<h?a.sortType():a.sortType()*-1});b==!0?a.sortType(1):b==!1?a.sortType(-1):a.sortType(a.sortType()*-1)};var p=!1,q=!1,y=0,z=0,A,B,r;a.mousedown=function(c,b,d,e){if(a.isAllowAdjustColumn()&&p)q=!0,y=d.clientX,z=$(c).width(),A=$(c),B=c.cellIndex,r=e,a.$tableBody.find("table>tbody>tr>td:eq("+B+")")};a.mouseup=function(){a.isAllowAdjustColumn()&&(q=!1,a.itemsChange())};a.mousemove=function(c,b){if(a.isAllowAdjustColumn()&&
(b.offsetX>$(c).width()-10?(c.style.cursor="e-resize",p=!0):(c.style.cursor="default",p=!1),q)){var d=z+(b.clientX-y);d<20&&(d=20);A.width(d+"px");if(r!=-1){var e=a.columns()[r],f=e.width();!a.isShowTempColumn()&&n==0&&a.isShowTempColumn(!0);(f=="auto"||cube.isString(f)&&f.indexOf("%")!=-1)&&n--;e.width(d+"px")}}};a.onCurrentPageIndexChanged=function(){a._selectedAll(!1);a.sortName("");a._indexNotLoad()||a.load()};a.itemsChange=function(){a.$tableBody[0]&&a.$tableBody[0].scrollHeight>a.$tableBody[0].clientHeight?
(a._headerOperationsColumnWidth(parseInt(x)+(a.isAllowOperations()?17:6)+"px"),a._hasVScroll(!0)):(a._headerOperationsColumnWidth(a.operationsColumnWidth()),a._hasVScroll(!1))};a.load=function(c){a.isShowLoading(!0);w=(new Date).getTime();a._selectedItem(null);a._selectedIds([]);a._selectedItems.removeAll();var b=null;cube.notEmpty(c)&&$.isPlainObject(c)&&(b=c);var d={metaParams:null,dataParams:null};if(cube.notEmpty(b))cube.isEmpty(b.metaParams)&&cube.isEmpty(b.dataParams)?d.dataParams=b:d=$.extend(d,
b);var e=!1;if(cube.notEmpty(c)&&cube.notEmpty(c.isSearchLoad))e=c.isSearchLoad,delete c.isSearchLoad;b="";if(cube.notEmpty(c)&&cube.notEmpty(c.filter))b=c.filter;else if(b=cube.clone(c))delete b.pageIndex,delete b.pageSize;var c=null,c=cube.isObservable(a.args)?a.args():a.args,f=null,i=null;if(a.searchBoxId()&&(i=cube.getPageViewModelByNode($("#"+a.searchBoxId()))))if(f=cube.isObservable(i._params)?i._params():i._params,!e||!f)f=i.searchParamType()=="json"?i.getJsonSearchParam():i.getSearchParam();
if(i&&i.searchParamType()=="json"){if(f.length>0){if(cube.isArray(c))for(var h=0;h<c.length;h++)f.push(c[h]);else f.push(c);if(cube.isArray(b))for(h=0;h<b.length;h++)f.push(b[h]);else f.push(b)}else f=c;b=f}else{i=e="";if($.isPlainObject(b)){for(h in b)var g=b[h],i=i+"&"+h+"="+(cube.isObservable(g)?g():g);b=i}if($.isPlainObject(c)){for(h in c)g=c[h],e=e+"&"+h+"="+(cube.isObservable(g)?g():g);cube.notEmpty(b)?b+=e:b=e.substring(1,e.length)}else cube.isString(c)&&(b=cube.notEmpty(b)?b+"&"+c:c);if($.isPlainObject(f)){for(h in f)g=
f[h],e=e+"&"+h+"="+(cube.isObservable(g)?g():g);cube.notEmpty(b)?b+=e:b=e.substring(1,e.length)}else cube.isString(f)&&(b=cube.notEmpty(b)?b+"&"+f:f)}if(cube.notEmpty(b))d.dataParams=$.extend({filter:b},d.dataParams);if(a.loadMeta()&&cube.notEmpty(a._columns))b="",b=a._getColunmsNames().join(","),h={columns:b},d.metaParams=$.extend({columns:b},d.metaParams),d.dataParams=$.extend(h,d.dataParams);d.dataParams&&cube.notEmpty(d.dataParams.pageIndex)&&d.dataParams.pageIndex!=a.pageIndex()&&(a._indexNotLoad(!0),
a.pageIndex(d.dataParams.pageIndex),a._indexNotLoad(!1));b={};a.isAllowPaging()&&(b={pageIndex:parseInt(a.pageIndex()),pageSize:parseInt(a.pageSize())});d.dataParams=$.extend(b,d.dataParams);j.load(d)};a._getColunmsNames=function(){for(var c=[],b=0;b<a._columns.length;b++)u(c,a._columns[b]);return c};a.print=function(){D.print(a.items,a.columns,a.dicts,"datagrid")};a.save=function(c){var b=null,d=a.items(),e=a.primaryKey();if(d.length>0){for(var f=0;f<d.length;f++){var i=d[f];if(i!=null){var h=cube.isObservable(d[f][e])?
d[f][e]():d[f][e];if(h){if(b={},b[e]=h,a._editedItem&&a._editedItem[e]&&i[e]==a._editedItem[e]())i=a._editedItem}else b=j.create();if(a.isAllEdited())for(var g in i)g=="mxVirtualId"||g==e||(b[g]=cube.isObservable(i[g])?i[g]():i[g]);else if(cube.isObservable(a._appendedItemObj))for(g in i)g=="mxVirtualId"||g==e||(b[g]=cube.isObservable(i[g])?i[g]():i[g]);else for(g in a._appendedItemObj)g=="mxVirtualId"||g==e||(b[g]=a._appendedItemObj[g]);if(c&&cube.isArray(c))for(h=0;h<c.length;h++)for(g in c[h])g==
"mxVirtualId"||g==e||(b[g]=c[h][g]);if(a.validate(b,f))for(g in b)g=="mxVirtualId"||g==e||(cube.isFunction(i[g])?j.setValue(b,g,b[g]!=null?b[g]:i[g]()):j.setValue(b,g,b[g]!=null?b[g]:i[g]));else return}}if(a.onSaving!=null&&!cube.isObservable(a.onSaving)){c=[];for(g in j._changedItems)c.push(j._changedItems[g]);g={cancel:!1,data:c};a.onSaving(g);if(g.cancel)return}j.onsaved=function(b){if(b.p_result.resultValue.items){if(!a.isAllEdited())for(var c=0;c<d.length;c++)a.replaceItem(d[c],b.p_result.resultValue.items[c]);
if(a.onSaved!=null&&!cube.isObservable(a.onSaved))a.onSaved(b.p_result.resultValue.items)}};j.save()}else a.saveAppend(c,!0);a._isEdited(!1);a._editedItem=null;a._selectedItem(null)};a.importExcel=function(c,b,d,e){for(var f=[],i=[],h=a.columns(),g=0;g<h.length;g++)f.push({value:h[g].name,text:h[g].caption}),i.push(h[g].name);typeof d!="undefined"&&cube.isArray(d)&&(e=d,d=!0);cube.showDialog({title:cube.msg("IMPORT_EXCEL"),templateOptions:{name:"exceltmpl",params:{columns:f,columnNames:e,value:i.join(),
importExcelUrl:c,previewGridBaseUrl:a.url(),confirmBtnClick:b,showOption:d}},confirmBtnText:cube.msg("SAVE"),closeBtnText:cube.msg("CANCEL"),onConfirmBtnClick:function(a){if(!a.result)a.cancel=!0},customBtns:[{text:cube.msg("PREVIOUS"),visible:cube.obj(!1),click:function(a){a.step(1);this.visible(!1);a.customBtns()[1].visible(!0)}},{text:cube.msg("NEXT"),visible:cube.obj(!1),click:function(a){a.step(2);this.visible(!1);a.customBtns()[0].visible(!0)}}]})};a.exportExcel=function(c,b,d,e){l.setBaseUrl(c);
l.setParams(b);d===!0&&l.setIds(a._selectedIds());e==!0&&l.setType("post");l.exportExcel()};var n=0;a.initColumn=function(c){var b=a.columns();if(b&&b.length>0){for(var d=0;d<b.length;d++){var e=b[d];if(cube.isEmpty(e))return!0;if(typeof e.validStatus=="undefined")e.validStatus=cube.obj("");else if(!cube.isObservable(e.validStatus))e.validStatus=cube.obj(e.validStatus);if(typeof e.validHint=="undefined")e.validHint=cube.obj("");else if(!cube.isObservable(e.validHint))e.validHint=cube.obj(e.validHint);
if(typeof e.align=="undefined")e.align="";if(typeof e.width=="undefined")e.width=cube.obj(a.columnDefaultWidth()),n++;else if(!cube.isObservable(e.width))cube.notEmpty(e.width)&&(e.width=="auto"||cube.isString(e.width)&&e.width.indexOf("%")!=-1)&&n++,e.width=cube.obj(e.width);if(!e.editorType)e.editorType="TextEditor";if(e.editorType=="DropDownEditor"||e.editorType=="CheckListEditor"||e.editorType=="ListEditor"||e.editorType=="LabelEditor"){if(c&&c.dicts&&c.dicts[e.name])e.list=c.dicts[e.name]}else if(e.editorType==
"FileEditor")if(e.pkVal){if(!cube.isObservable(e.pkVal))e.pkVal=cube.obj(e.pkVal)}else e.pkVal=cube.obj(null)}n==0&&a.isShowTempColumn(!0)}};a.validate=function(c,b){var d=null,e=null;c==1?(d=a._editedItem,e=a.columns()):c==0?(d=a._appendedItem,e=a.appendColumns):(d=c,e=a.columns());for(var f=0;f<e.length;f++)if(e[f].validStatus&&typeof e[f].validStatus=="function"&&e[f].validStatus()!="")return!1;else if(d!=null)for(var i in d)if(e[f].name==i&&e[f].nullable==!1){var h=cube.isObservable(d[i])?d[i]():
d[i],h=E.validate(h,"NOTNULL",{});if(h.successful)a.isAllEdited()?(g=a._editorValid()[b][i],g.validStatus(""),g.validHint("")):(e[f].validStatus(""),e[f].validHint(""));else{if(a.isAllEdited()){var g=a._editorValid()[b][i];g.validStatus("error");g.validHint(h.hint)}else e[f].validStatus("error"),e[f].validHint(h.hint);return!1}break}return!0};a._editor_changed=function(c,b,d){var e=a.columns(),f=a.items()[d];e&&e.length>0&&$.each(e,function(a,d){if(d.onChanged)return d.onChanged(c,b,f),!0})};a._editor_upload=
function(c,b){if(a._editedItem!=null&&!cube.isObservable(a._editedItem))a._editedItem[c](b)};a._parseDate=function(a,b){if(cube.notEmpty(a)){cube.isString(a)||(a=String(a));var d=new Date(a.replace(/-/g,"/"));F.isDigit(a)&&(cube.isEmpty(b)&&(b="yyyy-MM-dd HH:mm:ss"),a.length==10&&(a+="000"),a.length==13&&(d=new Date(parseInt(a))));cube.isEmpty(b)?b=a:(b=b.replace(/yyyy/g,d.getFullYear()),b=b.replace(/MM/g,m(d.getMonth()+1,"00")),b=b.replace(/dd/g,m(d.getDate(),"00")),b=b.replace(/HH/g,m(d.getHours(),
"00")),b=b.replace(/mm/g,m(d.getMinutes(),"00")),b=b.replace(/ss/g,m(d.getSeconds(),"00")))}else b=a;return b};a.checkboxVisible=function(c){var b=a.checkboxHideCondition(),d=!0;if(cube.isEmpty(b))return!0;else if(typeof b=="boolean")return b;else if(cube.isArray(b))for(var e=0;e<b.length;e++){if(d=a._checkCondition(c,b[e]),!d)break}else d=a._checkCondition(c,b);return!d};a.customOperationsVisible=function(c,b){var d=!0;if(cube.isEmpty(b))d=!0;else if(typeof b=="boolean")return b;else if(cube.isObservable(b)&&
typeof b()=="boolean")return b();else if(cube.isArray(b))for(var e=0;e<b.length;e++){if(d=a._checkCondition(c,b[e]),!d)break}else d=a._checkCondition(c,b);return d};a._checkCondition=function(a,b){var d=!1;switch(b.operation){case "==":d=a[b.column]==b.value;break;case "!=":d=a[b.column]!=b.value;break;case ">":d=a[b.column]>b.value;break;case "<":d=a[b.column]<b.value;break;case ">=":d=a[b.column]>=b.value;break;case "<=":d=a[b.column]<=b.value;break;case "in":cube.isArray(b.value)&&b.value.indexOf(a[b.column])!=
-1&&(d=!0)}return d};a.renderCell=function(c,b,d,e){cube.isObservable(c)&&(c=c());var f="",i=!1,h="",g=a._dictsKeyValue();if(d.renderCell)cube.notEmpty(g)&&cube.notEmpty(g[d.name])&&(h=g[d.name][c],typeof h=="undefined"&&(h="")),f=d.renderCell(c,b,h,e,d),f==null?f=cube.notEmpty(h)?h:c:i=!0;else if(cube.notEmpty(g)&&cube.notEmpty(g[d.name]))f=g[d.name][c],typeof f=="undefined"&&(f=c);else if(cube.notEmpty(d.list)){e=[];e=cube.isObservable(d.list)?d.list():d.list;for(h=0;h<e.length;h++)if(e[h].value==
c){f=e[h].text;break}}else if(typeof d.editorType!="undefined"&&d.editorType=="DateTimeEditor")f=a._parseDate(c,d.format);else if(f=c,e=$(b),typeof d.displayLength!="undefined"&&cube.notEmpty(f)?(f=String(f),f.length>d.displayLength&&(f=f.substring(0,d.displayLength)+"...")):typeof d.displayRow!="undefined"&&cube.notEmpty(f)&&(f=String(f),h=e.width(),g=parseInt(e.css("fontSize")),h=parseInt(h/g*d.displayRow)-3,f.length>h&&(f=f.substring(0,h)+"...")),typeof d.displayRow!="undefined"||typeof d.displayLength!=
"undefined")e.css("white-space","normal"),e.css("word-break","break-all");e=a.trBackground();if(e!=null&&d.name==e.column){h=!1;switch(e.operation){case "==":h=c==e.value;break;case "!=":h=c!=e.value;break;case ">":h=c>e.value;break;case "<":h=c<e.value;break;case ">=":h=c>=e.value;break;case "<=":h=c<=e.value;break;case "in":cube.isArray(e.value)&&e.value.indexOf(c)!=-1&&(h=!0)}h&&$(b).parent().css("background",e.background)}f&&(f=String(f),f=a.scriptProcessing()=="clean"||i?cube.cleanScript(f):
cube.escapeString(f,typeof d.isAllowAutowrap!="undefined"?d.isAllowAutowrap:a.isAllowAutowrap()));return f};a.renderMarkCell=function(c,b){var d="",d=a.markColumn();return d=d.renderCell?d.renderCell(c,b):d.value};a.mouseenter=function(c,b,d,e){if(typeof d.onMouseenter=="function")d.onMouseenter(c,b);var b=String(b),c="",f=a._dictsKeyValue();cube.notEmpty(f)&&cube.notEmpty(f[d.name])&&(c=f[d.name][b],typeof c=="undefined"&&(c=""));b=cube.notEmpty(c)?c:b;typeof d.editorType!="undefined"&&d.editorType==
"DateTimeEditor"&&(b=a._parseDate(b,d.format));if(f=b)b=String(b),a.scriptProcessing()=="clean"?f=b=cube.cleanScript(b):b=cube.escapeString(b,typeof d.isAllowAutowrap!="undefined"?d.isAllowAutowrap:a.isAllowAutowrap());c=(a.isAllowAutowrap()==!1||d.isAllowAutowrap==!1)&&e.scrollWidth>e.clientWidth;if((typeof d.displayLength!="undefined"||typeof d.displayRow!="undefined"||c)&&cube.notEmpty(b))if(a.isShowTips()){f=d.displayLength;if(typeof d.displayRow!="undefined")var f=$(e).width(),i=parseInt($(e).css("fontSize")),
f=parseInt(f/i*d.displayRow)-3;if(b.length>f||c)a.showCellPopDialog(!0),cube.showPopDialog(e,{popoverDirection:"top",content:b.replace(/\n/g,"<br/>"),isShowDialog:a.showCellPopDialog})}else $(e).attr("title",f)};a.mouseleave=function(c,b,d){if(typeof d.onMouseleave=="function")d.onMouseleave(c,b);a.showCellPopDialog(!1)};a.getEditorParam=function(c,b,d){var e=cube.clone(c);if(c.editorType=="FileEditor"){if(e.onChanged=a._editor_upload,e.type="grid",e.previewSize="small",b)e.pkVal=b[a.primaryKey()]}else e.onChanged=
a._editor_changed;if(typeof c.align!="undefined")e.textAlign=c.align;if(typeof c.isExtDisplay=="undefined")e.isExtDisplay=!0;if(typeof c.appendEditorType!="undefined")e.editorType=c.appendEditorType;else if(typeof c.editorType=="undefined")e.editorType="TextEditor";e.width=c.editorType=="DateTimeEditor"?"65%":c.editorType=="DropDownEditor"?"auto":c.editorType=="NumberEditor"?"40%":"85%";if(cube.notEmpty(b))if(a.isAllEdited()){if(a._editorValid().length>0)e.validStatus=a._editorValid()[d][c.name].validStatus,
e.validHint=a._editorValid()[d][c.name].validHint;e.value=b[c.name]}else e.value=a._editedItem[c.name];else e.value=a._appendedItem[c.name];e.itemIndex=d;if(c.editorType=="CheckEditor"||c.editorType=="CheckListEditor")e.name=c.name+d;return e};a.openSubGrid=function(c){a.subGridId()==c[a.primaryKey()]?a.subGridId(null):a.subGridId(c[a.primaryKey()]);setTimeout(function(){a.itemsChange()},300)};a.appendCustomClick=function(c){if(cube.isFunction(c.click)){var b={},d;for(d in a._appendedItem)d=="mxVirtualId"||
d==a.primaryKey()||(b[d]=a._appendedItem[d]());c.click(b)}};a.customOperationsClick=function(a,b,d){b.click(a,d)};a.onload=function(c){var b=$(c);a.$tableBody=b.find(".tableBody");a.$tableHeader=b.find(".tableHeader");a.$tableBody.scroll(function(b){a.$tableHeader.css("left",0-b.target.scrollLeft)});a.itemsChange();b=a.watermarkOptions();if(cube.notEmpty(b)&&cube.notEmpty(b.text)){b=$.extend(a._watermarkOptionsDefaultValue(),b);b.indent=(parseInt(b.width)+parseInt(b.xSpace))/2;a.watermarkOptions(b);
for(var d=parseInt((a.$tableBody.height()-b.y)/(parseInt(b.height)+parseInt(b.ySpace)))+1,e=0;e<d;e++)a.watermarkRows.push({y:b.y+(parseInt(b.height)+parseInt(b.ySpace))*e});d=parseInt((a.$tableBody.width()-b.x)/(parseInt(b.width)+parseInt(b.xSpace)))+1;for(e=0;e<d;e++)a.watermarkCols.push({x:b.x+(parseInt(b.width)+parseInt(b.xSpace))*e})}if(a.onRendered!=null&&!cube.isObservable(a.onRendered))a.onRendered(c)};cube.endViewModel(a,o)}cube.importComponent("editor.commoneditor");cube.importComponent("editor.datetimeeditor");
cube.importComponent("editor.dropdowneditor");cube.importComponent("datacontainer.pagenavibar");cube.importComponent("datacontainer.exceltmpl");cube.importComponent("controls.loading");o.prototype.dispose=function(){this.pageSizeSub.dispose();this.argsSub.dispose();this._selectedIdsSub.dispose();this._selectedAllSub.dispose();this.actionsSub.dispose();this.dictsSub.dispose();this.selectedIdsSub.dispose()};return o});