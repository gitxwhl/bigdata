define(["../datagrid/datagrid.js","entityContainer"],function(n,o){function m(l){l._lazyInit=!0;n.call(this,l);var g={},a=this;a.treeField=null;a.expanded=!1;a.parentItem=null;var c=new o;g._init=a._init;a._init=function(){g._init();c.primaryKey=a.primaryKey();c.actions=a.actions();c.type="grid";c.timeout=a.timeout();c.dicts=a.dicts();c.loadMeta=!1;c.customHeaders=a.customHeaders();c.loadByPost=a.loadByPost();c.init()};g.editItem=a.editItem;a.editItem=function(i,f,b){g.editItem(i,f);a.parentItem=
b};g.setSelectedItem=a.setSelectedItem;a.setSelectedItem=function(i,f,b){g.setSelectedItem(i,f);if(a._isEdited())a.parentItem=b};a.appendItem=function(i,f){var b=null,e=a._selectedItems();cube.notEmpty(e)&&cube.isArray(e)&&e.length>0&&(b=e[0]);if(a.isAllEdited()||a.validate(0)){var c={},e=!1,j=a.columns();if(a.isAllEdited()){var g=a._editorValid(),l=g.length;g[l]={}}var k=a._appendedItem;cube.notEmpty(i)&&!cube.isBoolean(i)&&(k=i);var m=0,d;for(d in k){m++;c[d]=a.isAllEdited()?cube.obj(cube.isObservable(k[d])?
k[d]():k[d]):cube.isObservable(k[d])?k[d]():k[d];if(a.isAllEdited()){var h={validStatus:cube.obj(""),validHint:cube.obj("")};g[l][d]=h}for(h=0;h<j.length;h++)if(d==j[h].name&&typeof j[h].value!="undefined"){cube.isObservable(j[h].value)?(a._appendedItem[d]=j[h].value,a._appendedItemObj[d]=j[h].value()):(a._appendedItem[d](j[h].value),a._appendedItemObj[d]=j[h].value);e=!0;break}if(!e){if(cube.notEmpty(a._appendedItem[d])&&cube.isObservable(a._appendedItem[d]))a._appendedItem[d](null);cube.notEmpty(a._appendedItemObj[d])&&
(a._appendedItemObj[d]=null);e=!1}}if(m==0)(e=a._columns)&&e.length>0&&$.each(e,function(){c[this.name]=typeof this.value!="undefined"?cube.isObservable(this.value)?this.value:cube.obj(this.value):cube.obj(null);if(a.isAllEdited()){var b={validStatus:cube.obj(""),validHint:cube.obj("")};g[l][this.name]=b}});cube.notEmpty(b)?(c.parentId=b[a.primaryKey()],b.items.push(c)):a.items.push(c);if(cube.notEmpty(f)&&f===!0){b={};for(d in c)b[d]=cube.obj(c[d]);a._isEdited(!0);a._editedItem=b;a._selectedItem(c)}a.itemsChange()}};
a.loadChildren=function(i){var f=i[a.primaryKey()],b=a.url();b.lastIndexOf("/")!=b.length-1&&(b+="/");c.setBaseUrl(b+f+"/children");c.onload=function(a){i.items(a.items)};c.load()};a.shiftupItem=function(c,f){var b=a.items;if(a.parentItem!=null)b=f.items;var e=b.indexOf(c);e>0&&(b.splice(e,1),b.splice(e-1,0,c))};a.shiftdownItem=function(c,f){var b=a.items;if(a.parentItem!=null)b=f.items;var e=b.indexOf(c);e<b().length-1&&(b.splice(e,1),b.splice(e+1,0,c))};a.replaceItem=function(c,f){var b=a.items;
if(a.parentItem!=null)b=a.parentItem.items;b&&(cube.isNumber(c)?b.replace(b()[a._editedItemIndex],f):b.replace(a._editedItemObj,f))};cube.endViewModel(a,l)}cube.importComponent("datacontainer.treegriditem");m.prototype.dispose=function(){};return m});