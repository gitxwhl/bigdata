define(["cropper","FileUploader","text!croppercss"],function(t,l){return function(u){function n(){var b=o();b.open("post",a.url(),!1);b.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");b.send("option=getProgress&sessionId="+h+"&rnd="+cube.random());if(b.status==200&&(b=b.responseText.replace("&","&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/script/gi,"").replace(/%/g,"&#37").replace(/\r/g,"").replace(/\n/g,
""))){var c=b.split(":");if(c[0]==-2)throw a.status(cube.msg("UPLOADFAIL")),"error";else if(c[0]==-3)throw a.status(cube.msg("UPLOADFAIL")),"error";else if(c[0]==-4)throw a.status(cube.msg("UPLOADFAIL")),"error";else if(c[0]==-5)throw a.status(cube.msg("UPLOADFAIL")),"error";b=parseInt(b,10);if(isNaN(b))throw"error";if(b!=-1)try{window.setTimeout(function(){n()},500)}catch(d){}else b==-1&&(a.status(cube.msg("UPLOADED")),a.uploaded(!0))}}function o(){var a=null;window.ActiveXObject?a=new ActiveXObject("Microsoft.XMLHTTP"):
window.XMLHttpRequest&&(a=new XMLHttpRequest);return a}function p(b,c){if(typeof FileReader=="function"){a.isIE(!1);var d=null,e=b.files,g=null;e&&(g=e[0]);g?/^image\/\w+$/.test(g.type)?(d=new FileReader,d.onload=function(){a.hasImage(!0);a.editable(!0);a.imageType(g.type);a.name(g.name);a.imageUrl(d.result);c()},d.readAsDataURL(g)):(a.status(cube.msg("SELECTPICTURE")),c()):c()}else{a.isIE(!0);a.editable(!0);var f="";if(window.navigator.userAgent.indexOf("MSIE")>-1)b.select(),$("#_fileSelectionHiddenArea").focus(),
f=document.selection.createRange().text;var h={width:parseInt(a.width()),height:parseInt(a.height())},k=$("#_show_area"),i=$("<div style='margin:0px auto;'>");i.css("filter",a._imgloader(f,"image"));if(v(f))if(navigator.userAgent.indexOf("MSIE 9.0")>-1){var j=document.createElement("div");(document.body||document.documentElement).appendChild(j);with(j.runtimeStyle)filter=a._imgloader(f,"image"),zoom=width=height=1,overflow="scroll",position="absolute",right="9999em",top="-9999em",border=0;setTimeout(function(){var b=
{height:j.offsetHeight,width:j.offsetWidth};j.parentNode.removeChild(j);b=q(h,b);k.html("");i.appendTo(k);i[0].style.filter=a._imgloader(f,"scale");i.width(b.width).height(b.height);a.hasImage(!0);a.name(r(f))},500)}else e=me._getImgSize(f),e=q(h,e),k.html(""),i.appendTo(k),i[0].style.filter=a._imgloader(f,"scale"),i.width(e.width).height(e.height),a.hasImage(!0),a.name(r(f));else a.status(cube.msg("SELECTPICTURE")),c()}}function v(b){if(cube.isEmpty(b))return!1;b=b.split(".");b=b[b.length-1];return(","+
a._allowTypes()+",").indexOf(","+b+",")>-1}function q(b,c){var d={};b.width<c.width||b.height<c.height?(d=b.width/c.width<b.height/c.height?b.width/c.width:b.height/c.height,d={width:c.width*d,height:c.height*d}):d=c;if(d.width==1&&d.height==1)d.width=parseInt(a.width()),d.height=parseInt(a.height());return d}function r(a){a=a.split("\\");a=a[a.length-1];a=a.split("/");return a[a.length-1]}function m(){var b={};if(a.filePath())b.filePath=a.filePath();b.tableName=a.tableName();b.primaryKey=a.primaryKey();
b.pkVal=a.pkVal();b.colName=a.colName();b.uploadMode=a.uploadMode();b.isVirtual=a.isVirtual();b.maxFileSize=a.maxFileSize()*1024;return b}function s(b){var c=null,d=a.type(),b=b.replace(/\+/g,"%2B"),e=a.filePath()?a.filePath().replace(/\+/g,"%2B"):"",g=e?"&filePath="+e:"";if(d=="path")c=encodeURI(encodeURI(a.url()+"?option=download&filePath="+e+"&fileName="+b+"&uploadMode="+a.uploadMode()+"&rnd="+cube.random()));else if(d=="form"||d=="grid")c=encodeURI(encodeURI(a.url()+"?option=download&tableName="+
a.tableName()+"&pkVal="+a.pkVal()+"&colName="+a.colName()+"&fileName="+b+"&uploadMode="+a.uploadMode()+g+"&rnd="+cube.random()));return c}function w(a){for(var a=window.atob(a.split(",")[1]),c=new ArrayBuffer(a.length),d=new Uint8Array(c),e=0;e<a.length;e++)d[e]=a.charCodeAt(e);return new Blob([c],{type:"image/png"})}var a=this;a.id="";a.width=600;a.height=400;a.showToolbar=!0;a.url=null;a.maxFileSize=0;a.type="path";a.filePath=null;a.tableName="";a.primaryKey="";a.pkVal="";a.colName="";a.uploadMode=
"file";a.isVirtual=!1;a.udsParam=null;a.image=null;a.hasImage=!1;a.uploaded=!1;a.status="";a.progress="0%";a.editable=!1;a.imageType="";a.name="";a.imageUrl="";a.originalImageUrl="";a.cropper=null;a.cropping=!1;a.cropped=!1;a.data=null;a.canvasData=null;a.cropBoxData=null;a._allowTypes="jpg,jpeg,gif,png,bmp";a.isIE=!1;a.isOperate=!1;a.isServerImage=!1;a.onRendered=null;a._init=function(){typeof FileReader=="function"?a.isIE(!1):a.isIE(!0);a.data=null;a.canvasData=null;a.cropBoxData=null;a.cropper=
null;cube.isEmpty(a.id())&&a.id("imageForm_"+cube.random().toString().split("&")[0]);var b=new l;b.url=a.url();b.params=m();(b=b.getUploadedFiles())&&b.length>0&&a.name(b[b.length-1].attName);b=a.name();a.type()!="grid"&&cube.isString(b)&&cube.notEmpty(b)&&(a.imageUrl(s(b)),a.hasImage(!0),a.uploaded(!0),a.isServerImage(!0))};a.imageInputChange=function(b,c){p(c.target,function(){c.target.value=""});a.uploaded(!1)};a.dragover=function(a,c){c.preventDefault()};a.drop=function(a,c){var d=c.dataTransfer?
c.dataTransfer:c.originalEvent.dataTransfer;c.preventDefault();p(d,function(){})};a.imageLoad=function(b,c){a.image=c.target;a.hasImage(!0);a.start()};a.remove=function(){if(!a.cropping()){if(a.uploaded()){var b=new l;b.url=a.url();b.params=m();if(!b.removeFile(a.name())){cube.indicate("info",cube.msg("DELETEFAIL"));return}}a.stop();a.editable(!1);a.data=null;a.image=null;a.imageType("");a.name("");a.imageUrl("");a.originalImageUrl("");a.hasImage(!1);a.cropped(!1);a.status("");a.isServerImage(!1)}};
a.stop=function(){if(a.cropper)a.cropper.destroy(),a.cropper=null,a.cropping(!1)};a.clear=function(){a.cropping()&&(a.cropper.clear(),a.cropping(!1))};a.restore=function(){a.imageUrl(a.originalImageUrl());a.cropper.replace(a.originalImageUrl());a.data=a.cropper.getData();a.canvasData=a.cropper.getCanvasData();a.cropBoxData=a.cropper.getCropBoxData();a.cropper.clear();a.originalImageUrl("");a.isOperate(!0)};a.move=function(){a.cropper.setDragMode("move");a.isOperate(!0)};a.cropOk=function(){var b=
a.cropper,c=a.imageType();if(a.cropping())a.originalImageUrl(a.imageUrl()),a.data=b.getData(),a.canvasData=b.getCanvasData(),a.cropBoxData=b.getCropBoxData(),a.imageUrl(b.getCroppedCanvas(c=="image/png"?null:{fillColor:"#fff"}).toDataURL(c)),b.replace(a.imageUrl()),b.clear(),a.cropped(!0),a.cropping(!1),a.isOperate(!0)};a.crop=function(){a.cropper.setDragMode("crop");a.isOperate(!0)};a.zoomin=function(){a.cropper.zoom(0.1);a.isOperate(!0)};a.zoomout=function(){a.cropper.zoom(-0.1);a.isOperate(!0)};
a.rolateleft=function(){a.cropper.rotate(-90);a.isOperate(!0)};a.rolateright=function(){a.cropper.rotate(90);a.isOperate(!0)};a.horizontal=function(){a.cropper.scaleX(-a.cropper.getData().scaleX||-1);a.isOperate(!0)};a.vertical=function(){a.cropper.scaleY(-a.cropper.getData().scaleY||-1);a.isOperate(!0)};a.start=function(){if(!a.cropped())a.cropper=new t(a.image,{autoCrop:!1,checkOrientation:!1,checkCrossOrigin:!1,dragMode:"move",background:!1,built:function(){if(a.data)a.cropper.crop().setData(a.data).setCanvasData(a.canvasData).setCropBoxData(a.cropBoxData),
a.data=null,a.canvasData=null,a.cropBoxData=null},crop:function(b){b.width>0&&b.height>0&&!a.cropping()&&a.cropping(!0)}})};a.upload=function(){a.status(cube.msg("UPLOADING"));if(a.isIE())a.ieUploadFile();else{var b=new l;b.url=a.url();if(a.isOperate()==!0){a.cropper.cropped=!0;var c=a.imageType();a.imageUrl(a.cropper.getCroppedCanvas(c=="image/png"?null:{fillColor:"#fff"}).toDataURL(c))}b.file=w(a.imageUrl());b.file.name=a.name();b.params=m();b.onprogresschange=function(b){a.progress(b+"%")};b.onprogresscomplete=
function(b){b=b.event.target.responseText.replace(/\s*/g,"");b=="-1"?(a.status(cube.msg("UPLOADED")),a.uploaded(!0)):b.split(":")[0]=="-5"&&a.status(cube.msg("UPLOADFAIL")+","+cube.msg("UPLOAD_SIZE_LIMIT",[a.maxFileSize()+"KB"]))};b.onprogresserror=function(){a.status(cube.msg("UPLOADFAIL"))};b.oncanceled=function(){a.status(cube.msg("UPLOADCACEL"))};b.upload()}};a.download=function(){window.open(s(a.name()))};var h="";a.ieUploadFile=function(){var b=document.getElementById(a.id()),c=o();c.open("POST",
a.url(),!1);c.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");c.send("option=startUpload&rnd="+cube.random());if(c.status==200){if(!c.responseText)throw"error";h=c.responseText}else throw"error";n();if(a.type()=="path")b.action=encodeURI(a.url()+"?option=upload&maxFileSize="+a.maxFileSize()+"&sessionId="+h+"&fileName="+a.name()+"&filePath="+a.filePath()+"&uploadMode="+a.uploadMode()+"&isVirtual="+a.isVirtual()+"&rnd="+cube.random());else if(a.type()=="form"||a.type()==
"grid")b.action=encodeURI(a.url()+"?option=upload&maxFileSize="+a.maxFileSize()+"&sessionId="+h+"&tableName="+a.tableName()+"&primaryKey="+a.primaryKey()+"&pkVal="+a.pkVal()+"&colName="+a.colName()+(a.filePath()?"&filePath="+a.filePath():"")+"&uploadMode="+a.uploadMode()+"&udsParam="+a.udsParam()+"&isVirtual="+a.isVirtual()+"&rnd="+cube.random());b.submit()};a._imgloader=function(a,c){return"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+a+"', sizingMethod='"+c+"')"};a.onload=function(b){if(a.onRendered!=
null&&!cube.isObservable(a.onRendered))a.onRendered(b)};cube.endViewModel(a,u)}});