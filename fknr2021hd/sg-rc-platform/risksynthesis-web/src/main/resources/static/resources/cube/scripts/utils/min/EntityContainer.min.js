define(["JSONUtil","RESTClient","GUIDUtil"],function(jsonUtil,RestClient,guidUtil){return function(){var me=this;me.baseUrl=null;me.actions={};me.customHeaders=null;me.restClient=new RestClient;me.async=null;me.timeout=null;var _clientMap={};me.actionOverideBaseUrl=false;me.loadByPost=false;me.mdaParams=null;me.data=null;me.meta=null;me.dicts=null;me.dictsKeyValue=null;me.primaryKey="id";me.type="grid";me.changed=false;me.loadMeta=true;me.enableLocalMask=false;me.iscID=null;me.canModify=true;me.canDelete=
true;me.canCreate=true;me.onloading=null;me.onload=null;me.onchanging=null;me.onchanged=null;me.onsaving=null;me.onsaved=null;me.onvalidate=null;me.ondeleted=null;me.onerror=null;me._changedItems={};me._oldData={};me._loadDataPara={};me._loadMetaPara={};me._submitting=false;me._lastLoad={};me._tempLoadResult=null;me._changingType=false;me._loadData=true;me._loadCallBack=null;me._saveCallBack=null;var _json2flat=null;var pendingCall={timeStamp:null,procID:null};me.init=function(){if(me.timeout!=null)me.restClient.timeout=
me.timeout;me.restClient.mode="queue";me.restClient.async=me.async;me.restClient.customHeaders=me.customHeaders;if(cube.notEmpty(me.baseUrl))me.setBaseUrl(me.baseUrl);_json2flat=JSON2Flat(me.meta,jsonUtil);_initActions()};me.setBaseUrl=function(p_url){me.baseUrl=p_url;p_url=cube.mappath(me.baseUrl);if(cube.notEmpty(p_url))me.restClient.setBaseUrl(p_url)};me.load=function(){if(me._submitting)return;me._submitting=true;var args=me._parseArgs(arguments);if(me.type=="form"&&cube.isEmpty(args.path)&&cube.notEmpty(me.baseUrl))args.path=
"null";var p_path=args.path;var p_data=args.para;var p_callBack=args.callBack;var loadingArgs={cancel:false};loadingArgs=$.extend(loadingArgs,me._setLoadingArgs());if(loadingArgs.cancel)return;me.clearChanges();var dataPara={};var metaPara={};if(cube.notEmpty(p_data)){var structured=false;if(cube.notEmpty(p_data.dataParams)){structured=true;dataPara=p_data.dataParams}if(cube.notEmpty(p_data.metaParams)){structured=true;metaPara=p_data.metaParams}if(!structured)dataPara=p_data}if(cube.notEmpty(me.baseUrl)){if(cube.notEmpty(me.restClient)){me._changingType=
_checkTypeChanged();me._loadDataPara=dataPara;me._loadMetaPara=metaPara;if(cube.notEmpty(me.mdaParams)){me._loadDataPara.clsID=me.mdaParams.clsID;me._loadMetaPara.clsID=me.mdaParams.clsID}me._tempLoadResult=null;if(me._changingType&&me.loadMeta){var metaPath=me._makePath("meta","meta",null);if(cube.notEmpty(me.iscID)&&me.iscID!="-1")metaPath=metaPath==null?"/"+me.iscID:metaPath+"/"+me.iscID;var _get=_getClientCallMode("meta");_get(metaPath,{"params":JSON.stringify(me._loadMetaPara)},function(p_context){_load_meta_callback(p_context,
p_callBack)})}if(me._loadData){var restPath=me._makePath("data",null,p_path);var _get=me.loadByPost?me._getClientPostMode("data"):_getClientCallMode("data");_get(restPath,{"params":JSON.stringify(me._loadDataPara)},function(p_context){_load_data_callback(p_context,p_callBack)})}else{var tempContext={};tempContext.successful=true;tempContext.resultValue={};tempContext.resultValue.items=null;_load_data_callback(tempContext,p_callBack)}}}else{var localData=me.data;var localMeta=me.meta;me.data=null;
me.meta=null;var localCall=function(){_load_success(me._prepareLocalData(localData,localMeta,dataPara),p_callBack)};if(me.enableLocalMask){var timeStamp=(new Date).getTime();if(pendingCall.procID)clearTimeout(pendingCall.procID);pendingCall={timeStamp:timeStamp,procID:setTimeout(localCall,500)}}else localCall()}};me._makePath=function(p_action,p_defautAction,p_path){var actionPath=p_action in me.actions?me.actions[p_action]:null;if(cube.notEmpty(actionPath)){if(!(p_action in _clientMap)){var rc=new RestClient;
rc.mode="queue";rc.customHeaders=me.customHeaders;_clientMap[p_action]=rc}_clientMap[p_action].setBaseUrl(actionPath);return p_path}return p_path||p_defautAction};me.setValue=function(p_entity,p_col,p_value,p_triggerEvent){if(p_triggerEvent==undefined)p_triggerEvent=true;if(!me.canModify){me._notAllowedTip();return}if(cube.isString(p_entity)||cube.isNumber(p_entity))p_entity=me.getEntityByKey(p_entity);if(cube.isEmpty(p_entity))return;var args={cancel:false,entity:p_entity,fieldName:p_col,oldValue:p_entity[p_col],
newValue:p_value};if(p_triggerEvent);if(args.cancel)return;var dataPk=p_entity[me.primaryKey];if(cube.isEmpty(me._oldData[dataPk]))me._oldData[dataPk]={};if(cube.isEmpty(me._changedItems[dataPk])){me._changedItems[dataPk]={};me._changedItems[dataPk][me.primaryKey]=dataPk}var entityOldData=me._oldData[dataPk];if(!entityOldData[p_col])entityOldData[p_col]=p_entity[p_col];p_entity[p_col]=p_value;me._changedItems[dataPk][p_col]=p_value;me.hasChanged(true);args={entity:p_entity,fieldName:p_col,value:p_entity[p_col]};
if(p_triggerEvent);return p_entity};me.save=function(){if(me._submitting)return;me._submitting=true;var args=me._parseArgs(arguments);var p_path=args.path;var p_data=args.para;var p_callBack=args.callBack;var p_saveAll=args.saveAll;if(!p_saveAll&&!me.changed){if(me.onsaved)me.onsaved({p_result:{resultHint:"noChanged",resultValue:me.data,successful:true},result:[me.data]});me._submitting=false;return}var savePara=JSON.stringify(_parseSavePara(p_data,p_saveAll));var args={cancel:false,data:me.data,
param:savePara};if(args.cancel)return;var restPath=me._makePath("save","save",p_path);if(cube.notEmpty(me.restClient)){var _post=me._getClientPostMode("save");_post(restPath,savePara,function(p_context){_save_callback(p_context,p_callBack)})}};me.getChanges=function(){return me._changedItems};me.getChangedItems=function(){var items=[];jQuery.each(me._changedItems,function(index,val){items.push(val)});return items};me.hasChanged=function(p_changed){if(arguments.length>0)me.changed=p_changed;return me.changed};
me.clearChanges=function(){me.hasChanged(false);me._changedItems={};me._oldData={}};me.checkSaved=function(p_id){var isSaved=true;if(cube.notEmpty(me._changedItems[p_id]))if(cube.isEmpty(me._changedItems[p_id][me.primaryKey]))isSaved=false;return isSaved};me._parseArgs=function(p_args){var loadArgs={};if(cube.notEmpty(p_args))for(var i=0;i<p_args.length;i++)if(p_args[i]==undefined)continue;else if(cube.isString(p_args[i])||cube.isNumber(p_args[i]))loadArgs.path=p_args[i];else if(cube.isFunction(p_args[i]))loadArgs.callBack=
p_args[i];else if(cube.isBoolean(p_args[i]))loadArgs.saveAll=p_args[i];else if(cube.notEmpty(p_args[i]))loadArgs.para=p_args[i];return loadArgs};me._getSavingData=function(){return JSON.stringify(_parseSavePara())};me._prepareLocalData=function(p_data,p_meta,p_para){var localResult={};localResult.resultValue={};if(cube.isArray(p_data))localResult.resultValue.items=p_data;else{localResult.resultValue.items=new Array;localResult.resultValue.items.push(p_data)}if(cube.isArray(me.dicts))localResult.resultValue.dicts=
me.dicts;if(cube.notEmpty(p_meta))localResult.resultValue.columns=p_meta;localResult.resultValue.itemCount=p_data!=null?p_data.length:0;if(cube.notEmpty(p_para)&&cube.notEmpty(p_para.pageIndex)){localResult.resultValue.page={};localResult.resultValue.page.pageIndex=p_para.pageIndex;localResult.resultValue.page.pageSize=p_para.pageSize}return localResult};me._parseMeta=function(p_result){if(cube.notEmpty(p_result.columns)){me.meta=p_result.columns;me._getJsonFlatter().setMeta(me.meta)}if(typeof p_result.canModify!=
"undefined")me.canModify=p_result.canModify;if(typeof p_result.canDel!="undefined")me.canDelete=p_result.canDel;if(typeof p_result.canCreate!="undefined")me.canCreate=p_result.canCreate};me._parseData=function(p_result){if(me.type=="form"){if(cube.isEmpty(p_result)||cube.isEmpty(p_result.items))me.data={};else if(cube.isArray(p_result.items))me.data=p_result.items[0];else me.data=p_result.items;if(cube.isEmpty(me.data))me.data=new Object;if(cube.isEmpty(me.data[me.primaryKey])){var newPk=guidUtil.newGUID();
me.data[me.primaryKey]=newPk;me._changedItems[newPk]=new Object;me._changedItems[newPk].mxVirtualId=newPk}else{me.data=me._getJsonFlatter().jsonFlat([me.data]);me.data=me.data[0]}}else me.data=me._getJsonFlatter().jsonFlat(p_result.items)};me._parseDicts=function(p_result){if(p_result.dicItems&&p_result.dicItems.length>0)me.dicts=p_result.dicItems;else if(cube.isArray(p_result.dicts)&&p_result.dicts.length>0)me.dicts=p_result.dicts;me.dictsKeyValue={};if(cube.isArray(me.dicts))for(var i=0;i<me.dicts.length;i++){var dict=
me.dicts[i];if($.isPlainObject(dict)&&typeof dict.name!="undefined"&&typeof dict.values!="undefined"){me.dicts[dict.name]=dict.values;if(cube.isArray(dict.values)){me.dictsKeyValue[dict.name]={};for(var j=0;j<dict.values.length;j++)me.dictsKeyValue[dict.name][dict.values[j].value]=dict.values[j].text}}}};me._resetNewData=function(p_result){if(me.type=="form"){var saveResult=p_result.resultValue.items;if(cube.isArray(saveResult)&&saveResult.length>0)me.data=$.extend(me.data,saveResult[0]);return saveResult}else{var resetArgs=
new Object;resetArgs.deleteIDs=new Array;resetArgs.newData=new Array;for(var itemKey in me._changedItems){var changedItem=me._changedItems[itemKey];if(cube.isEmpty(changedItem[me.primaryKey]))resetArgs.deleteIDs.push(itemKey)}var saveResult=p_result.resultValue.items;if(cube.isArray(saveResult))for(var i=0;i<saveResult.length;i++){var newItem=saveResult[i];if(cube.isEmpty(me.getEntityByKey(newItem[me.primaryKey])))resetArgs.newData.push(newItem)}}return resetArgs};me._setLoadArgs=function(p_result){var args=
{};args.columns=me.meta;args.items=me.data||[];args.dicts=me.dicts;args.dictsKeyValue=me.dictsKeyValue;if(cube.notEmpty(p_result.page)){var pageIndex=parseInt(p_result.page.pageIndex);var pageSize=parseInt(p_result.page.pageSize);var startRow=(pageIndex-1)*pageSize;var endRow=pageIndex*pageSize;args.items=args.items.slice(startRow,endRow)}args.itemCount=p_result.itemCount;return args};me._showError=function(p_msgKey,p_context){var msg,errorPage;if($.isPlainObject(p_context)){var msg=p_context.resultHint||
cube.msg("ERR_UNKNOWN");var errorPage=p_context.errorPage}else{p_context={type:"error"};msg=cube.msg("ERR_UNKNOWN")}me._submitting=false;var args={"message":msg,cancel:false};if(me.onerror)me.onerror(args);if(args.cancel)return;if(p_context.type!="error")if(p_context.type=="warn"||p_context.type=="info")cube.indicate(p_context.type,msg);else if(typeof p_context.error!="undefined"&&p_context.error=="timeout")cube.indicate("error",cube.msg("REQUEST_TIMEOUT"));else cube.indicate("warning",msg);else cube.showError(cube.msg("ERR_"+
p_msgKey,msg))};me._notAllowedTip=function(){var msg=cube.msg("OPERATION_NOT_ALLOWED");var args={"message":msg,cancel:false};if(me.onerror)me.onerror(args);if(args.cancel)return;cube.indicate("warning",msg)};me._setLoadingArgs=function(){return{}};me._getJsonFlatter=function(){if(!_json2flat)_json2flat=JSON2Flat(me.meta,jsonUtil);return _json2flat};me.getEntityByKey=function(p_key){var results=jsonUtil.getItems(me.data,me.primaryKey,p_key);if(cube.isEmpty(results))return{};return results[0]};me.remove=
function(p_IDs,p_para,p_path){if(!me.canDelete){me._notAllowedTip();return}if(me._submitting)return;me._submitting=true;var IDs=new Array;if(cube.isArray(p_IDs))IDs=p_IDs;else IDs.push(p_IDs);var args={cancel:false,IDs:IDs};if(cube.isString(p_para)||cube.isNumber(p_para)){p_path=p_para;p_para=null}if(args.cancel)return;me._deleteIDs=IDs;if(cube.notEmpty(me.baseUrl)){var delUrl=me._makePath("remove","delete",p_path);if(cube.notEmpty(me.restClient)){var delIDs=new Array;for(var i=0;i<IDs.length;i++)if(me.checkSaved(IDs[i]))delIDs.push(IDs[i]);
if(delIDs.length==0)_delete_callback({successful:true});else{var delPara={"ids":delIDs};if(cube.notEmpty(me.mdaParams))delPara.clsID=me.mdaParams.clsID;if(cube.notEmpty(p_para))delPara=$.extend(delPara,p_para);var _post=me._getClientPostMode("remove");_post(delUrl,JSON.stringify(delPara),_delete_callback)}}}else _delete_callback({successful:true})};me.create=function(p_entity,p_options){if(!me.canCreate){me._notAllowedTip();return}if(cube.isEmpty(p_entity))p_entity=new Object;var args={cancel:false,
entity:p_entity};if(args.cancel)return;var newPk=p_entity[me.primaryKey];var isNew=false;if(cube.isEmpty(newPk)){p_entity[me.primaryKey]=guidUtil.newGUID();newPk=p_entity[me.primaryKey];isNew=true}me._changedItems[newPk]=new Object;me._changedItems[newPk].mxVirtualId=newPk;for(var p in p_entity)if(p==me.primaryKey&&isNew);else me._changedItems[newPk][p]=p_entity[p];me.hasChanged(true);return p_entity};function _initActions(){me.actions["meta"]=me.actions["meta"]?me.actions["meta"]:null;me.actions["data"]=
me.actions["data"]?me.actions["data"]:null;me.actions["save"]=me.actions["save"]?me.actions["save"]:null;me.actions["remove"]=me.actions["remove"]?me.actions["remove"]:null}function _checkTypeChanged(){if(!me.loadMeta)return false;var loadMeta=false;if(me._lastLoad.url!=me.baseUrl){me._lastLoad.url=me.baseUrl;loadMeta=true}if(cube.notEmpty(me.mdaParams)){if(me._lastLoad.clsID!=me.mdaParams.clsID){me._lastLoad.clsID=me.mdaParams.clsID;loadMeta=true}}else if(cube.notEmpty(me._lastLoad.clsID)){me._lastLoad.clsID=
null;loadMeta=true}return loadMeta}function _load_data_callback(p_context,p_callBack){if(cube.isEmpty(p_context))return;if(p_context.successful){var metaReady=false;if(cube.isEmpty(me._tempLoadResult))me._tempLoadResult=p_context;else{metaReady=true;_mergeResult(me._tempLoadResult,p_context)}if(!me._changingType||metaReady)_load_success(me._tempLoadResult,p_callBack)}else _load_error(p_context)}function _load_meta_callback(p_context,p_callBack){if(cube.isEmpty(p_context))return;if(p_context.successful){if(cube.notEmpty(p_context.resultValue.primaryKey))me.primaryKey=
p_context.resultValue.primaryKey;var dataReady=false;if(cube.isEmpty(me._tempLoadResult))me._tempLoadResult=p_context;else{dataReady=true;_mergeResult(me._tempLoadResult,p_context)}if(!me._loadData||dataReady)_load_success(me._tempLoadResult,p_callBack)}else _load_error(p_context)}function _load_success(p_result,p_callBack){me._submitting=false;if(cube.isEmpty(p_result.resultValue))throw new Error(cube.msg("ERR_RESULT_VALUE_EMPTY"));me._parseDicts(p_result.resultValue);me._parseMeta(p_result.resultValue);
me._parseData(p_result.resultValue,p_result.parentId);me._loadData=true;var args=me._setLoadArgs(p_result.resultValue,p_result.parentId);if(me.onload&&(typeof args.triggerLoad=="undefined"||args.triggerLoad===true))me.onload(args);if(cube.notEmpty(p_callBack))p_callBack(args)}function _load_error(p_context){me._lastLoad.url=null;me._lastLoad.clsID=null;me._showError("LOADING",p_context);if(cube.isEmpty(me.data))me.data={};if(cube.isEmpty(me.data[me.primaryKey])){var newPk=guidUtil.newGUID();me.data[me.primaryKey]=
newPk;me._changedItems[newPk]=new Object;me._changedItems[newPk].mxVirtualId=newPk}}function _save_callback(p_context,p_callBack){me._submitting=false;if($.isPlainObject(p_context)){if(cube.notEmpty(p_callBack))p_callBack(p_context);if(p_context.successful)_save_success(p_context);else if((p_context.type=="info"||p_context.type=="warn")&&cube.isArray(p_context.resultValue));else me._showError("SAVING",p_context)}else me._showError("SAVING")}function _save_success(p_result){var saveResult=me._resetNewData(p_result);
me.clearChanges();var args={p_result:p_result};args.result=saveResult;if(me.onsaved)me.onsaved(args)}function _parseSavePara(p_data,p_saveAll){if(cube.isEmpty(p_data))p_data={};if(!cube.isArray(p_data.items)){p_data.items=new Array;if(cube.notEmpty(p_saveAll)&&p_saveAll==true){var saveData=cube.clone(me.data);if(cube.isArray(me.meta))for(var i=0;i<me.meta.length;i++)if(typeof saveData[me.meta[i].name]=="undefined")saveData[me.meta[i].name]=null;var pk=saveData[me.primaryKey];if(me._changedItems[pk]&&
pk==me._changedItems[pk].mxVirtualId){delete saveData[me.primaryKey];saveData.mxVirtualId=pk}else delete saveData.mxVirtualId;p_data.items.push(saveData)}else for(var itemKey in me._changedItems)p_data.items.push(me._changedItems[itemKey]);p_data.items=me._getJsonFlatter().jsonHierarchy(p_data.items)}else $.each(p_data.items,function(i,item){delete item.mxVirtualId});if(cube.notEmpty(me.mdaParams))p_data.clsID=me.mdaParams.clsID;return p_data}function _mergeResult(temp,newRes){temp.parentId=newRes.parentId;
temp.resultValue=$.extend(temp.resultValue,newRes.resultValue)}function _getClientCallMode(p_action){var client=_getClient(p_action);return client.async==null||client.async==true?client.get:client.getSync}me._getClientPostMode=function(p_action){var client=_getClient(p_action);return client.post};function _getClient(p_action){var client=me.restClient;if(p_action in _clientMap)client=_clientMap[p_action];return client}function _delete_callback(p_context){me._submitting=false;if(cube.isEmpty(p_context))return;
if(p_context.successful)_delete_success(p_context);else _delete_error(p_context)}function _delete_success(p_result){for(var i=0;i<me._deleteIDs.length;i++){var deleteID=me._deleteIDs[i];if(cube.notEmpty(me._changedItems[deleteID])){me._changedItems[deleteID]=null;delete me._changedItems[deleteID]}if(cube.notEmpty(me._oldData[deleteID])){me._oldData[deleteID]=null;delete me._oldData[deleteID]}}var args={IDs:me._deleteIDs};if(me.ondeleted)me.ondeleted(args,p_result)}function _delete_error(p_context){me._showError("DELETING",
p_context)}me.isCreate=function(){return cube.notEmpty(me.data)&&!me.checkSaved(me.data[me.primaryKey])}}});
JSON2Flat=function(meta,jsonUtil){var me={};me.meta=meta;var names=[];me.init=function(){_init()};me.setMeta=function(p_meta){if(cube.isEmpty(p_meta))return;me.meta=p_meta;names=jsonUtil.jsonPath(me.meta,"$.*.name");$.each(names,function(index,name){if(cube.notEmpty(name)&&name.indexOf(".")!=-1)names[index]=name.split(".")})};me.clear=function(){me.meta=null;names=[]};me.jsonFlat=function(p_data){if(cube.isArray(p_data))$.each(p_data,function(index,item){_jsonFlat(item)});else if($.isPlainObject(p_data))_jsonFlat(p_data);
return p_data};me.jsonHierarchy=function(p_data){if(cube.isArray(p_data))$.each(p_data,function(index,p_item){_jsonHierarchy(p_item)});else if($.isPlainObject(p_data))_jsonHierarchy(p_item);return p_data};function _init(){me.setMeta(me.meta)}function _jsonFlat(p_item){$.each(names,function(index,name){if(cube.isArray(name)){var length=name.length;var queryString="$.";for(var i=0;i<length;i++)queryString+=name[i]+(i==length-1?"":".");var data=jsonUtil.jsonPath(p_item,queryString);if(data)p_item[name.join(".")]=
data[0]}});$.each(names,function(index,name){if(cube.isArray(name))delete p_item[name[0]]})}function _jsonHierarchy(p_item){for(var key in p_item)if(key.indexOf(".")!=-1){var names=key.split(".");var data=p_item;var length=names.length;for(var i=0;i<length-1;i++){var name=names[i];if(cube.isEmpty(data[name]))data[name]={};data=data[name]}data[names[length-1]]=p_item[key];delete p_item[key]}}_init();return me};