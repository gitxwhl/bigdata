<?xml version="1.0" encoding="UTF-8"?>
<sqls>

    <!-- 查询：作业人员总数，业主人数，集体人数，外包人数，  当前有效准入人数，本月新增准入人数，本月取消资格人数。 -->
    <sql id="getTotalStaff" desc="人员数量查询">
        <mysql>
            SELECT
            COUNT(1) crew_count,
            COUNT(CASE WHEN WORKER_NATURE='01' AND ACCESS_STATE='01' THEN 1 ELSE NULL END) proprietor,
            COUNT(CASE WHEN WORKER_NATURE='02' and ACCESS_STATE='01' THEN 1 ELSE NULL END) collectivity,
            COUNT(CASE WHEN WORKER_NATURE='03' and ACCESS_STATE='01' THEN 1 ELSE NULL END) epiboly,
            COUNT(CASE WHEN ACCESS_STATE='01' AND WORKER_NATURE IN ('01','02','03') THEN 1 ELSE NULL END) valid,
            COUNT(CASE WHEN DATE_FORMAT(CREATE_TIME, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m') and WORKER_NATURE IN ('01','02','03') THEN 1 ELSE NULL END) month_add,
            COUNT(CASE WHEN ACCESS_STATE='02' and DATE_FORMAT(CREATE_TIME, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m') THEN 1 ELSE NULL END) month_cancel
            FROM
            srp_work_siteworkerinfo WHERE DELETELOGO is null or DELETELOGO != '1';
        </mysql>
    </sql>

    <!-- 查询：作业人员总数，业主人数，集体人数，外包人数，  当前有效准入人数，本月新增准入人数，本月取消资格人数。 -->
    <sql id="getRegionalMonthAdd" desc="地区，人员性质分组查询人数">
        <mysql>
            SELECT
            column_type_code,
            column_type_name,
            nature_yezhu_y + nature_yezhu_n + nature_yezhu_w nature_yezhu,
            nature_yezhu_y,
            nature_yezhu_n,
            nature_yezhu_w,
            nature_jiti_y + nature_jiti_n + nature_jiti_w nature_jiti,
            nature_jiti_y,
            nature_jiti_n,
            nature_jiti_w,
            nature_waibao_y + nature_waibao_n + nature_waibao_w nature_waibao,
            nature_waibao_y,
            nature_waibao_n,
            nature_waibao_w
            FROM
            srp_risk_sys_tab o
            LEFT JOIN (
            SELECT
            PROVINCE_CODE,
            count( CASE WHEN WORKER_NATURE = '01' AND ACCESS_STATE = '01' THEN 1 ELSE NULL END ) nature_yezhu_y,
            count( CASE WHEN WORKER_NATURE = '01' AND ACCESS_STATE = '02' THEN 1 ELSE NULL END ) nature_yezhu_n,
            count( CASE WHEN WORKER_NATURE = '01' AND ( ACCESS_STATE IS NULL OR ACCESS_STATE NOT IN ( '01', '02' ) ) THEN 1 ELSE NULL END ) nature_yezhu_w,
            count( CASE WHEN WORKER_NATURE = '02' AND ACCESS_STATE = '01' THEN 1 ELSE NULL END ) nature_jiti_y,
            count( CASE WHEN WORKER_NATURE = '02' AND ACCESS_STATE = '02' THEN 1 ELSE NULL END ) nature_jiti_n,
            count( CASE WHEN WORKER_NATURE = '02' AND ( ACCESS_STATE IS NULL OR ACCESS_STATE NOT IN ( '01', '02' ) ) THEN 1 ELSE NULL END ) nature_jiti_w,
            count( CASE WHEN WORKER_NATURE = '03' AND ACCESS_STATE = '01' THEN 1 ELSE NULL END ) nature_waibao_y,
            count( CASE WHEN WORKER_NATURE = '03' AND ACCESS_STATE = '02' THEN 1 ELSE NULL END ) nature_waibao_n,
            count( CASE WHEN WORKER_NATURE = '03' AND ( ACCESS_STATE IS NULL OR ACCESS_STATE NOT IN ( '01', '02' ) ) THEN 1 ELSE NULL END ) nature_waibao_w
            FROM
            srp_work_siteworkerinfo
            WHERE
            DELETELOGO IS NULL
            OR DELETELOGO != '1'
            GROUP BY
            PROVINCE_CODE
            ) a ON o.column_type_code = a.PROVINCE_CODE
            WHERE
            column_code = 'DATAREPORT_ORG'
            ORDER BY
            column_num + 0;
        </mysql>
    </sql>

    <sql id="deletTable" desc="清空表">
        <mysql>
            DELETE FROM  srp_work_siteworkerinfo_temporary;
        </mysql>

    </sql>

    <sql id="addTable" desc="添加人员临时表数据">
        <mysql>
            INSERT INTO srp_work_siteworkerinfo_temporary (${keysFilter}) VALUES (${valuesFilter});
        </mysql>

    </sql>

    <sql id="getRegionalMonth" desc="人员柱状图查询">
        <mysql>
            SELECT *  FROM srp_work_siteworkerinfo_temporary;
        </mysql>

    </sql>

    <!-- 查询：页码 数量 姓名 单位 省份 专业 企业性质 三种人标识 开始时间 结束时间  是否有效 -->
<!--    <sql id="getPersonnelIn" desc="页码 数量 姓名 单位 省份 专业 人员性质 三种人标识 开始时间 结束时间  是否有效">-->
<!--        <mysql>-->
<!--            select-->
<!--            a.SITEWORKERINFO_ID,-->
<!--            a.ORG_NAME,-->
<!--            a.name,-->
<!--            a.sex,-->
<!--            a.id_card,-->
<!--            e.column_type_name datareport_org,-->
<!--            d.column_type_name WORKER_NATURE,-->
<!--            b.TEST_SCORE,-->
<!--            c.PENALTY_STAFF_POINTS,-->
<!--            a.contact,-->
<!--            a.THREEKINDS_IDENTIFICATION,-->
<!--            CASE WHEN a.ACCESS_STATE = '01' THEN '有效' WHEN a.ACCESS_STATE = '02' THEN '无效'  ELSE '' END ACCESS_STATE-->
<!--            from srp_work_siteworkerinfo a-->
<!--            left join-->
<!--            (select SITEWORKERINFO_ID,TEST_SCORE from SRP_WORK_SAFETYTEST GROUP BY SITEWORKERINFO_ID ORDER BY TEST_DATE-->
<!--            desc) b-->
<!--            on a.SITEWORKERINFO_ID = b.SITEWORKERINFO_ID-->
<!--            left join-->
<!--            (select PENALTY_STAFF_ID,PENALTY_STAFF_POINTS from srp_work_staffviolationpenalty GROUP BY PENALTY_STAFF_ID-->
<!--            ORDER BY CREATE_TIME desc) c-->
<!--            on a.SITEWORKERINFO_ID = c.PENALTY_STAFF_ID-->
<!--            INNER JOIN ( SELECT * FROM srp_risk_sys_tab WHERE column_code = 'WORKER_NATURE' ) d ON a.WORKER_NATURE = d.column_type_code-->
<!--            LEFT JOIN ( SELECT * FROM srp_risk_sys_tab WHERE column_code = 'DATAREPORT_ORG' ) e ON a.PROVINCE_CODE = e.column_type_code-->
<!--            where-->
<!--            ${filter}-->
<!--            and ( a.DELETELOGO is null or a.DELETELOGO != '1' )-->
<!--            ORDER BY CREATE_TIME DESC ,b.TEST_SCORE desc-->
<!--        </mysql>-->
<!--    </sql>-->


    <!-- 查询人员列表详情 -->
    <sql id="getPersonnelInTotal" desc="页码 数量 姓名 单位 省份 专业 人员性质 三种人标识 开始时间 结束时间  是否有效">
        <mysql>
            select
            a.SITEWORKERINFO_ID,
            a.ORG_NAME,
            a.name,
            a.sex,
            a.id_card,
            e.column_type_name datareport_org,
            d.column_type_name WORKER_NATURE,
            a.contact,
            a.THREEKINDS_IDENTIFICATION,
            case when ISNULL(f.VIOLATION_CONTENT) then 0 else f.VIOLATION_CONTENT end VIOLATION_CONTENT,
            CASE WHEN a.ACCESS_STATE = '01' THEN '有效' WHEN a.ACCESS_STATE = '02' THEN '无效'  ELSE '' END ACCESS_STATE
            from (SELECT * FROM SRP_WORK_SITEWORKERINFO WHERE ${page}) a
            LEFT JOIN (SELECT VIOLATION_STAFF_ID, count( 1 ) VIOLATION_CONTENT
            FROM SRP_WORK_VIOLATIONFILE GROUP BY VIOLATION_STAFF_ID) f
            ON a.SITEWORKERINFO_ID = f.VIOLATION_STAFF_ID

            INNER JOIN ( SELECT column_type_name, column_type_code FROM srp_risk_sys_tab WHERE column_code = 'WORKER_NATURE' ) d ON a.WORKER_NATURE = d.column_type_code
            LEFT JOIN ( SELECT column_type_name, column_type_code FROM srp_risk_sys_tab WHERE column_code = 'DATAREPORT_ORG' ) e ON a.PROVINCE_CODE = e.column_type_code
            where
            ${filter}
            and ( a.DELETELOGO is null or a.DELETELOGO != '1' )
            ${limit}
        </mysql>
    </sql>

    <sql id="getPersonnelInTotalCount" desc="页码 数量 姓名 单位 省份 专业 人员性质 三种人标识 开始时间 结束时间  是否有效">
        <mysql>
            select
            COUNT( 1 ) AS WORKSITEINFO_CNT
            from (SELECT * FROM SRP_WORK_SITEWORKERINFO WHERE 1=1) a
            LEFT JOIN (SELECT VIOLATION_STAFF_ID, count( 1 ) VIOLATION_CONTENT
            FROM SRP_WORK_VIOLATIONFILE GROUP BY VIOLATION_STAFF_ID) f
            ON a.SITEWORKERINFO_ID = f.VIOLATION_STAFF_ID

            INNER JOIN ( SELECT column_type_name, column_type_code FROM srp_risk_sys_tab WHERE column_code = 'WORKER_NATURE' ) d ON a.WORKER_NATURE = d.column_type_code
            LEFT JOIN ( SELECT column_type_name, column_type_code FROM srp_risk_sys_tab WHERE column_code = 'DATAREPORT_ORG' ) e ON a.PROVINCE_CODE = e.column_type_code
            where
            ${filter}
            and ( a.DELETELOGO is null or a.DELETELOGO != '1' )
        </mysql>
    </sql>




    <!-- 根据id查询人员 -->
    <sql id="getOrgids" desc="根据id查询人员">
        <mysql>
            select org_id,name,contact,id_card,sex,THREEKINDS_IDENTIFICATION,org_name,profession,age,photo from
            srp_work_siteworkerinfo where SITEWORKERINFO_ID= ${filter}
            and ( DELETELOGO is null or DELETELOGO != '1' );
        </mysql>
    </sql>


    <sql id="getPersonneCount" desc="查询人员信息总个数">
        <mysql>
            SELECT
            column_type_name columntypename,
            IFNULL(nature_y + nature_n + nature_w,0)  natureall
            FROM
            srp_risk_sys_tab o
            LEFT JOIN (
            SELECT
            PROVINCE_CODE,
            count( CASE WHEN ACCESS_STATE = '01' THEN 1 ELSE NULL END ) nature_y,
            count( CASE WHEN ACCESS_STATE = '02' THEN 1 ELSE NULL END ) nature_n,
            count( CASE WHEN ACCESS_STATE IS NULL OR ACCESS_STATE NOT IN ( '01', '02' ) THEN 1 ELSE NULL END ) nature_w
            FROM
            srp_work_siteworkerinfo
            WHERE
            DELETELOGO IS NULL
            OR DELETELOGO != '1'
            GROUP BY
            PROVINCE_CODE
            ) a ON o.column_type_code = a.PROVINCE_CODE
            WHERE
            column_code = 'DATAREPORT_ORG'
            ORDER BY
            column_num + 0;
        </mysql>
    </sql>


    <sql id="loginToken" desc="获取登录认证token">
        <mysql>
            select USER_TOKEN as user_token from user_info where ${commonFilter};
        </mysql>
    </sql>

    <!-- 根据省份查询单位小代码 -->
    <sql id="getOrgId" desc="单位小代码">
        <mysql>
            select column_type_name,column_type_code from srp_risk_sys_tab where ${filter};
        </mysql>
    </sql>

    <!-- 专业小代码  -->
    <sql id="getProfession" desc="专业小代码">
        <mysql>
            select column_type_name,column_type_code from srp_risk_sys_tab where column_code='PROFESSION'
        </mysql>
    </sql>

    <!-- 企业性质小代码 -->
    <sql id="getOrgNature" desc="企业性质小代码">
        <mysql>
            select column_type_name,column_type_code from srp_risk_sys_tab where column_code='WORKER_NATURE'
        </mysql>
    </sql>

    <!-- 三种人标识小代码 -->
    <sql id="getThreekindsIdentification" desc="三种人标识小代码">
        <mysql>
            select column_type_name,column_type_code from srp_risk_sys_tab where column_code='THREEKINDS_IDENTIFICATION'
        </mysql>
    </sql>

    <!-- 是否有效小代码 -->
    <sql id="getAccessState" desc="是否有效小代码">
        <mysql>
            select column_type_name,column_type_code from srp_risk_sys_tab where column_code='ACCESS_STATE'
        </mysql>
    </sql>

    <!-- 性别 -->
    <sql id="getSex" desc="性别">
        <mysql>
            select column_type_name,column_type_code from srp_risk_sys_tab where column_code='SEX'
        </mysql>
    </sql>


    <!-- 根据id查询考试成绩 -->
    <sql id="getExamination" desc="根据id查询考试成绩">
        <mysql>
            select
            a.TEST_SCORE,
            a.TEST_NAME,
            a.APPLY_POST,
            a.APPLY_SPECIALTY,
            b.ORG_NAME,
            e.column_type_name DATAREPORT_ORG,
            a.TEST_DATE,
            a.VALIDITY_PERIOD
            from srp_work_safetytest a
            left join srp_work_siteworkerinfo b
            on a.SITEWORKERINFO_ID =b.SITEWORKERINFO_ID
            left join
            (select column_type_code,column_type_name from srp_risk_sys_tab where column_code = 'profession') c
            on c.column_type_code=b.profession
            LEFT JOIN ( SELECT * FROM srp_risk_sys_tab WHERE column_code = 'DATAREPORT_ORG' ) e ON b.PROVINCE_CODE = e.column_type_code
            where a.SITEWORKERINFO_ID= ${filter}
            and ( b.DELETELOGO is null or b.DELETELOGO != '1' )
        </mysql>
    </sql>

    <!-- 根据id查询违章记录 -->
    <sql id="getViolationfile" desc="根据id查询违章记录">
        <mysql>
            select
            a.VIOLATION_ORG_ID,
            a.VIOLATION_STAFF_ID,
            a.VIOLATION_LEVEL,
            c.VIOLATION_CLAUSE_DESCRIPTION,
            a.VIOLATION_ORG,
            a.CREATE_TIME,
            a.CHECK_LEVEL,
            a.VIOLATION_CONTENT
            from srp_work_violationfile a
            LEFT JOIN ( SELECT * FROM srp_work_violationfiletorules ) b ON b.VIOLATIONFILE_ID =a.VIOLATIONFILE_ID
            LEFT JOIN ( SELECT * FROM SRP_WORK_VIOLATIONRULES ) c ON c.VIOLATIONRULES_ID = b.VIOLATIONRULES_ID

            where VIOLATION_STAFF_ID = ${filter}
        </mysql>
    </sql>


    <!-- 人员变更信息 -->
    <sql id="getDatareport" desc="人员变更信息">
        <mysql>
            select
            b.SITEWORKERINFO_ID,
            a.UPDATE_TIME,
            a.DATAREPORT_ORG
            from srp_work_siteinfochange a left join srp_work_siteworkerinfo b
            on b.org_id =a.DATAREPORT_ORG_ID where b.SITEWORKERINFO_ID = ${filter}
            and ( b.DELETELOGO is null or b.DELETELOGO != '1' );
        </mysql>
    </sql>

    <sql id="getSrpWorkePlanDay" desc="根据人员id查询作业计划">
        <mysql>
            SELECT
            b.WORK_PLAN_ID,
            b.work_plan_name,
            b.WORK_STATE,
            b.SUBSTATION_NAME,
            b.WORK_TYPE,
            b.WORKRISK_LEVEL,
            b.BEGIN_TIME,
            b.END_TIME
            FROM  SRP_WORK_SITEWORKERINFO a INNER JOIN srp_work_workplanday b ON a.SITEWORKERINFO_ID = b.WORK_MANAGER_ID
            WHERE
            ${filter}
            and ( a.DELETELOGO is null or a.DELETELOGO != '1' )
            ${limit}
        </mysql>
    </sql>

    <sql id="getSrpWorkePlanDayCot" desc="根据人员id查询作业计划总数">
        <mysql>
            SELECT
            COUNT( 1 ) AS WORKSITEINFO_CNT
            FROM  SRP_WORK_SITEWORKERINFO a INNER JOIN srp_work_workplanday b ON a.SITEWORKERINFO_ID = b.WORK_MANAGER_ID
            WHERE
            ${filter}
            and ( a.DELETELOGO is null or a.DELETELOGO != '1' )
        </mysql>
    </sql>


    <sql id ="deletePersonnel" desc="删除人员列表数据">
        <mysql>
            update srp_work_siteworkerinfo set  DELETELOGO = "1" where SITEWORKERINFO_ID in ( ${filter} )
        </mysql>
    </sql>

    <sql id="getTmxAttachment" desc="人员头像展示接口">
        <mysql>
            SELECT * FROM t_mx_attachment a WHERE
            a.pk_val = ${filter}
            order by a.create_time  desc limit 1
        </mysql>
    </sql>

</sqls>


