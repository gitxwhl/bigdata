define(["CheckUtil","Validator"],function(k,t){function l(l){function r(c){var b=a.validType();c==!1?b==null?b="NOTNULL":b.indexOf("NOTNULL")==-1&&(b+=", NOTNULL"):b!=null&&(b=b.replace("NOTNULL",""));a.validType(b)}function s(c){var b,d=a.validType();a.customValidate!=null&&cube.isFunction(a.customValidate)&&!cube.isObservable(a.customValidate)&&(b=a.customValidate(c));if(b==!1||$.isPlainObject(b)&&b.successful==!1)return a.validStatus("error"),$.isPlainObject(b)&&b.hint&&(a.validHintType()=="pop"?
(a.isShowPopDialog(!1),a.isShowPopDialog(!0),cube.showPopDialog($(o),{content:b.hint,popoverDirection:"bottom",msgType:"error",isShowDialog:a.isShowPopDialog})):a.validHint(b.hint)),!1;if(!(cube.isEmpty(d)||d.indexOf("NOTNULL")==-1)||!cube.isEmpty(c))if((d.indexOf("NOTNULL")!=-1||cube.notEmpty(c))&&d!=null)if(b=t.validate(c,d),b.successful)a.validStatus(""),a.validHint(""),a.isShowPopDialog(!1);else{a.validStatus("error");a.validHint(b.hint);if(a.validHintType()=="pop")a.isShowPopDialog(!1),!cube.isObservable(a.popNode)&&
a.popNode!=null&&a.popNode.remove(),a.isShowPopDialog(!0),a.popNode=cube.showPopDialog($(o),{content:b.hint,popoverDirection:"bottom",msgType:"error",isShowDialog:a.isShowPopDialog});b=a.validFailValue();b=="empty"?(a.value(""),a._value("")):b=="current"?a.value(i(new Date,a.format(),!0)):a.value(c);return!1}}function i(c,b,d,e){if(cube.notEmpty(c)){d=null;if(k.isTime(c))return c;else cube.isDate(c)?d=c:(cube.isString(c)||(c=String(c)),d=new Date(c.replace(/-/g,"/")),isNaN(d.getMonth())&&(c=c.replace(/-/g,
""),c=c.replace(/\s*/g,""),c=c.replace(/:/g,"")),k.isDigit(c)&&(c.length==10?String(c).substring(0,1)=="1"?c+="000":(c=c.substring(0,4)+"/"+c.substring(4,6)+"/"+c.substring(6,8)+" "+c.substring(8,10)+":00:00",d=new Date(c)):c.length==6?(c=c.substring(0,4)+"/"+c.substring(4,6)+"/01",d=new Date(c)):c.length==8?(c=c.substring(0,4)+"/"+c.substring(4,6)+"/"+c.substring(6,8),d=new Date(c)):c.length==12?(c=c.substring(0,4)+"/"+c.substring(4,6)+"/"+c.substring(6,8)+" "+c.substring(8,10)+":"+c.substring(10,
12)+":00",d=new Date(c)):c.length==14&&(c=c.substring(0,4)+"/"+c.substring(4,6)+"/"+c.substring(6,8)+" "+c.substring(8,10)+":"+c.substring(10,12)+":"+c.substring(12,14),d=new Date(c)),c.length==13&&(d=new Date(parseInt(c)))));if(typeof e=="undefined"){if(isNaN(d.getMonth()))if(k.isDateTime(c))e="",c=c.split(" "),c[1].length==2?e=c[1]+":00:00":c[1].length==4&&(e=c[1]+":00"),d=new Date(c[0].replace(/-/g,"/")+" "+e);else return c;a.year(d.getFullYear());a.quarter(Math.ceil((d.getMonth()+1)/3));a.month(d.getMonth()+
1);a.day(d.getDate());a.hour(d.getHours());a.minute(d.getMinutes());a.second(d.getSeconds())}}else if(!d)return"";b=b.replace(/yyyy/g,a.year());b=a.showQuarterPicker()?b.replace(/MM/g,j(a.quarter(),"01")):b.replace(/MM/g,j(a.month(),"00"));b=b.replace(/dd/g,j(a.day(),"00"));b=b.replace(/HH/g,j(a.hour(),"00"));b=b.replace(/mm/g,j(a.minute(),"00"));return b=b.replace(/ss/g,j(a.second(),"00"))}function j(a,b){if(a==null)return"";if(typeof b=="undefined")return a+"";if(typeof b=="number")return a+"";
var d=a+"";if(b!=null&&b!=""){var d=d.split("."),e=b.split(".");d[0].length<e[0].length&&(d[0]=e[0].substring(0,e[0].length-d[0].length)+d[0]);if(e.length==1)return d[0];else{if(d.length>1)for(;d[1].length<e[1].length;)d[1]+="0";else d[1]=e[1];return(new Number(d[0]+"."+d[1])).toFixed(e[1].length)}}else return d}var a=this;a.name="";a.width="100%";a.popoverDirection="bottom";a.msgType="info";a.prefixText="";a.suffixText="";a.showTimePicker=!0;a.showDayPicker=!0;a.showMonthPicker=!0;a.showQuarterPicker=
!1;a.isClickCloseDialog=!1;a.format="yyyy-MM-dd";a.dataFormat=null;a.leftOffset="0px";a.calendarFocus=!1;a.isShowDialog=!1;a.date=new Date;a.year=a.date.getFullYear();a.quarter=Math.ceil((a.date.getMonth()+1)/3);a.month=a.date.getMonth()+1;a.day=a.date.getDate();a.hour=a.date.getHours();a.minute=a.date.getMinutes();a.second=a.date.getSeconds();a.value="";a.minValue=null;a.maxValue=null;a.readOnly=!1;a.maxLength=null;a.isAllowEdit=!0;a.validType="DATE";a.validStatus=null;a.validHint=null;a.customValidate=
null;a.isShowValue=!1;a.textAlign="left";a.nullable=!0;a.isShowPopDialog=!1;a.validHintType="inline";a.validFailValue="default";a.isValid=!0;a.isExtDisplay=!1;a.hasFocus=!1;a.onFocus=null;var o=a.onRendered=null;a.onChanged=null;a.popNode=null;a._value=null;a.$scrollDiv=null;a.timeStart=0;a._timeEditor=!1;a.$e=null;var p=!1;a._init=function(){a.showQuarterPicker()&&(a.showTimePicker(!1),a.showMonthPicker(!1));(a.format()=="HH:mm:ss"||a.format()=="HH:mm"||a.format()=="HH")&&a._timeEditor(!0);a.validHint("");
a.validStatus("");a.setValidType();r(a.nullable());a.nullableSub=cube.subscribe(a.nullable,r);a.formatSub=cube.subscribe(a.format,a.setValidType);a._valueSub=cube.subscribe(a._value,a._changed);a.valueSub=cube.subscribe(a.value,a._valuechanged);a._value(i(a.value(),a.format(),a.isShowValue()));a.yearSub=cube.subscribe(a.year,a._calendarchanged);a.quarterSub=cube.subscribe(a.quarter,a._calendarchanged);a.monthSub=cube.subscribe(a.month,a._calendarchanged);a.daySub=cube.subscribe(a.day,a._calendarchanged);
a.hourSub=cube.subscribe(a.hour,a._calendarchanged);a.minuteSub=cube.subscribe(a.minute,a._calendarchanged);a.secondSub=cube.subscribe(a.second,a._calendarchanged);a.hasFocusSub=cube.subscribe(a.hasFocus,function(c){if(c&&a.onFocus!=null&&!cube.isObservable(a.onFocus))a.onFocus(a.value(),a)})};a.setValidType=function(c){var b=c;cube.isEmpty(b)&&(b=a.format());var d=a.validType(),d="DATE";b=="HH:mm:ss"?d="TIME":d=="DATE"&&(b=="yyyy"?(a.showTimePicker(!1),a.showMonthPicker(!1),a.showDayPicker(!1),a.showQuarterPicker(!1)):
b.indexOf("dd")==-1&&b.indexOf("HH")==-1&&(a.showTimePicker(!1),a.showDayPicker(!1)),b.indexOf("HH")!=-1&&b.indexOf("dd")!=-1?(d="DATETIME",a.validType().indexOf("NOTNULL")!=-1&&(d+=", NOTNULL")):b.indexOf("HH")!=-1&&b.indexOf("dd")==-1&&(d="TIME",a.validType().indexOf("NOTNULL")!=-1&&(d+=", NOTNULL")));a.validType(d);cube.notEmpty(c)&&a._valuechanged(a._value())};a.setTimeUp=function(){a._setTimeChanged("up")};a.setTimeDown=function(){a._setTimeChanged("down")};a._input_keydown=function(c,b){if((a.readOnly()||
!a.isAllowEdit())&&b.keyCode==8)return b.keyCode=0,!1;return a._timeEditor()&&!a.isAllowEdit()?!1:!0};a._setTimeChanged=function(c){if(!a.readOnly()){var b=c=="down"?-1:1,d="";if(cube.isEmpty(a._value()))var e=new Date,f=parseInt(e.getHours()),g=parseInt(e.getMinutes()),e=parseInt(e.getSeconds());else e=a._value().split(":"),f=parseInt(e[0],10),g=parseInt(e[1],10),e=parseInt(e[2],10);a.timeStart()==0?(f+=b,c=="down"?f==-1&&(f=23):f==24&&(f=0)):a.timeStart()==1?(g+=b,c=="down"?g==-1&&(g=59,f-=1,f==
-1&&(f=23)):g==60&&(g=0,f+=1,f==24&&(f=0))):a.timeStart()==2&&(e+=b,c=="down"?e==-1&&(e=59,g-=1,g==-1&&(g=59,f-=1,f==-1&&(f=23))):e==60&&(e=0,g+=1,g==60&&(g=0,f+=1,f==24&&(f=0))));f<=9&&(f="0"+f);g<=9&&(g="0"+g);e<=9&&(e="0"+e);a.format()=="HH:mm:ss"?d=f+":"+g+":"+e:a.format()=="HH:mm"?d=f+":"+g:a.format()=="HH"&&(d=f);a._value(d)}};a._input_selectionchanged=function(c){var b=0,b=$(c).getSelection().start;b==0||b==1||b==2?a.timeStart(0):b==3||b==4||b==5?a.timeStart(1):b==6||b==7||b==8?a.timeStart(2):
a.timeStart(0)};a.showPopoverDialog=function(c,b){var d=$(c).parent().siblings(".par").children(".popover");if(a._timeEditor())a._input_selectionchanged(c,b);else if(!a.readOnly()){a.isExtDisplay()&&a.showlog(c,d,b);a.isShowDialog(!0);a.isShowPopDialog(!1);a.calendarFocus(!0);var d=a.$e.find(".popover.info").offset().left,e=a.$e.find(".popover.info").width(),f=$(window).width();d+e>f&&a.leftOffset("-"+(d+e-f+15)+"px")}};a.showlog=function(a,b,d){var e=null,f=!0;a.className=="btn btn-default"?(e=$(a).siblings("input")[0],
f=$(window).width()-d.clientX+d.offsetX-40>b.innerWidth()?!0:!1):(e=$(a)[0],f=$(window).width()-d.clientX-e.offsetWidth+d.offsetX-40>b.innerWidth()?!0:!1);a=e.offsetWidth;e=e.offsetHeight;b.css("position","fixed");b.css("z-index","5000");var g=d.target?d.target:d.srcElement,i=d.layerY?d.layerY:d.offsetY,h=d.clientX-d.offsetX+0;$(window).height()-d.clientY-e+d.offsetY>b.innerHeight()?(g.className=="btn btn-default"?b.css("left",h-a):g.className=="icon-calendar"?b.css("left",h-a-12):b.css("left",h),
b.css("top",d.clientY+e-i),b.removeClass("top"),b.removeClass("right"),b.addClass("bottom"),$("body>.popover.arrow").css("top","-11px")):(d.clientY-d.offsetY-10>b.innerHeight()?(g.className=="btn btn-default"?b.css("left",h-a):g.className=="icon-calendar"?b.css("left",h-a-12):b.css("left",h),b.css("top",d.clientY-b.innerHeight()-i),b.removeClass("bottom"),b.removeClass("right"),b.addClass("top")):(g.className=="btn btn-default"?f?b.css("left",h+40):b.css("left",h+10-a):g.className=="icon-calendar"?
f?b.css("left",h-12+40):b.css("left",h-12+10-a):f?b.css("left",h+40+a):b.css("left",h+10),b.css("top",d.clientY-b.innerHeight()/2-i+e/2),b.removeClass("bottom"),b.removeClass("top"),b.addClass("right")),$("body>.popover.arrow").css("top","100%"))};var m=!1;a.emptyTime=function(){var c=new Date;m=!0;a._value("");a.year(c.getFullYear());a.quarter(Math.ceil((c.getMonth()+1)/3));a.month(c.getMonth()+1);a.day(c.getDate());a.hour(c.getHours());a.minute(c.getMinutes());a.second(c.getSeconds());m=!1};a.confirmTime=
function(){a._calendarchanged();a.isShowDialog(!1)};var n=!1,q=!1;a.mouseoverPopoverDialog=function(){q=!0};a.mousedownInnerPopoverDialog=function(){n=!0;q=!1};a.onSelectDate=function(){cube.isEmpty(a._value())&&a._calendarchanged()};a.hiddenPopoverDialog=function(){n==!1||q==!0&&n==!0?(a.isShowDialog(!1),a.calendarFocus(!1)):a.calendarFocus(!0);n=!1};a._calendarchanged=function(){if(!m&&a._checkDate()){var c=i(null,a.format(),!0);a._value(c)}};a._checkDate=function(){var c=null,b=a.minValue();cube.notEmpty(b)&&
k.isDate(b)&&(c=(new Date(b)).getTime());var b=null,d=a.maxValue();cube.notEmpty(d)&&k.isDate(d)&&(b=(new Date(d)).getTime());d=(new Date(a.year()+"-"+a.month()+"-"+a.day())).getTime();if(c!=null&&d<c)return!1;if(b!=null&&d>b)return!1;return!0};a._valuechanged=function(c){if(!p){if(cube.notEmpty(c)){var b=i(c,a.format(),!0);c!=b&&b==a._value()&&a._changed(b);a._value(b)}else a.emptyTime();if(a.onChanged!=null&&!cube.isObservable(a.onChanged))a.onChanged(a.name(),a.value())}};a._changed=function(c){p=
!0;a.isShowPopDialog(!1);if(cube.notEmpty(c)){c=i(c,a.format(),!0);if(!m&&s(c)==!1)return;a.dataFormat()!=null&&(c=i(c,a.dataFormat(),!0,!0));a.value(c)}else a.value("");if(a.onChanged!=null&&!cube.isObservable(a.onChanged))a.onChanged(a.name(),a.value());p=!1};a.dateClick=function(){};a._valid=function(c,b){a.isValid()&&s(b.target.value)};a.onload=function(c,b){o=c;a.$e=$(c);if(a.isExtDisplay())window.onmousewheel=document.onmousewheel=function(){a.hiddenPopoverDialog()};if(a.onRendered!=null&&!cube.isObservable(a.onRendered))a.onRendered(c,
b)};cube.endViewModel(a,l)}cube.importComponent("controls.calendar");l.prototype.dispose=function(){this.isShowPopDialog(!1);this._valueSub.dispose();this.valueSub.dispose();this.nullableSub.dispose();this.yearSub.dispose();this.quarterSub.dispose();this.monthSub.dispose();this.daySub.dispose();this.hourSub.dispose();this.minuteSub.dispose();this.secondSub.dispose();this.formatSub.dispose();this.hasFocusSub.dispose()};return l});