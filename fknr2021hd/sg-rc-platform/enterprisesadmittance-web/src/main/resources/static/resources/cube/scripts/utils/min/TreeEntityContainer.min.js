define(["entityContainer","GUIDUtil"],function(entityContainer,guidUtil){return function(){var me=new entityContainer;var base={};me.onload=null;me.ondeleting=null;me.ondeleted=null;me.oncreating=null;me.oncreated=null;me.primaryKey="id";me.textColName="text";me.loadMeta=false;me.canCreate=true;me._removeCallBack=null;var _loadingNode=null;var _deletingNode=null;var _loadNode=[];base.init=me.init;me.init=function(){base.init();var data=me.data()||[];me.data([]);if(cube.notEmpty(me.baseUrl))data=[];
_populateNodes(data)};base.load=me.load;me.load=function(p_node,p_callBack){_loadingNode=null;if(typeof p_callBack!="undefined"&&typeof p_node!="undefined")if(cube.notEmpty(p_node)&&cube.notEmpty(p_node.id)){_loadingNode=p_node;_loadNode.push(p_node.id);var params=p_node.queryParams!=null?p_node.queryParams:{};params.itemType=p_node.itemType;base.load(p_node.id,params,p_callBack)}else base.load(p_node,p_callBack);else if(typeof p_node!="undefined")if(cube.notEmpty(p_node)&&cube.notEmpty(p_node.id)){_loadingNode=
p_node;_loadNode.push(p_node.id);var params=p_node.queryParams!=null?p_node.queryParams:{};params.itemType=p_node.itemType;base.load(p_node.id,params)}else base.load(p_node);else base.load()};me.getNodeEntity=function(p_nodeID,p_itemType){if(cube.notEmpty(p_nodeID)&&(cube.isString(p_nodeID)||cube.isNumber(p_nodeID))){var node=null;$.each(me.data(),function(i,p_node){if(p_node.id===p_nodeID&&p_node.itemType===p_itemType)node=p_node});if(node!=null)return node;return me.data()["#"+p_nodeID]}};me.create=
function(p_node,p_options){p_node=$.extend(true,{},p_node);var args={};if(!me.canCreate){me._notAllowedTip();return}if($.isPlainObject(p_options)){args.parentNode=me.getNodeEntity(p_options.parentId,p_options.itemType);args.nextSibling=me.getNodeEntity(p_options.nextId,p_options.itemType);args.prevSibling=me.getNodeEntity(p_options.prevId,p_options.itemType);args.order=cube.isEmpty(p_options.order)?true:p_options.order}else args.order=true;args.node=p_node||{};var event_args=$.extend(true,{cancel:false},
args);if(event_args.cancel)return;var node=_create(args.node,args);args.node=node;event_args=$.extend(true,{},args);return node};function _create(p_node,p_args){var node=p_node,nextSibling=p_args.nextSibling,prevSibling=p_args.prevSibling,parentNode=p_args.parentNode,order=p_args.order,pk=node[me.primaryKey],data=[];node.hasChildren=cube.obj(cube.isEmpty(node.hasChildren)?false:node.hasChildren);node.expanded=cube.obj(cube.isEmpty(node.expanded)?false:node.expanded);node.childNodes=cube.array(cube.isEmpty(node.childNodes)?
[]:node.childNodes);node.visible=cube.obj(cube.isEmpty(node.visible)?true:node.visible);node.checked=cube.obj(cube.isEmpty(node.checked)?false:node.checked);node.indeterminate=cube.obj(cube.isEmpty(node.indeterminate)?false:node.indeterminate);node.imageUrl=cube.obj(cube.isEmpty(node.imageUrl)?null:node.imageUrl);if(cube.isEmpty(parentNode))if(cube.notEmpty(nextSibling))parentNode=me.data()["#"+nextSibling.parentId];else if(cube.notEmpty(prevSibling))parentNode=me.data()["#"+prevSibling.parentId];
if(cube.isEmpty(pk)){pk=guidUtil.newGUID();node[me.primaryKey]=pk}node.parentId=cube.isEmpty(parentNode)?null:parentNode[me.primaryKey];me._changedItems[pk]=new Object;for(var p in node)if(p!=me.primaryKey&&!cube.isFunction(node[p]))if(p=="text")me._changedItems[pk][me.textColName]=node[p];else me._changedItems[pk][p]=node[p];me.hasChanged(true);if(parentNode&&cube.notEmpty(parentNode.level))node.level=parentNode.level+1;else node.level=1;if(cube.notEmpty(me.data()["#"+pk])){cube.indicate("warning",
cube.msg("ERR_DUPLICATED_ITEM",[pk]));return}if(cube.isEmpty(parentNode))data=me.data||[];else data=parentNode.childNodes||[];if(data.indexOf(node)==-1){if(cube.notEmpty(data["#"+pk])){cube.indicate("warning",cube.err("DUPLICATED_ITEM",[pk]));return}if(cube.notEmpty(nextSibling)){var index=data.indexOf(nextSibling);if(index!=-1)data.splice(index,0,node)}else if(cube.notEmpty(prevSibling)){var index=data.indexOf(prevSibling);if(index!=-1)if(index==data.length)data.push(node);else data.splice(index+
1,0,node)}else order?data.push(node):data.splice(0,0,node)}else{cube.indicate("warning",cube.err("DUPLICATED_ITEM",[pk]));return}if(cube.isEmpty(data["#"+pk]))data["#"+pk]=node;if(cube.notEmpty(parentNode))parentNode.hasChildren(true);if(cube.isEmpty(me.data()["#"+pk]))me.data()["#"+pk]=node;if(cube.isArray(node.childNodes()))$.each(node.childNodes(),function(index,child){_create(child,{parentNode:node})});return node}me.remove=function(p_node,p_callback,p_path){if(me._submitting)return;me._submitting=
true;me._removeCallBack=p_callback;var args={cancel:false,node:p_node};if(args.cancel)return;_deletingNode=p_node;var IDs=[];if(cube.isArray(p_node))for(var i=0;i<p_node.length;i++)IDs.push(p_node[i].id);else IDs.push(p_node.id);if(cube.notEmpty(me.baseUrl)){var delUrl=me._makePath("remove","delete",p_path);var _post=me._getClientPostMode("remove");_post(delUrl,JSON.stringify({"ids":IDs}),_delete_callback)}else{me._submitting=false;_delete_success()}};base._prepareLocalData=me._prepareLocalData;me._prepareLocalData=
function(p_data){me.data=cube.array(p_data);var localResult={},resultValue={nodes:p_data};localResult.resultValue=resultValue;return localResult};me._parseData=function(p_result,p_parentId){var nodes=null,parentNode=_loadingNode;if(cube.isObservable(p_result.nodes))nodes=p_result.nodes();else nodes=p_result.nodes;if(cube.isEmpty(me.data()))me.data([]);if(cube.isArray(nodes)){if(cube.notEmpty(p_parentId))parentNode=me.data()["#"+p_parentId];if(cube.notEmpty(me.baseUrl))_populateNodes(nodes,parentNode);
else if(cube.notEmpty(_loadingNode)){p_result.nodes=_filterNodes();if(p_result.nodes==0&&nodes["#"+_loadingNode.id])p_result.nodes=nodes["#"+_loadingNode.id].childNodes}}};function _filterNodes(){if(cube.notEmpty(_loadingNode))if(typeof _loadingNode.childNodes=="function"&&cube.isArray(_loadingNode.childNodes()))return _loadingNode.childNodes;else if(cube.isArray(_loadingNode.childNodes))return _loadingNode.childNodes;return cube.array([])}function _clearChildren(p_node){var children=cube.isEmpty(p_node)?
me.data:p_node.childNodes;if(cube.isArray(children))while(children.length>0)_remove(children()[0],p_node)}function _populateNodes(p_nodes,p_parentNode){var data,pk;if(!cube.isArray(p_nodes))return;if(cube.isEmpty(p_parentNode)){me.data=me.data||cube.array([]);data=me.data}else{p_parentNode.childNodes=p_parentNode.childNodes||cube.array([]);data=p_parentNode.childNodes}_clearChildren(p_parentNode);$.each(p_nodes,function(index,node){me._parseNode(node,data,pk,p_parentNode)})}me._parseNode=function(node,
data,pk,p_parentNode){pk=node[me.primaryKey];node.parentId=cube.isEmpty(p_parentNode)?null:p_parentNode[me.primaryKey];node.hasChildren=cube.obj(cube.isEmpty(node.hasChildren)?false:node.hasChildren);node.expanded=cube.obj(cube.isEmpty(node.expanded)?false:node.expanded);node.childNodes=cube.array(cube.isEmpty(node.childNodes)?[]:node.childNodes);node.visible=cube.obj(cube.isEmpty(node.visible)?true:node.visible);node.checked=cube.obj(cube.isEmpty(node.checked)?false:node.checked);node.indeterminate=
cube.obj(cube.isEmpty(node.indeterminate)?false:node.indeterminate);node.imageUrl=cube.obj(cube.isEmpty(node.imageUrl)?null:node.imageUrl);if(p_parentNode&&cube.notEmpty(p_parentNode.level))node.level=p_parentNode.level+1;else node.level=1;if(data.indexOf(node)==-1)data.push(node);data()["#"+pk]=node;me.data()["#"+pk]=node;var childNodes=cube.isObservable(node.childNodes)?node.childNodes():node.childNodes;if(cube.isArray(childNodes))_populateNodes(childNodes,node);else node.childNodes=cube.array([]);
if(node.expanded()&&node.hasChildren()&&cube.notEmpty(me.baseUrl)&&childNodes.length==0){me._submitting=false;me.load(node)}};base._setLoadArgs=me._setLoadArgs;me._setLoadArgs=function(p_result,p_parentId){for(var i=0;i<_loadNode.length;i++)if(_loadNode[i]==p_parentId)_loadNode.splice(i,1);var args=new Object;if(cube.notEmpty(p_parentId))args.parentNode=me.data()["#"+p_parentId];if(_loadNode.length==0)args.triggerLoad=true;else args.triggerLoad=false;args.nodes=p_result.nodes;return args};base._setLoadingArgs=
me._setLoadingArgs;me._setLoadingArgs=function(){var newArgs={};newArgs.childItemTyps="";newArgs.itemType="";newArgs.filter="";return newArgs};function _delete_callback(p_context){me._submitting=false;if(p_context.successful)_delete_success(p_context);else _delete_error(p_context)}function _remove(p_node,p_parentNode){var parent=p_parentNode;if(typeof p_node.childNodes=="function"&&cube.isArray(p_node.childNodes())&&p_node.childNodes().length>0){var childNodes=p_node.childNodes();while(childNodes.length>
0)_remove(childNodes[0],p_node)}else if(cube.isArray(p_node.childNodes)&&p_node.childNodes.length>0){var childNodes=p_node.childNodes;while(childNodes.length>0)_remove(childNodes[0],p_node)}if(cube.isEmpty(parent)){var index=me.data.indexOf(p_node);if(index>=0&&index<me.data().length)me.data.splice(index,1)}else if(typeof parent.childNodes=="function"&&cube.isArray(parent.childNodes()))parent.childNodes.remove(p_node);else if(cube.isArray(parent.childNodes))parent.childNodes.remove(p_node);delete me.data()["#"+
p_node[me.primaryKey]]}function _delete_success(p_result){if(cube.isArray(_deletingNode))for(var i=0;i<_deletingNode.length;i++){var removeNode=me.getNodeEntity(_deletingNode[i].id,_deletingNode[i].itemType);if(removeNode)_remove(removeNode,me.data()["#"+_deletingNode[i].parentId])}else{var removeNode=me.getNodeEntity(_deletingNode.id,_deletingNode.itemType);if(removeNode)_remove(removeNode,me.data()["#"+_deletingNode.parentId])}var args={node:_deletingNode};if(cube.notEmpty(me._removeCallBack))me._removeCallBack(args)}
function _delete_error(p_context){me._showError("DELETING",p_context)}return me}});