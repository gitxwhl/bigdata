define(["Validator","JSONUtil"],function(i,j){function g(f){function g(a){var d=$.Deferred(),c=new FileReader;c.onload=function(a){d.resolve(a.target.result)};c.onerror=d.reject;c.onprogress=d.notify;c.readAsDataURL(a);return d.promise()}var a=this;a.name="";a.value="";a.width="auto";a.height="auto";a.textareaHeight="200px";a.readOnly=!1;a.isShowCodeBtn=!1;a.validType=null;a.validOptions=null;a.validStatus=null;a.validHint=null;a.style="";a.isCodeMode=!1;a.cmdLists=[{type:"list",cmdKey:"FontName",
desc:"\u5b57\u4f53",options:[{name:"\u5b8b\u4f53",value:"\u5b8b\u4f53"},{name:"\u5fae\u8f6f\u96c5\u9ed1",value:"\u5fae\u8f6f\u96c5\u9ed1"},{name:"\u6977\u4f53",value:"\u6977\u4f53"},{name:"Serif",value:"Serif"},{name:"Sans",value:"Sans"},{name:"Arial",value:"Arial"},{name:"Arial Black",value:"Arial Black"},{name:"Courier",value:"Courier"},{name:"Courier New",value:"Courier New"},{name:"Comic Sans MS",value:"Comic Sans MS"},{name:"Helvetica",value:"Helvetica"},{name:"Times",value:"Times"},{name:"Times New Roman",
value:"Times New Roman"}],isShowOptions:cube.obj(!1),value:cube.obj("\u5b8b\u4f53"),icon:"icon-font"},{type:"list",cmdKey:"FontSize",desc:"\u5b57\u4f53\u5927\u5c0f",options:[{name:"\u5927\u53f7",value:5},{name:"\u4e2d\u53f7",value:3},{name:"\u5c0f\u53f7",value:1}],isShowOptions:cube.obj(!1),value:cube.obj("\u5927\u53f7"),icon:"icon-text-height"},{type:"group",items:[{type:"complex",cmdKey:"ForeColor",desc:"\u5b57\u4f53\u989c\u8272",icon:"icon-heart",value:cube.obj(""),options:{editorType:"color"},
isShowOptions:cube.obj(!1)},{type:"complex",cmdKey:"BackColor",desc:"\u6587\u5b57\u80cc\u666f",icon:"icon-tags",value:cube.obj(""),options:{editorType:"color"},isShowOptions:cube.obj(!1)}]},{type:"group",items:[{type:"single",cmdKey:"Bold",desc:"\u7c97\u4f53",icon:"icon-bold",value:cube.obj("")},{type:"single",cmdKey:"Italic",desc:"\u659c\u4f53",icon:"icon-italic",value:cube.obj("")},{type:"single",cmdKey:"Strikethrough",desc:"\u5220\u9664",icon:"icon-strikethrough",value:cube.obj("")},{type:"single",
cmdKey:"Underline",desc:"\u4e0b\u5212\u7ebf",icon:"icon-underline",value:cube.obj("")}]},{type:"group",items:[{type:"single",cmdKey:"InsertUnorderedList",desc:"\u9879\u76ee\u7f16\u53f7",icon:"icon-list-ul",value:cube.obj("")},{type:"single",cmdKey:"Insertorderedlist",desc:"\u6570\u5b57\u7f16\u53f7",icon:"icon-list-ol",value:cube.obj("")},{type:"single",cmdKey:"Outdent",desc:"\u51cf\u5c11\u7f29\u8fdb",icon:"icon-indent-main",value:cube.obj("")},{type:"single",cmdKey:"Indent",desc:"\u7f29\u8fdb",icon:"icon-indent-right",
value:cube.obj("")}]},{type:"group",items:[{type:"single",cmdKey:"Justifyleft",desc:"\u5c45\u5de6",icon:"icon-align-main",value:cube.obj("")},{type:"single",cmdKey:"Justifycenter",desc:"\u5c45\u4e2d",icon:"icon-align-center",value:cube.obj("")},{type:"single",cmdKey:"Justifyright",desc:"\u5c45\u53f3",icon:"icon-align-right",value:cube.obj("")},{type:"single",cmdKey:"Justifyfull",desc:"\u4e24\u7aef\u5bf9\u9f50",icon:"icon-align-justify",value:cube.obj("")}]},{type:"group",items:[{type:"complex",cmdKey:"createLink",
desc:"\u8d85\u7ea7\u94fe\u63a5",icon:"icon-link",value:cube.obj(""),options:{editorType:"text"},isShowOptions:cube.obj(!1)},{type:"single",cmdKey:"Unlink",desc:"\u53d6\u6d88\u8d85\u7ea7\u94fe\u63a5",icon:"icon-cut",value:cube.obj("")}]},{type:"group",items:[{type:"complex",cmdKey:"InsertImg",desc:"\u63d2\u5165\u56fe\u7247",icon:"icon-picture",value:cube.obj(""),options:{editorType:"file"},isShowOptions:cube.obj(!1)}]},{type:"group",items:[{type:"single",cmdKey:"Undo",desc:"\u64a4\u9500",icon:"icon-undo",
value:cube.obj("")},{type:"single",cmdKey:"Redo",desc:"\u91cd\u65b0\u952e\u5165",icon:"icon-repeat",value:cube.obj("")}]},{type:"group",items:[{type:"single",cmdKey:"CUBE_CODE",desc:"\u7f16\u8f91\u6e90\u7801",icon:"icon-edit",value:cube.obj("")}]}];a.curCmd=null;a.fontName=null;a.fontSize=null;a.selectionRange=null;var h=!0;a.onChanged=null;a._init=function(){var b=a.style(),d=a.width(),c=a.height();b.indexOf("width")==-1&&(b=b+";width:"+d+";");b.indexOf("height")==-1&&(b=b+";height:"+c+";");a.style(b);
a.valueSub=cube.subscribe(a.value,a._changed);if(typeof f.maxLength!="undefined")b=a.validOptions(),b==null&&(b={}),b.maxLength=f.maxLength,a.validOptions(b);if(typeof f.nullable!="undefined"&&(!f.nullable||!f.nullable()))b=a.validType(),b==null?b="NOTNULL":b+=",NOTNULL",a.validType(b)};a.getEditorSelection=function(){a.isCodeMode()||a.saveSelection()};a.showOptions=function(){!a.isCodeMode()&&!a.readOnly()&&(a.curCmd(this),this.isShowOptions(!0),a.restoreSelection())};a.hiddenOptions=function(){a.isCodeMode()||
this.isShowOptions(!1)};a.execCommand=function(b){a.readOnly()||(a.curCmd()!=null&&(a.curCmd().cmdKey=="FontName"?a.fontName(b.name):a.curCmd().cmdKey=="FontSize"&&a.fontSize(b.name)),a.isCodeMode()?a.curCmd().cmdKey=="CUBE_CODE"&&a.isCodeMode(!a.isCodeMode()):(a.restoreSelection(),this.cmdKey!=null&&a.curCmd(this),a.curCmd().type=="list"&&a.curCmd().value(this.value),a.curCmd().cmdKey=="CUBE_SAVE"?a.value($("div.richeditor").html()):a.curCmd().cmdKey=="CUBE_CODE"?(a.value($("div.richeditor").html()),
a.isCodeMode(!a.isCodeMode())):this.options!=null&&this.options.editorType=="file"?/^image\//.test(this.value().type)&&$.when(g(this.value())).done(function(a){document.execCommand("insertimage","false",a)}):document.execCommand(a.curCmd().cmdKey,0,a.curCmd().value()),(a.curCmd().type=="list"||a.curCmd().type=="complex")&&a.curCmd().isShowOptions(!1),a.saveSelection()))};a._changed=function(){if(a.onChanged!=null&&!cube.isObservable(a.onChanged))a.onChanged(a.name(),a.value())};a._valid=function(b,
d){var c=d.target.innerText.replace(/(\n)/g,""),e=d.target.innerHTML;h=!1;a.value(e);h=!0;e=a.validType();e!=null&&(c=i.validate(c,e,a.validOptions()),c.successful?(a.validHint(""),a.validStatus("")):(a.validHint(c.hint),a.validStatus("error")))};a._click=function(b,d){var c=d.target;if(c){var c=$(c),e=c.css("font-family"),c=c.attr("size");j.getItem(a.cmdLists(),"name",e,3)?a.fontName(e):a.fontName(null);c==5?a.fontSize("\u5927\u53f7"):c==3?a.fontSize("\u4e2d\u53f7"):c==1?a.fontSize("\u5c0f\u53f7"):
a.fontSize(null)}};a.saveSelection=function(){var b=null;if(window.getSelection){var d=window.getSelection($("div.richeditor"));d.getRangeAt&&d.rangeCount&&(b=d.getRangeAt(0))}else document.selection&&(b=document.selection.createRange());if(b!=null)a.selectionRange=b};a.restoreSelection=function(){var b;if(a.selectionRange&&!cube.isObservable(a.selectionRange))if(window.getSelection){b=window.getSelection($("div.richeditor"));try{b.removeAllRanges()}catch(d){document.body.createTextRange().select(),
document.selection.empty()}b.addRange(a.selectionRange)}else document.selection&&(selrange=document.selection.createRange(a.selectionRange))};ko.bindingHandlers.editableHtml={init:function(){},update:function(a,d){if(h){var c=ko.utils.unwrapObservable(d());$(a).html(c)}}};a.onload=function(b){b=$(b);if(a.height()!="auto"||a.style().indexOf("height")!=-1){var d=b.find(".btn-toolbar").outerHeight();a.textareaHeight(parseInt(b.height())-parseInt(d)-10+"px")}};cube.endViewModel(a,f)}g.prototype.dispose=
function(){this.valueSub.dispose()};return g});