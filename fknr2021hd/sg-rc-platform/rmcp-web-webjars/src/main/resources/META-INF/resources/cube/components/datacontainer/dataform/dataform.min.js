define(["entityContainer","JSONUtil","PrintUtil","FileUploader","Validator"],function(y,m,z,s,t){function n(n){function A(a){var d=a.columns,c={},c=cube.isEmpty(a.items)?{}:cube.isArray(a.items)?a.items[0]:a.items;cube.isEmpty(c)&&(c={});p=0;b.fields([]);b.dicts(a.dicts);_fieldCells=[];B(d,c,a.dicts);if(b.isCustomTemplate()==!0&&u==!0)b.onload(l);b.isShowLoading(!1);if(b.onLoad!=null&&!cube.isObservable(b.onLoad))b.onLoad(b.data)}function C(a){b.isShowLoading(!1);if(b.onLoadError!=null&&!cube.isObservable(b.onLoadError))b.onLoadError(a)}
function B(a,d,c){var e=cube.clone(o);if(cube.isEmpty(a)||a.length<=0){if(a=m.getItem(e,"name",f.primaryKey,3),cube.notEmpty(a))a.readOnly=!0,a.nullable=cube.obj(!1),a.visible=b.displayPrimaryKey()}else $.each(a,function(a,b){if(cube.isArray(b))for(var f=0;f<b.length;f++)!cube.notEmpty(b[f].isGroupInfo)&&!cube.notEmpty(b[f].isLine)&&v(b[f],e,c,d);else cube.isEmpty(b.isGroupInfo)&&cube.isEmpty(b.isLine)&&v(b,e,c,d)});b.data=d!=null?d:{};b.fields(e);q=cube.clone(b.data)}function v(a,b,c,e){var f=D(a.name,
b);if(cube.notEmpty(f)){for(i in a)i=="length"&&delete a[i];$.each(a,function(a,b){if(cube.isEmpty(f[a])||cube.isEqual(a,"readOnly")||cube.isEqual(a,"maxLength")||cube.isEqual(a,"nullable"))f[a]=b});w(f,c,e)}else f=a,f.validStatus=cube.obj(""),f.validHint=cube.obj(""),w(f,c,e),b.push(f)}function w(a,d,c){cube.isEqual(a.name,f.primaryKey)?(a.readOnly=!0,a.nullable=cube.obj(!1),a.visible=b.displayPrimaryKey()):typeof a.value!="undefined"&&typeof c[a.name]=="undefined"&&f.setValue(c,a.name,cube.isObservable(a.value)?
a.value():a.value,!0);if(a.editorType=="DropDownEditor"||a.editorType=="CheckListEditor"||a.editorType=="ListEditor"||a.editorType=="LabelEditor"){if(d&&d[a.name])cube.isObservable(a.list)?a.list(d[a.name]):a.list=d[a.name]}else if(a.editorType=="FileEditor")if(a.pkVal&&cube.isObservable(a.pkVal))cube.isEmpty(a.pkVal())&&a.pkVal(f.data[f.primaryKey]);else if(cube.isEmpty(a.pkVal))a.pkVal=cube.obj(f.data[f.primaryKey]);if(cube.isEmpty(a.nullable))a.nullable=cube.obj(!0);else if(!cube.isObservable(a.nullable))a.nullable=
cube.obj(a.nullable);typeof a.validStatus=="undefined"?a.validStatus=cube.obj(""):cube.isObservable(a.validStatus)?a.validStatus(""):a.validStatus=cube.obj(a.validStatus);if(cube.notEmpty(a.visible)&&!cube.isObservable(a.visible))a.visible=cube.obj(a.visible);if(cube.notEmpty(a.readOnly)&&!cube.isObservable(a.readOnly))a.readOnly=cube.obj(a.readOnly);return b.editors[a.name]=a}function D(a,b){var c=null,e=o;typeof b!=null&&(e=b);cube.notEmpty(a)&&cube.isArray(e)&&e.length>0&&(c=m.getItem(e,"name",
a),cube.isEmpty(c)&&(c=m.getItem(e,"name",a,3)));return c}function x(a,d,c,e){if(cube.isEmpty(a))c[e]={columns:d};else if(cube.isEmpty(a.columns))a.columns=d;else if(cube.isString(a.columns)){for(var d=d.split(","),c=a.columns.split(","),e=d.length,f=0;f<e;f++)c.indexOf(d[f])==-1&&c.push(d[f]);a.columns=c.join(",");d.length=0;c.length=0}else b.showError("ERR_UNSUPPORTED_FORMAT",[a.columns])}function E(a){if(b.isRefreshPk())for(var d=b.fields(),c=0;c<d.length;c++)if(cube.isArray(d[c]))for(var e=0;e<
d[c].length;e++){if(d[c][e].editorType=="FileEditor"&&cube.isArray(a.result)&&a.result.length>0&&d[c][c].type!="path"){var j=a.result,h=f.primaryKey,k=d[c][e],g=new s;g.url=k.url;g.refreshPk(j,h,k)}}else if(!cube.isString(d[c])&&cube.isEmpty(d[c].isGroupInfo)&&cube.isEmpty(d[c].isLine)&&d[c].editorType=="FileEditor"&&cube.isArray(a.result)&&a.result.length>0&&d[c].type!="path")e=a.result,j=f.primaryKey,h=d[c],k=new s,k.url=h.url,k.refreshPk(e,j,h);if(b.onSaved!=null&&!cube.isObservable(b.onSaved))b.onSaved(a)}
var b=this,f=new y;b.url="";b.actions={};b.timeout=null;b.customHeaders=null;b.loadByPost=!1;b.primaryKey="id";b.loadMeta=!0;b.displayPrimaryKey=!1;b.displaySubmitButton=!0;b.displaySaveButton=!1;b.displayResetButton=!1;b.buttonAlign=null;b.id=null;b.param=null;b.cols=1;b.style="";b.fields=[];b.editors=null;b.data=null;b.dicts=null;b.isEditState=!0;b.isShowPopDialog=!1;b.validHintType="inline";b.separator="";b.isCustomTemplate=!1;b.isSaveAll=!1;b.customBtns=[];b.isShowLoading=!1;b.isRefreshPk=!0;
b.onSubmit=null;b.onSaved=null;b.onLoad=null;b.onLoadError=null;var o=b.onRendered=null,q=null,u=!1,l=null,p=0;b._init=function(){b.editors={};var a=b.data()||{};$.each(b.fields(),function(d,c){if(cube.isArray(c))for(var e=0;e<c.length;e++)b._initField(c[e],a);else!cube.isString(c)&&cube.isEmpty(c.isGroupInfo)&&cube.isEmpty(c.isLine)&&b._initField(c,a)});b.data(a);o=cube.clone(b.fields());q=cube.clone(a);f.primaryKey=b.primaryKey();f.baseUrl=b.url();f.actions=b.actions();f.meta=o;f.type="form";f.loadMeta=
b.loadMeta();f.timeout=b.timeout();f.onload=A;f.onsaved=E;f.onerror=C;f.data=b.data();f.dicts=b.dicts();f.customHeaders=b.customHeaders();f.loadByPost=b.loadByPost();f.init();b.actionsSub=cube.subscribe(b.actions,function(a){f.actions=a});b.idSub=cube.subscribe(b.id,function(){b.load(b.id(),b.param())});if(cube.isEmpty(b.url()))b.dataSub=cube.subscribe(b.data,function(a){f.data=a;b.load(b.id(),b.param())});b.load(b.id(),b.param())};b._initField=function(a,d){if(!cube.notEmpty(a.isLine))if(cube.notEmpty(a.isGroupInfo))if(typeof a.expanded==
"undefined")a.expanded=cube.obj(!0);else{if(!cube.isObservable(a.expanded))a.expanded=cube.obj(a.expanded)}else{if(typeof a.validStatus=="undefined")a.validStatus=cube.obj("");else if(!cube.isObservable(a.validStatus))a.validStatus=cube.obj(a.validStatus);if(typeof a.validHint=="undefined")a.validHint=cube.obj("");else if(!cube.isObservable(a.validHint))a.validHint=cube.obj(a.validHint);if(a.name==b.primaryKey())a.visible=b.displayPrimaryKey();if(!a.editorType)a.editorType="TextEditor";if(a.editorType==
"DropDownEditor"||a.editorType=="CheckListEditor"||a.editorType=="ListEditor"||a.editorType=="LabelEditor")if(a.list){if(!cube.isObservable(a.list))a.list=cube.array(a.list)}else a.list=cube.array([]);else if(a.editorType=="FileEditor")if(a.pkVal){if(!cube.isObservable(a.pkVal))a.pkVal=cube.obj(a.pkVal)}else a.pkVal=cube.obj(null);if(cube.isEmpty(a.nullable))a.nullable=cube.obj(!0);else if(!cube.isObservable(a.nullable))a.nullable=cube.obj(a.nullable);if(typeof a.value!="undefined"&&typeof d[a.name]==
"undefined")d[a.name]=a.value;b.editors[a.name]=a}};b.submitForm=function(a){arguments.length==1&&cube.isBoolean(a)||(a=b.isSaveAll());if(b.validate()){if(b.onSubmit!=null&&!cube.isObservable(b.onSubmit)){var d={cancel:!1,data:cube.isObservable(b.data)?b.data():b.data};b.onSubmit(d);if(d.cancel)return!1}f.save(a)}else return!1;return!0};b.reset=function(){f.data=cube.clone(q);f.clearChanges();b.load(b.id(),b.param());if(b.onReset!=null&&!cube.isObservable(b.onReset))b.onReset()};b.submitFiles=function(){for(var a=
b.fields(),d=null,c=0;c<a.length;c++)if(cube.isArray(a[c]))for(var e=0;e<a[c].length;e++)a[c][e].editorType=="FileEditor"&&(d=cube.getPageViewModelByNode($(l).find("#"+a[c][e].name)))&&d.uploadFiles&&d.uploadFiles();else!cube.isString(a[c])&&cube.isEmpty(a[c].isGroupInfo)&&cube.isEmpty(a[c].isLine)&&a[c].editorType=="FileEditor"&&(d=cube.getPageViewModelByNode($(l).find("#"+a[c].name)))&&d.uploadFiles&&d.uploadFiles()};b.setActions=function(a){b.actions(cube.isObservable(a)?a():a);f.actions=a};b.load=
function(a,d){b.isShowLoading(!0);var c=null,e=null;if(cube.isEmpty(a)||cube.isString(a)||cube.isNumber(a)){if(c=a,cube.isEmpty(d)||$.isPlainObject(d))e=d}else $.isPlainObject(a)&&(e=a);var j;j=b.fields();if(r==null){var h=[];if(cube.notEmpty(j))for(var k=0;k<j.length;k++){var g=j[k];if(cube.isArray(g))for(var l=0;l<g.length;l++)$.isPlainObject(g[l])&&h.push(g[l].name);else $.isPlainObject(g)&&h.push(g.name)}r=h}j=r;j=j.length>0?j.join(","):null;if(cube.notEmpty(e)&&cube.isEmpty(e.dataParams)&&cube.isEmpty(e.metaParams))h=
{},h.dataParams=e,e=h;cube.notEmpty(j)&&cube.isString(j)&&(cube.isEmpty(e)?e={metaParams:{columns:j},dataParams:{columns:j}}:(x(e.metaParams,j,e,"metaParams"),x(e.dataParams,j,e,"dataParams")));f.load(c,e)};b.print=function(){z.print(b.data,b.fields,b.dicts,"dataform")};var r=null;b.validate=function(){for(var a=b.fields(),d=null,d=null,c=0;c<a.length;c++)if(cube.isArray(a[c]))for(var e=0;e<a[c].length;e++){if(!cube.notEmpty(a[c][e].isGroupInfo)&&!cube.notEmpty(a[c][e].isLine)&&(d=cube.isObservable(a[c][e].visible)?
a[c][e].visible():a[c][e].visible,cube.isEmpty(d)||d==!0))if(d=b.valid(a[c][e]),d.validStatus()!="")return!1}else if(!cube.isString(a[c])&&cube.isEmpty(a[c].isGroupInfo)&&cube.isEmpty(a[c].isLine)&&(d=cube.isObservable(a[c].visible)?a[c].visible():a[c].visible,cube.isEmpty(d)||d==!0))if(d=b.valid(a[c]),d.validStatus()!="")return!1;return!0};b.valid=function(a){if((cube.isObservable(a.visible)?a.visible():a.visible)===!1)return a.validStatus(""),a.validHint(""),b.isShowPopDialog(!1),a;if(cube.notEmpty(a.validStatus()))return a;
var d=f.data[a.name];cube.isObservable(d)&&(d=d());if(a.editorType=="NumberEditor"){var c=t.validate(d,"DIGIT",null);c.successful||(d="")}var e;a.customValidate!=null&&cube.isFunction(a.customValidate)&&!cube.isObservable(a.customValidate)&&(e=a.customValidate(d));var j=b.validHintType();cube.notEmpty(a.validHintType)&&(j=cube.isObservable(a.validHintType)?a.validHintType():a.validHintType);if(e===!1||$.isPlainObject(e)&&e.successful===!1)return a.validStatus("error"),$.isPlainObject(e)&&e.hint&&
(j=="pop"?(b.isShowPopDialog(!1),b.isShowPopDialog(!0),cube.showPopDialog($(l).find("#"+a.name),{content:e.hint,popoverDirection:"bottom",msgType:"error",isShowDialog:b.isShowPopDialog})):a.validHint(e.hint)),a;c=a.validType;e=cube.isObservable(a.nullable)?a.nullable():a.nullable;typeof e!="undefined"&&e===!1&&(c==null?c="NOTNULL":c.indexOf("NOTNULL")==-1&&(c+=", NOTNULL"));if((cube.isEmpty(c)||c.indexOf("NOTNULL")==-1)&&cube.isEmpty(d))return a;c!=null&&(c=t.validate(d,c,a.validOptions),c.successful?
(a.validStatus(""),a.validHint(""),b.isShowPopDialog(!1)):(a.validStatus("error"),j=="pop"?(b.isShowPopDialog(!1),b.isShowPopDialog(!0),cube.showPopDialog($(l).find("#"+a.name),{content:c.hint,popoverDirection:"bottom",msgType:"error",isShowDialog:b.isShowPopDialog})):a.validHint(c.hint)));return a};b._editor_changed=function(a,d){f!=null&&cube.notEmpty(f.data[b.primaryKey()])&&f.setValue(f.data,a,d,!0);var c=m.getItem(b.fields(),"name",a,3);if(cube.notEmpty(c)&&typeof c.onChanged=="function")c.onChanged(d)};
b._editor_upload=function(a,d){if(f!=null&&cube.notEmpty(f.data[b.primaryKey()])&&(f.setValue(f.data,a,d,!0),b.editors!=null&&(!cube.isEmpty(f.data[a])||!cube.isEmpty(d)))){var c=b.editors[a];c&&(c.validStatus(""),b.valid(b.editors[a]))}};b.customBtnClick=function(a,d){var c=!0;cube.notEmpty(d)&&d==!0&&(c=b.validate());cube.isFunction(a)&&c&&a()};b.expandGroup=function(a){a[0].expanded(!a[0].expanded())};b.getEditorParam=function(a){var d=cube.clone(a),c=cube.isObservable(b.data)?b.data():b.data;
cube.isObservable(d.value)?(c=c[a.name],d.value(cube.isObservable(c)?c._latestValue:c)):d.value=c[a.name];d.readOnly=b.isEditState()?typeof a.readOnly!="undefined"?a.readOnly:!1:!0;if(cube.isEmpty(d.validHintType))d.validHintType=b.validHintType;d.isShowPopDialog=b.isShowPopDialog;d.onChanged=b._editor_changed;d.onRendered=b.editorRendered;if(a.editorType=="FileEditor")d.onChanged=b._editor_upload;if(a.editorType=="DateTimeEditor"||a.editorType=="RichEditor")d.width=typeof a.width!="undefined"?a.width:
b.cols()>1?null:"85%";else if(a.editorType!="DateTimeEditor"&&a.editorType!="FileEditor"&&a.editorType!="RichEditor")d.width=typeof a.width!="undefined"?a.width:b.cols()>1?null:a.editorType=="DropDownEditor"||a.editorType=="DropDownTreeEditor"?"auto":"85%";return d};b.renderEditor=function(a,d){var c=a.renderEditor(d);b.triggerRendered();return c};b.editorRendered=function(a,d){if(cube.notEmpty(d)&&cube.isFunction(d.onRendered))d.onRendered(a,d);b.triggerRendered()};b.triggerRendered=function(){p++;
if(p==b.fields().length&&b.onRendered!=null&&!cube.isObservable(b.onRendered))b.onRendered(l,this)};b.onload=function(a,d){u=!0;l=a;if(b.isCustomTemplate()==!0)for(var c=$(a).find("*[option]"),e={},f=0;f<c.length;f++){var h=$(c[f]);cube.cleanNode(h);var k=h.attr("option"),g=k.substring(0,k.lastIndexOf(".")),e=k.substring(k.lastIndexOf(".")+1),g=b.editors[g],d={editors:b.editors},k="visible: typeof(editors['"+g.name+"'].visible) != 'undefined' ? editors['"+g.name+"'].visible : true";if(e=="editor"){var e=
b.getEditorParam(g),m="commoneditor";if(g.editorType=="DateTimeEditor"||g.editorType=="FileEditor"||g.editorType=="RichEditor")m=g.editorType.toLowerCase();e={component:{name:m,params:e}};h.attr("data-bind",k+" , attr: {id:'"+g.name+"', 'class' : 'form-inline control-group form-custom ' + editors['"+g.name+"'].validStatus()+' "+g.name+(h.is("span")?" editor-option":"")+"',title:editors['"+g.name+"'].validHint()}");cube.bindComponentByNode(h,e)}else e=="validHint"?h.attr("data-bind","css:'text-error', text: editors['"+
g.name+"'].validHint()"):e=="visible"?h.attr("data-bind",k):h.attr("data-bind","text: '"+g[e]+"', "+k);cube.bindTemlate(h,d);h.is("span")&&h.addClass("editor-option")}};cube.endViewModel(b,n)}cube.importComponent("editor.commoneditor");cube.importComponent("editor.datetimeeditor");cube.importComponent("editor.dropdowneditor");cube.importComponent("editor.dropdowntreeeditor");cube.importComponent("editor.fileeditor");cube.importComponent("datacontainer.datagrid");cube.importComponent("controls.loading");
n.prototype.dispose=function(){this.isShowPopDialog(!1);this.idSub.dispose();this.actionsSub.dispose();this.dataSub!=null&&this.dataSub.dispose()};return n});