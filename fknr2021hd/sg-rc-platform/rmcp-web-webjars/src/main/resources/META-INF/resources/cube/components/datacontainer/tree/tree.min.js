define(["treeEntityContainer"],function(m){function i(i){function k(){var b=a.nodes();cube.notEmpty(a.selectedNodeId())&&(a.selectedNode(b["#"+a.selectedNodeId()]),a.setExpandedById(a.selectedNodeId()));if(cube.notEmpty(a.checkedNodeId()))for(var d=a.checkedNode(),c=a.checkedNodeId(),e=0;e<c.length;e++){var g=b["#"+c[e]];cube.notEmpty(g)&&d.indexOf(g)==-1&&(g.checked(!0),a.checkedNode.push(g),a.checkCascade()&&a.checkCascadeNodes(g,!0))}a.isShowLoading(!1);if(a.onLoaded!=null&&!cube.isObservable(a.onLoaded))a.onLoaded(a.nodes())}
function n(b){a.isShowLoading(!1);a.isNodeShowLoading(!1);if(a.onLoadError!=null&&!cube.isObservable(a.onLoadError))a.onLoadError(b)}var a=this,f=new m;a.width="auto";a.height="auto";a.url="";a.primaryKey="id";a.timeout=null;a.loadByPost=!1;a.textColName="text";a.args=null;a.keyword=null;a.autoLoad=!0;a.type="default";a.isEnabledContextMenu=!1;a.addLevel=0;a.isShowCheckbox=!1;a.checkboxType="checkbox";a.onlyCheckedOne=!1;a.isShowBorder=!0;a.isShowBorderShadow=!1;a.isAllowEdit=!1;a.checkCascade=!0;
a.onlyCheckLeafNode=!1;a.contextMenuItems=[{text:cube.msg("EDIT"),route:"#edit",icon:"edit"},{text:cube.msg("ADD"),route:"#add",icon:"plus"},{text:cube.msg("DELETE"),route:"#delete",icon:"remove"}];a.nodes=[];a.selectedNode=null;a.selectedNodeId=null;a.checkedNode=[];a.checkedNodeId=[];a.customHeaders=null;a.isEnabledAccordion=!1;a.isShowLoading=!1;a.readOnlyCondition=null;a.isNodeShowLoading=!1;a._editedItem=null;a._showeditedItem=null;a.ctxMenuEdit=!1;a.level=1;a.onToggleExpand=null;a.onSelectedChanged=
null;a.onCheckedChanged=null;a.onRemoveSelected=null;a.onDblClickTreeNode=null;a.onCtxMenuItemChanged=null;a.onNodeSaving=null;a.onNodeSaved=null;a.onLoaded=null;a.onLoadError=null;a.mouseLeft=cube.obj("");a.mouseTop=cube.obj("");a._init=function(){a.type()=="menu"&&(a.isAllowEdit(!1),a.isShowCheckbox(!1));a.selectedNodeIdSub=cube.subscribe(a.selectedNodeId,function(b){a.setExpandedById(b)});a.urlSub=cube.subscribe(a.url,function(b){f.baseUrl=b;a.load()});a.argsSub=cube.subscribe(a.args,function(){a.load()});
a.checkNodeIdSub=cube.subscribe(a.checkedNodeId,function(b){for(var d=a.nodes(),c=a.checkedNode(),e=0;e<b.length;e++){var g=d["#"+b[e]];cube.notEmpty(g)&&c.indexOf(g)==-1&&(g.checked(!0),a.checkedNode.push(g),a.checkCascade()&&a.checkCascadeNodes(g,!0))}for(e=c.length-1;e>=0;e--)g=c[e],b.indexOf(g.id)==-1&&(g.checked(!1),a.checkCascade()&&a.checkCascadeNodes(g,!1),a.checkedNode.remove(g))});a.checkedNodeSub=cube.subscribe(a.checkedNode,function(b){if(b.length==0){var b=a.nodes(),d;for(d in b)b[d]&&
typeof b[d].checked=="function"&&(b[d].checked(!1),b[d].indeterminate(!1))}});a.keywordSub=cube.subscribe(a.keyword,a.filterNodes);f.baseUrl=a.url();f.type="tree";f.primaryKey=a.primaryKey();f.textColName=a.textColName();f.timeout=a.timeout();f.data=a.nodes;f.customHeaders=a.customHeaders();f.loadByPost=a.loadByPost();f.onload=k;f.onerror=n;f.init();a.autoLoad()&&a.load()};a.filterNodes=function(b,d){var c=null,c=cube.notEmpty(d)?d.childNodes():a.nodes(),e=0;if(cube.notEmpty(b))for(var g=a.textColName(),
f=c.length-1;f>=0;f--){var h=0;c[f].hasChildren()&&(h=a.filterNodes(b,c[f]));c[f][g].indexOf(b)!=-1||h>0?(c[f].visible(!0),e++):c[f].visible(!1)}else for(f=c.length-1;f>=0;f--)c[f].visible(!0);return e};a.getNodeById=function(b){return a.nodes()["#"+b]};a.checkChildNodes=function(b,d){var c=b.childNodes;cube.isObservable(c)&&(c=c());$.each(c,function(){this.indeterminate(!1);d?(this.checked(!0),a.checkedNode.push(this),a.checkedNodeId.push(String(this.id))):(this.checked(!1),a.checkedNode.remove(this),
a.checkedNodeId.remove(String(this.id)));(cube.isObservable(this.hasChildren)&&this.hasChildren()==!0||this.hasChildren==!0)&&a.checkChildNodes(this,d)})};a.checkParentNodes=function(b,d){var c=null,e=a.nodes(),g=[],f=a.checkedNode();b&&(c=e["#"+b.parentId]);d||(b.indeterminate(!1),c&&c.indeterminate(!1));if(c)for(;c;){g=c.childNodes;cube.isObservable(g)&&(g=g());var h=0,i=0;$.each(g,function(){(f.indexOf(this)!=-1||this.checked())&&h++;this.indeterminate()&&i++});if(h!=0&&h==g.length)if(a.checkboxType()==
"checkbox"){if(!a.onlyCheckLeafNode()||a.onlyCheckLeafNode()&&!c.hasChildren())a.checkedNode.push(c),a.checkedNodeId.push(String(c.id));c.checked(!0);c.indeterminate(!1)}else c.indeterminate(!0);else a.checkboxType()=="checkbox"&&(c.checked(!1),a.checkedNode.remove(c),a.checkedNodeId.remove(String(c.id))),h==0&&i==0?c.indeterminate(!1):c.indeterminate(!0);c=e["#"+c.parentId]}};a.expandNode=function(b,d){var b=b||this,d=cube.isNumber(d)?d:a.level(),c=cube.isObservable(b.hasChildren)?b.hasChildren():
b.hasChildren,e=cube.isObservable(b.childNodes)?b.childNodes():b.childNodes;if(cube.notEmpty(a.url())&&c&&(cube.isEmpty(e)||e.length==0))a.isNodeShowLoading(!0),f.onload=null,f.load(b,function(c){b.childNodes(c.nodes);a.isNodeShowLoading(!1);a.checkCascade()&&a.checkedNode().indexOf(b)!=-1&&a.checkChildNodes(b,!0)});b.expanded(!b.expanded());if(a.onToggleExpand!=null&&!cube.isObservable(a.onToggleExpand))a.onToggleExpand(b,d,b.expanded())};a.checkNode=function(b,d){var c=$(d.currentTarget?d.currentTarget:
d.srcElement);if(a.checkboxType()=="radio"){var e=a.nodes(),f=null;b&&(f=e["#"+b.parentId]);var l=!1;a.checkedNode().indexOf(b)!=-1&&(c.attr("checked",!1),l=!0);if(a.onlyCheckedOne())for(var h in e)e[h]&&typeof e[h].checked=="function"&&(e[h].checked(!1),a.checkedNode.remove(e[h]),a.checkedNodeId.remove(e[h].id));else f?(c=f.childNodes,cube.isObservable(c)&&(c=c()),$.each(c,function(){this.checked(!1);a.checkedNode.remove(this);a.checkedNodeId.remove(this.id)})):$.each(e,function(){this.checked(!1);
a.checkedNode.remove(this);a.checkedNodeId.remove(this.id)});l||a.checkedNode.push(b)}a.checkedNode().indexOf(this)!=-1?(this.checked(!0),a.checkedNodeId.push(this.id)):(this.checked(!1),a.checkedNodeId.remove(this.id));a.checkCascade()&&a.checkCascadeNodes(this,this.checked());if(a.onCheckedChanged!=null&&!cube.isObservable(a.onCheckedChanged))a.onCheckedChanged(a.checkedNode());return!0};a.checkCascadeNodes=function(b,d){a.checkboxType()=="checkbox"&&(cube.isObservable(b.hasChildren)&&b.hasChildren()==
!0||b.hasChildren==!0)&&a.checkChildNodes(b,d);a.checkParentNodes(b,d)};a.selectNode=function(b,d){a.nodes();var b=b||this,d=cube.isNumber(d)?d:a.level(),c=cube.isObservable(b.hasChildren)?b.hasChildren():b.hasChildren;if(!a.onlyCheckLeafNode()||!c)if(a.selectedNode(b),a.selectedNodeId(b.id),a.onSelectedChanged!=null&&!cube.isObservable(a.onSelectedChanged))a.onSelectedChanged(b,d);if(a.isEnabledAccordion())a.setExpandedById(b.id);else if(a.type()=="menu"){var e=cube.isObservable(b.childNodes)?b.childNodes():
b.childNodes;if(cube.notEmpty(a.url())&&c&&(cube.isEmpty(e)||e.length==0))a.isNodeShowLoading(!0),f.onload=null,f.load(b,function(c){b.childNodes(c.nodes);a.isNodeShowLoading(!1)});b.expanded(!b.expanded());if(a.onToggleExpand!=null&&!cube.isObservable(a.onToggleExpand))a.onToggleExpand(b,d,b.expanded())}};a.removeSelectNode=function(){var b=a.selectedNode();if(b){var d=null;if(a.onRemoveSelected!=null&&!cube.isObservable(a.onRemoveSelected))d=a.onRemoveSelected;f.remove(b,d)}};a.removeCheckedNode=
function(){var b=a.checkedNode();if(b&&b.length>0)if(cube.notEmpty(a.url()))f.remove(b);else for(var d=0;d<b.length;d++)f.remove(b[d])};a.appendNode=function(b,d,c){var e=f.create(b,d),g=e[a.primaryKey()];if(typeof c!="undefined"&&c==!0)f.save(function(b){var c=null,c=b&&b.resultValue&&b.resultValue.items.length>0?b.resultValue.items[0]:e;f.data()["#"+g][a.primaryKey()]=c[a.primaryKey()];if(a.onNodeSaved!=null&&!cube.isObservable(a.onNodeSaved))a.onNodeSaved(c)});else return e};a.setSelectedNodeById=
function(b){a.selectedNodeId(b);a.setExpandedById(b)};a.setCheckedNodeById=function(b){for(var d=a.nodes(),c=0;c<b.length;c++){var e=d["#"+b[c]];cube.notEmpty(e)&&a.checkedNode().indexOf(e)==-1&&(e.checked(!0),a.checkedNode.push(e),a.checkedNodeId.push(String(b[c])),a.checkCascade()&&a.checkCascadeNodes(e,!0))}};a.setExpandedById=function(b){var d=a.nodes();a.selectedNode(d["#"+b]);var c=null;(b=d["#"+b])&&(c=d["#"+b.parentId]);a.isEnabledAccordion()&&a.treeExpanded(d);if(c)for(;c;)c.expanded(!0),
c=d["#"+c.parentId]};a.dblClickNode=function(b,d){var b=b||this,d=cube.isNumber(d)?d:a.level(),c=cube.isObservable(b.hasChildren)?b.hasChildren():b.hasChildren;if(!a.onlyCheckLeafNode()||!c)if(a.selectedNode(b),a.selectedNodeId(b.id),a.onDblClickTreeNode!=null&&!cube.isObservable(a.onDblClickTreeNode))a.onDblClickTreeNode(b,d);var e=cube.isObservable(b.childNodes)?b.childNodes():b.childNodes;if(cube.notEmpty(a.url())&&c&&(cube.isEmpty(e)||e.length==0))a.isNodeShowLoading(!0),f.onload=null,f.load(b,
function(c){b.childNodes(c.nodes);a.isNodeShowLoading(!1);a.checkCascade()&&a.checkedNode().indexOf(b)!=-1&&a.checkChildNodes(b,!0)});b.expanded(!b.expanded());if(a.onToggleExpand!=null&&!cube.isObservable(a.onToggleExpand))a.onToggleExpand(b,d,b.expanded())};a.ctxMenuItemChanged=function(b){var d=a.selectedNode();if(a.onCtxMenuItemChanged!=null&&!cube.isObservable(a.onCtxMenuItemChanged))a.onCtxMenuItemChanged(b,d);else b.route=="#edit"?(a.editItem(d),a.ctxMenuEdit(!0)):b.route=="#add"?(b=a.appendNode({text:""},
{parentId:d.id,order:!1},!1),a.editItem(b),a.ctxMenuEdit(!0)):b.route=="#delete"&&cube.indicate("confirm",cube.msg("CONFIRM_DELETE"),function(){if(f.checkSaved(d[a.primaryKey()]))a.removeSelectNode();else{var b=a.nodes(),e=b["#"+d.parentId];e&&cube.isObservable(e.childNodes)&&(e.childNodes.remove(d),delete b["#"+d[a.primaryKey()]])}})};a.ctxtmenu=function(b,d){if(a.isEnabledContextMenu()){a.selectedNode(b);var c=a.contextMenuItems(),e=a.addLevel();e>0&&b.level>e&&(c=cube.clone(c),c.splice(1,1));cube.showContextmenu(d,
{contextMenuItems:c,onSelectItemChanged:a.ctxMenuItemChanged})}};a.treeExpanded=function(b){var b=a.nodes(),d=b["#"+a.selectedNodeId()],c=null,e=[];d&&(c=b["#"+d.parentId]);if(c)for(;c;)e.push(String(c.id)),c=b["#"+c.parentId];for(var f in b)f.indexOf("#")==0&&(b[f]==d||e.indexOf(String(b[f].id))!=-1?b[f].expanded(!0):b[f].expanded(!1))};var j=null;a.editItem=function(b){if(typeof b.text!="undefined"&&!cube.isObservable(b.text))b.text=cube.obj(b.text);j=b.text();a._editedItem(b)};a.saveItem=function(){var b=
cube.clone(a._editedItem());if(typeof b.text!="undefined"&&cube.isObservable(b.text))b.text=b.text();f.setValue(b,a.textColName(),b.text);var d=!0,c={node:b,cancel:!1,params:null};a.onNodeSaving!=null&&!cube.isObservable(a.onNodeSaving)&&(d=a.onNodeSaving(c));if(!(d===!1||c.cancel)){if(cube.notEmpty(c.params)&&cube.isObject(c.params))for(var e in c.params)f.setValue(b,e,c.params[e]);f.save({parentID:b.parentId},function(c){var d=null,d=c&&c.resultValue&&c.resultValue.items&&c.resultValue.items.length>
0?c.resultValue.items[0]:b;if(a.onNodeSaved!=null&&!cube.isObservable(a.onNodeSaved))a.onNodeSaved(d);a._editedItem(null)})}};a.cancelSaveItem=function(){a._editedItem().text(j);a._editedItem(null);j=null};a.showEdit=function(b){a._showeditedItem(b)};a.hideEdit=function(){a._showeditedItem(null)};a.getEnable=function(b){if(a.onlyCheckLeafNode()&&b.hasChildren())return!1;var d=a.readOnlyCondition();if(!cube.isEmpty(d))if(cube.isArray(d))for(var c=0;c<d.length;c++)if(cube.isNumber(d[c])){if(b.level==
d[c])return!1}else{if(b.itemType==d[c])return!1}else if(cube.isNumber(d)){if(b.level==d)return!1}else if(b.itemType==d)return!1;return!0};a.save=function(b){var d=[];a.isShowCheckbox()?d=a.checkedNodeId():d.push(a.selectedNodeId());f.save({items:d},!0,b)};a.load=function(b){a.isShowLoading(!0);var d=a.args();cube.notEmpty(b)&&(d=cube.isEmpty(d)?b:$.extend(d,b));f.onload=k;f.data=a.nodes;f.init();f.load(d)};cube.endViewModel(a,i)}cube.importComponent("datacontainer.treenodetmpl");cube.importComponent("editor.commoneditor");
cube.importComponent("controls.loading");i.prototype.dispose=function(){this.checkedNodeSub.dispose();this.selectedNodeIdSub.dispose();this.checkNodeIdSub.dispose();this.keywordSub.dispose();this.urlSub.dispose()};return i});