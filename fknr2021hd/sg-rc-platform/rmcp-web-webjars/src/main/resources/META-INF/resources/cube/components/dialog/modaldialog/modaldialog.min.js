define([],function(){function l(l){function n(){a.isShowDialog(!1);a.eleId()!=null&&window.setTimeout(function(){$("#"+a.eleId()).remove();$(".cube.modal.fade.in:last").focus()},310)}function q(b){b==!0?(a.animatShowBck(b),window.setTimeout(function(){a.animatShowDialog(b)},150)):(window.setTimeout(function(){a.animatShowBck(b)},310),window.setTimeout(function(){a.animatShowDialog(b)},10))}function u(b){$.ajax({url:b,crossDomain:cube.crosDomain(b),success:function(b){a.ajaxHtml(b)}})}var a=this;a.width=
null;a.height=null;a.top=null;a.bottom=null;a.isWidthHeightAuto=!1;a.footerHeight="auto";a.isMax=!1;a.isMin=!1;a.title="";a.content=null;a.templateOptions=null;a.isOut=!1;a.ajaxHtml="";a.result=null;a.isShowDialog=!1;a.isShowCloseBtn=!0;a.isShowMinBtn=!0;a.isShowMaxBtn=!0;a.closeBtnText=cube.msg("CLOSE");a.isShowConfirmBtn=!0;a.confirmBtnText=cube.msg("CONFIRM");a.submitFormOnConfirm=!1;a.customBtns=[];a.reverseBtn=!1;a.onConfirmBtnClick=null;a.onCloseBtnClick=null;a.onRendered=null;a.animatShowBck=
!1;a.animatShowDialog=!1;a.eleId=null;a.zIndex=1050;a._footerHeight=null;a.$e=null;a.isdrag=!1;a.tx=0;a.ty=0;a.bodyHeight=0;a.ismedDialog=!0;var e=null,r=null,s=null;a._init=function(){a.isdrag=!1;var b=a.templateOptions();cube.notEmpty(b)&&cube.notEmpty(b.name)&&b.name.indexOf("http")==0&&b.type!="viewModel"&&a.isOut(!0);q(a.isShowDialog());a.isShowDialogSub=cube.subscribe(a.isShowDialog,q);if(b!=null){if(typeof b.params=="undefined")b.params={};b.params.dialog=this;if(a.isOut()){if(cube.isEmpty(b.type))b.type=
"ajax";if("ajax"==b.type)u(b.name);else if("iframe"==b.type)b.params.dialog={},b.name+=(b.name.indexOf("?")>0?"&":"?")+"params="+JSON.stringify(b.params)}}};a.headmousedown=function(b,c){var d=a.$e.find(".modal").width(),f=a.$e.find(".modal").height();s=document.documentElement.clientHeight-30;r=document.documentElement.clientWidth-10;if(a.ismedDialog()){a.isdrag=!0;$(document).unbind("mousemove").bind("mousemove",a.headmousemove);a.tx=c.clientX;a.ty=c.clientY;e=c.currentTarget?c.currentTarget:c.srcElement;
e=e.parentNode;e.style.top=$(e).position().top+"px";if(cube.isEmpty(e.style.left))e.style.left="0px";e.style.width=d+"px";e.style.height=f+"px";e.style.bottom="";e.style.right=""}};a.headmousemove=function(b){if(a.isdrag&&a.ismedDialog()){var c=b.clientX-a.tx,d=b.clientY-a.ty,f=e.style.top,g=e.style.left,f=parseInt(f.substr(0,f.indexOf("px"))),g=parseInt(g.substr(0,g.indexOf("px"))),d=f+d,c=g+2*c;if(d<s&&d>0&&c<r)e.style.top=d+"px",e.style.left=c+"px";a.tx=b.clientX;a.ty=b.clientY}};a.headmouseup=
function(){a.isdrag=!1;$(document).unbind("mousemove",a.headmousemove)};window.onmouseup=document.onmouseup=function(){a.isdrag=!1};a.mouseout=function(a,c){for(var d=c.relatedTarget?c.relatedTarget:c.toElement;d&&d!=a;)d=d.parentNode};a.closeDialog=function(){if(a.onCloseBtnClick!=null&&!cube.isObservable(a.onCloseBtnClick))if(a.isOut()&&"iframe"==a.templateOptions().type)a._getCrosResult("close");else{var b=null;cube.notEmpty(a.result)&&(b=cube.isFunction(a.result)?a.result():a.result);b={cancel:!1,
result:b};a.onCloseBtnClick(b);if(b.cancel)return!1}n()};var o=0,p=0,j=0,k=0;a.maxDialog=function(){a.ismedDialog(!1);!a.isMax()&&!a.isMin()&&(o=a.top(),p=a.bottom(),a.isWidthHeightAuto()?(j=a.$e.find(".modal").width()+"px",k=a.$e.find(".modal").height()+"px"):(j=a.width(),k=a.height()));a.isMax(!0);a.isMin(!1);a.top("0px");a.bottom("0px");a.$e.find(".modal").css("left","0px");a.width("100%");a.height("100%")};a.minDialog=function(){a.ismedDialog(!1);!a.isMax()&&!a.isMin()&&(o=a.top(),p=a.bottom(),
a.isWidthHeightAuto()?(j=a.$e.find(".modal").width()+"px",k=a.$e.find(".modal").height()+"px"):(j=a.width(),k=a.height()));a.isMin(!0);a.isMax(!1);a.top("");a.bottom("0px");a.$e.find(".modal").css("left","0px");a.width("300px");a.height("50px")};a.normalDialog=function(){a.ismedDialog(!0);a.isMin(!1);a.isMax(!1);a.top(o);a.bottom(p);a.width(j);a.height(k)};a.confirmDialog=function(){if(a.onConfirmBtnClick!==null&&!cube.isObservable(a.onConfirmBtnClick))if(a.isOut()&&"iframe"==a.templateOptions().type)a._getCrosResult("confirm");
else{var b=null;cube.notEmpty(a.result)&&(b=cube.isFunction(a.result)?a.result():a.result);b={cancel:!1,result:b};a.onConfirmBtnClick(b);if(b.cancel)return!1}if(a.submitFormOnConfirm()){if(a.$e!==null&&(b=a.$e.find("dataform"))&&b.length>0)for(var c=0;c<b.length;c++){var d=cube.getPageViewModelByNode(b.eq(c));if(d&&d.submitForm){if(d.onSaved==null||cube.isObservable(d.onSaved))d.onSaved=function(){cube.indicate(cube.msg("SAVE_SUCCESS"));n()};d.submitForm()}}}else n()};a._getCrosResult=function(b){var c=
function(c){c=c.data;c=JSON.parse(c);c={cancel:!1,result:c};if(b=="close")a.onCloseBtnClick(c);else a.onConfirmBtnClick(c);if(c.cancel)return!1};window.addEventListener?window.addEventListener("message",c,!1):window.attachEvent("onmessage",c);document.iframe_dialog&&document.iframe_dialog.postMessage('{"__result__": true}',"*")};a.customClick=function(b){cube.notEmpty(b.click)&&typeof b.click=="function"&&b.click(a)};var t=0,m=0;a._resize=function(b,c,d,f,g){d=d+f+a._footerHeight()+g;t=="0"&&(m=c.outerHeight(),
t++);a.height()=="auto"&&a.isWidthHeightAuto()&&(m=a.$e.find(".modal-body").outerHeight());b=="a"&&(rationalHeight=parseInt($(window).height()*0.8-d));b=="b"&&(rationalHeight=parseInt($(window).height()*0.9-parseInt(a.bottom().replace("px",""))-d));b=="c"&&(rationalHeight=parseInt($(window).height()*0.9-parseInt(a.top().replace("px",""))-d));b=="d"&&(rationalHeight=parseInt($(window).height()-parseInt(a.top().replace("px",""))-parseInt(a.bottom().replace("px",""))-d));if(a.isWidthHeightAuto()||b==
"d")m>rationalHeight&&!a.isMax()&&!a.isMin()?(rationalHeight<0?a.bodyHeight("0px"):a.bodyHeight(rationalHeight+"px"),(b=="a"||b=="c")&&a.bottom(parseInt($(window).height()*0.1)+"px"),b=="b"&&a.top(parseInt($(window).height()*0.1)+"px")):m<=rationalHeight?(b=="b"&&a.top("auto"),a.bodyHeight("auto")):(b=="b"&&a.top("auto"),b=="d"&&(rationalHeight<0?a.bodyHeight("0px"):a.bodyHeight(rationalHeight+"px")))};a._tabindexKeydown=function(b){var b=b.which||b.keyCode,c=$(document.activeElement);b==27&&a.closeDialog();
b==13&&!c.is("input")&&!c.is("textarea")&&a.confirmDialog()};a.onload=function(b){a.$e=$(b);a.$e.children(".modal").attr("tabindex",1).keydown(a._tabindexKeydown);a.$e.children(".modal-backdrop").attr("tabindex",1).keydown(a._tabindexKeydown);a.$e.children(".modal").focus();var c=document;if(window.name&&window.name.indexOf("iframe_")==0)try{if(top.document&&top.cube)c=top.document}catch(d){}var c=c.documentElement.clientHeight,f=a.$e.find(".modal-header").outerHeight(),g=a.$e.find(".modal-footer").outerHeight(),
e=a.$e.find(".modal-body"),h=a.$e.find(".modal-body").outerHeight(),i=parseInt(c-f-g-a._footerHeight())/2+"px";!a.isShowCloseBtn()&&!a.isShowConfirmBtn()&&a.customBtns()==[]&&a.footerHeight()=="auto"?a._footerHeight(g):a._footerHeight(0);cube.isEmpty(a.top())?cube.isEmpty(a.height())?(a.isWidthHeightAuto()?a.height("auto"):a.height("480px"),cube.isEmpty(a.bottom())?($(window).resize(function(){var b=$(this);a._resize("a",b,f,g,h)}),e.resize(function(){var b=$(this);a._resize("a",b,f,g,h)})):(parseInt(a.bottom().replace("px",
""))>c?(a.bottom(i),a.top(i)):parseInt(a.bottom().replace("px",""))+parseInt(a.height().replace("px",""))>c&&a.bottom("auto"),$(window).resize(function(){var b=$(this);a._resize("b",b,f,g,h)}),e.resize(function(){var b=$(this);a._resize("b",b,f,g,h)}))):cube.isEmpty(a.bottom())?(a.top(parseInt(c-parseInt(a.height().replace("px","")))/2+"px"),a.bottom(parseInt(c-parseInt(a.top().replace("px",""))-parseInt(a.height().replace("px","")))+"px")):(parseInt(a.bottom().replace("px",""))>c?(a.bottom(i),a.top(i)):
parseInt(a.bottom().replace("px",""))+parseInt(a.height().replace("px",""))>c&&a.bottom("auto"),a.top(parseInt(c-parseInt(a.bottom().replace("px",""))-parseInt(a.height().replace("px","")))+"px")):(parseInt(a.top().replace("px",""))>c&&a.top(i),cube.isEmpty(a.bottom())?cube.isEmpty(a.height())?(a.isWidthHeightAuto()?a.height("auto"):a.height("480px"),$(window).resize(function(){var b=$(this);a._resize("c",b,f,g,h)}),e.resize(function(){var b=$(this);a._resize("c",b,f,g,h)})):(a.height(a.height()),
a.top(a.top()),a.bottom(parseInt(c)-parseInt(a.top().replace("px",""))-parseInt(a.height().replace("px",""))+"px")):(cube.isEmpty(a.height())?(a.height(c-parseInt(a.top().replace("px",""))-parseInt(a.bottom().replace("px",""))),$(window).resize(function(){var b=$(this);a._resize("d",b,f,g,h)})):(a.height(a.height()),a.bottom(a.bottom()),a.top(a.top())),parseInt(a.top().replace("px",""))+parseInt(a.bottom().replace("px",""))>c&&(a.bodyHeight("0px"),a.top(i),a.bottom(i))));cube.isEmpty(a.width())?a.isWidthHeightAuto()?
a.width("auto"):a.width("640px"):a.width(a.width());c=parseInt(a.height())-f-g-a._footerHeight()-h;isNaN(c)||(c<0&&!a.isWidthHeightAuto()?a.bodyHeight("0px"):a.bodyHeight(c+"px"));if(a.onRendered!=null&&!cube.isObservable(a.onRendered))a.onRendered(b)};cube.endViewModel(a,l)}l.prototype.dispose=function(){this.isShowDialogSub.dispose()};return l});