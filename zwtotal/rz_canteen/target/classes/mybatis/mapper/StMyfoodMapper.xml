<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.canteen.mapper.StMyfoodMapper">
    <resultMap id="RestaurantResultMap" type="java.util.Map">
        <id column="id"  property="id" />
        <result property="name" column="name"/>
        <result property="category" column="category"/>
        <result property="referenceprice" column="referenceprice"/>
        <result property="weight" column="weight"/>
        <result property="energy" column="energy"/>
        <result property="remarks" column="remarks"/>
        <result property="dishcode" column="dishcode"/>
    </resultMap>

    <resultMap id="FoodManageResultMap" type="java.util.Map">
        <id column="dishName"  property="dishName" />
        <result property="referenceprice" column="referenceprice"/>
        <result property="dishcategory" column="dishcategory"/>
        <result property="dishcode" column="dishcode"/>
        <result property="weight" column="weight"/>
        <result property="energy" column="energy"/>
        <result property="remarks" column="remarks"/>
        <result property="company" column="company"/>
    </resultMap>


    <resultMap id="ResultMap" type="HashMap">
        <result column="energy" jdbcType="VARCHAR" property="energy" />
        <result property="protein" column="protein"/>
        <result property="fat" column="fat"/>
        <result property="saturated" column="saturated"/>
        <result property="cholesterol" column="cholesterol"/>
        <result property="carbohydrate" column="carbohydrate"/>
        <result property="dietaryfiber" column="dietaryfiber"/>
        <result property="vitaminA" column="vitaminA"/>
        <result property="vitaminD" column="vitaminD"/>
        <result property="vitaminE" column="vitaminE"/>
        <result property="vitaminK" column="vitaminK"/>
        <result property="vitaminB1" column="vitaminB1"/>
        <result property="vitaminB2" column="vitaminB2"/>
        <result property="vitaminB6" column="vitaminB6"/>
        <result property="vitamin16" column="vitamin16"/>
        <result property="vitaminC" column="vitaminC"/>
        <result property="nicotinicacid" column="nicotinicacid"/>
        <result property="folicacid" column="folicacid"/>
        <result property="pantothenicacid" column="pantothenicacid"/>
        <result property="biotin" column="biotin"/>
        <result property="choline" column="choline"/>
        <result property="phosphorus" column="phosphorus"/>
        <result property="potassium" column="potassium"/>
        <result property="sodium" column="sodium"/>
        <result property="magnesium" column="magnesium"/>
        <result property="iron" column="iron"/>
        <result property="zinc" column="zinc"/>
        <result property="iodine" column="iodine"/>
        <result property="selenium" column="selenium"/>
        <result property="copper" column="copper"/>
        <result property="fluorine" column="fluorine"/>
        <result property="chromium" column="chromium"/>
        <result property="manganese" column="manganese"/>
        <result property="molybdenum" column="molybdenum"/>
        <result column="code" jdbcType="VARCHAR" property="code" />
    </resultMap>

<!--  获取菜品数量-->
    <select id="getTotalSize" resultType="java.lang.Integer">
       SELECT COUNT(id) FROM st_mydishes
  <where>
    <if test="restaurant != null and restaurant != ''">
        and restaurant = #{restaurant}
    </if>
      <if test="name != null and name != ''">
          and name like #{name}
      </if>
      <if test="category != null and category != ''">
          and category = #{category}
      </if>
  </where>
    </select>
<!--获取不同运维餐厅下所有的菜品列表-->
<select id="selectByRestaurant" resultMap="RestaurantResultMap">
    SELECT s.id, s.name,s.category,s.referenceprice,s.weight,s.energy,s.remarks,s.dishcode
    FROM (SELECT * FROM st_mydishes) s
     LEFT JOIN (SELECT * FROM st_operationrestaurant) b
     ON s.restaurant = b.RestaurantCode
    <where>
    <if test="restaurant != null and restaurant != ''">
    and s.restaurant = #{restaurant}
     </if>
    <if test="name != null and name != ''">
        and s.name like #{name}
    </if>
    <if test="category != null and category != ''">
        and s.category = #{category}
    </if>
    </where>
    limit #{startIndex},#{pageSize}
 </select>

<!--    在全量库中根据菜品名字查询菜品信息-->
    <select id="selectNameByFoodManage" resultType="java.util.Map">
        SELECT
        s.dishcode, s.dishName AS name,s.dishcategory AS category,s.referenceprice,s.energy,
        s.remarks,s.company restaurant,s.meals,s.dishescategory,s.weight
        FROM st_food_management s
       <where>
           <if test="name != null and name != ''">
               and s.dishName like "%"#{name}"%"
           </if>
           <if test="category != null and category != ''">
               and s.dishcategory = #{category}
           </if>
       </where>
        limit #{startIndex},#{pageSize}
    </select>

    <select id="getTotal" resultType="java.lang.Integer">
        SELECT
       count(s.dishcode)
        FROM st_food_management s
        <where>
            <if test="name != null and name != ''">
                and s.dishName like "%"#{name}"%"
            </if>
            <if test="category != null and category != ''">
                and s.dishcategory = #{category}
            </if>
        </where>
    </select>

    <!--    菜品营养分析-->
    <select id="CalculationNutritional" resultType="java.util.Map">
         SELECT *
     FROM st_nutritional_components s
       WHERE s.code = #{dishcode}
    </select>

<!--    根据菜品id删除菜品-->
    <delete id="deleteMyFoodById">
        DELETE FROM st_mydishes
        WHERE id = #{id}
    </delete>
<!--根据id查询全量库中菜品-->
    <select id="selectManageFood" resultType="com.canteen.entity.StMydishes">
        SELECT
        s.dishName AS name,s.dishcategory AS category,s.referenceprice,s.energy,s.dishcode,
        s.remarks,s.meals,s.dishescategory,s.weight,s.foodpictures
        FROM st_food_management s
       where s.dishcode = #{id}
    </select>

<!--    根据dishcode查询我的菜品表有无这个菜品-->
    <select id="selectDishcode" resultType="java.lang.String">
        select dishcode
        from
        st_mydishes
        where
        dishcode = #{id}
        and
        restaurant = #{restaurant}
    </select>
<!--    添加菜品-->
    <insert id="insertMyFood" parameterType="com.canteen.entity.StMydishes">
        INSERT INTO st_mydishes (name,category,referenceprice,weight,energy,remarks,
        restaurant,dishescategory,meals,foodpictures,dishcode)
        VALUES (#{name},#{category},#{referenceprice},#{weight},#{energy},
        #{remarks},#{restaurant},#{dishescategory},#{meals},#{foodpictures},#{dishcode})
    </insert>

<!--菜类查询-->
    <select id="selectdish" resultType="java.util.Map">
   SELECT parakey,paravalue FROM sys_parameter
    WHERE paraname = "CANTEEN_MATERIALTYPE"
    </select>
    
    <!--===============================================查询菜品==============================================-->
    <!--查询菜品-->
    <select id="selectDish" resultType="java.util.LinkedHashMap">
        SELECT
            a.id,
            b.name,
            b.dishcode,
            b.category,
            d.paravalue dishescategory,
            b.referenceprice,
            DATE_FORMAT(a.timestamp,'%Y-%m-%d') timestamp,
            b.foodpictures
        FROM
            ( SELECT * FROM st_intelligencemeals ) a
            LEFT JOIN ( SELECT * FROM st_mydishes ) b ON a.varietydishes = b.id
            LEFT JOIN ( SELECT * FROM sys_parameter WHERE paraname = 'CANTEEN_MATERIALTYPE' ) c ON c.parakey = b.category
            LEFT JOIN ( SELECT * FROM sys_parameter WHERE paraname = 'dishescategory' ) d ON d.parakey = b.dishescategory
            LEFT JOIN st_operationrestaurant e ON b.restaurant = e.RestaurantCode
        WHERE
            ( a.del_flag = '0' or a.del_flag is null )
            <if test="restaurantName != null and restaurantName != ''">
                and e.id in (${restaurantName})
            </if>
            <if test="name != null and name != ''">
                <bind name="Name" value="'%' + name + '%'"/>
                and b.name like #{Name}
            </if>
            <if test="category != null and category != ''">
                <bind name="Category" value="'%' + category + '%'"/>
                and b.category like #{category}
            </if>
            <if test="dishesCategory != null and dishesCategory != ''">
                and b.dishescategory = #{dishesCategory}
            </if>
            <if test="time != null and time != ''">
                and a.timestamp = #{time}
            </if>
            <if test="meals != null and meals != ''">
                and b.meals = #{meals}
            </if>
            limit #{index},#{pageSize}
    </select>

    <!--查询菜品数量-->
    <select id="selectDishCnt" resultType="java.lang.Integer">
        SELECT
            count(1)
        FROM
            ( SELECT * FROM st_intelligencemeals ) a
            LEFT JOIN ( SELECT * FROM st_mydishes ) b ON a.varietydishes = b.id
            LEFT JOIN st_operationrestaurant e ON b.restaurant = e.RestaurantCode
        WHERE
            ( a.del_flag = '0' or a.del_flag is null )
            <if test="restaurantName != null and restaurantName != ''">
                and e.id in (${restaurantName})
            </if>
            <if test="name != null and name != ''">
                <bind name="Name" value="'%' + name + '%'"/>
                and b.name like #{Name}
            </if>
            <if test="category != null and category != ''">
                <bind name="Category" value="'%' + category + '%'"/>
                and b.category like #{Category}
            </if>
            <if test="dishesCategory != null and dishesCategory != ''">
                and b.dishescategory = #{dishesCategory}
            </if>
            <if test="time != null and time != ''">
                and a.timestamp = #{time}
            </if>
            <if test="meals != null and meals != ''">
                and b.meals = #{meals}
            </if>
    </select>
</mapper>