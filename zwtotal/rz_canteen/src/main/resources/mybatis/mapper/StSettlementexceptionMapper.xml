<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.canteen.mapper.StSettlementexceptionMapper">

    <resultMap id="exceptionResultMap" type="com.canteen.entity.StSettlementexception">
        <result property="id" column="id"/>
        <result property="restaurant" column="restaurant"/>
        <result property="cardNumber" column="cardnumber"/>
        <result property="varietyDishes" column="varietydishes"/>
        <result property="amountMoney" column="amountmoney"/>
        <result property="abnormalCause" column="abnormalcause"/>
        <result property="mealTime" column="mealtime"/>
        <result property="mealType" column="mealtype"/>
    </resultMap>

    <resultMap id="dictionariesMap" type="java.util.LinkedHashMap">
        <result column="paratype" jdbcType="VARCHAR" property="paratype" />
        <result column="paraname" jdbcType="VARCHAR" property="paraname" />
        <result column="parakey" jdbcType="VARCHAR" property="parakey" />
        <result column="paravalue" jdbcType="VARCHAR" property="paravalue" />
    </resultMap>

    <!--查询异常列表-->
    <select id="getExceptionList" resultMap="exceptionResultMap">
        SELECT
            a.id,
            b.RestaurantName restaurant,
            a.cardnumber,
            c.dishName varietydishes,
            a.amountmoney,
            d.paravalue abnormalcause,
            DATE_FORMAT( a.mealtime, '%Y/%m/%d' ) mealtime,
            e.paravalue mealtype
        FROM
            ( SELECT * FROM st_settlementexception ) a
            LEFT JOIN ( SELECT * FROM st_operationrestaurant ) b ON a.restaurant = b.RestaurantCode
            LEFT JOIN ( SELECT * FROM st_food_management ) c ON a.varietydishes = c.dishcode
            LEFT JOIN ( SELECT * FROM sys_parameter WHERE paraname = 'abnormalcause' ) d ON a.abnormalcause = d.parakey
            LEFT JOIN ( SELECT * FROM sys_parameter WHERE paraname = 'mealtype' ) e ON a.mealtype = e.parakey
        WHERE
            1 = 1
            <if test="restaurantName != null and restaurantName != ''">
                AND b.id in(${restaurantName})
            </if>
            <if test="mealtype != null and mealtype != ''">
                AND a.mealtype = #{mealtype}
            </if>
            <if test="startTime != null and startTime != '' and  endTime != null and endTime != ''">
                AND a.mealtime BETWEEN STR_TO_DATE( #{startTime}, '%Y-%m-%d' ) and STR_TO_DATE( #{endTime}, '%Y-%m-%d' )
            </if>
            limit #{startIndex},#{pageSize}
    </select>

    <!--查询异常数量-->
    <select id="getExceptionCnt" resultType="java.lang.Integer">
        SELECT
            count(1)
        FROM
            ( SELECT * FROM st_settlementexception ) a
            LEFT JOIN ( SELECT * FROM st_operationrestaurant ) b ON a.restaurant = b.RestaurantCode
        WHERE
            1 = 1
            <if test="restaurantName != null and restaurantName != ''">
                AND b.id in(${restaurantName})
            </if>
            <if test="mealtype != null and mealtype != ''">
                AND a.mealtype = #{mealtype}
            </if>
            <if test="startTime != null and startTime != '' and  endTime != null and endTime != ''">
                AND a.mealtime BETWEEN STR_TO_DATE( #{startTime}, '%Y-%m-%d' ) and STR_TO_DATE( #{endTime}, '%Y-%m-%d' )
            </if>
    </select>

    <!--查询字典表定义-->
    <select id="dictionaries" resultMap="dictionariesMap">
        SELECT * FROM sys_parameter
    </select>
</mapper>